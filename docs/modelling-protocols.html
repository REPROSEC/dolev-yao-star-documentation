<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modelling Protocols in DY* &mdash; Security Analysis of Cryptographic Protocols with DY*  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/contentui.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/remember.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/example.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/exercise.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/infobox.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/box.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/todo.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/math.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/contentui.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Stating Security Properties" href="stating-sec-props.html" />
    <link rel="prev" title="Introduction" href="introduction.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Security Analysis of Cryptographic Protocols with DY*
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#example-protocols">Example Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#main-concepts-in-dy">Main Concepts in DY*</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Modelling Protocols in DY*</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#wire-format-and-abstract-formats-for-messages-and-sessions">Wire-format and Abstract Formats for Messages and Sessions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#abstract-formats-for-messages">Abstract Formats for Messages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#abstract-formats-for-states">Abstract Formats for States</a></li>
<li class="toctree-l3"><a class="reference internal" href="#translating-between-abstract-and-wire-format">Translating between Abstract and Wire-Format</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#the-traceful-and-option-monads">The <code class="docutils literal notranslate"><span class="pre">traceful</span></code> and <code class="docutils literal notranslate"><span class="pre">option</span></code> Monads</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-traceful-monad">The <code class="docutils literal notranslate"><span class="pre">traceful</span></code> Monad</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sequential-composition-of-traceful-functions">Sequential composition of traceful functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#accessing-return-values-of-traceful-functions">Accessing return values of traceful functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#returning-a-value-inside-a-traceful-function">Returning a value inside a traceful function</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-option-monad">The <code class="docutils literal notranslate"><span class="pre">option</span></code> Monad</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-traceful-option-monad">The <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> Monad</a></li>
<li class="toctree-l3"><a class="reference internal" href="#comparing-traceful-option-with-traceful">Comparing <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> with <code class="docutils literal notranslate"><span class="pre">traceful</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#combining-actions-from-different-monads">Combining actions from different Monads</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-overall-type">The Overall Type</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-compose">How to Compose</a></li>
<li class="toctree-l4"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#a-model-of-the-two-message-protocol">A Model of the Two-Message Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-abstract-message-and-state-types">The abstract message and state types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#messages">Messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#states">States</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-protocol-steps">The protocol steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-first-step-sending-a-ping">The first step: Sending a Ping</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-second-step-replying-with-an-ack">The second step: Replying with an Ack</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-third-step-receiving-an-ack">The third step: Receiving an Ack</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#an-example-protocol-run">An Example Protocol Run</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-example-run">The example run</a></li>
<li class="toctree-l4"><a class="reference internal" href="#printing-the-trace">Printing the Trace</a></li>
<li class="toctree-l4"><a class="reference internal" href="#executing-the-run">Executing the Run</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pretty-printing">Pretty Printing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-modelling-a-protocol-in-dy">How To: Modelling a Protocol in DY*</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-model-of-the-online-protocol">A Model of the Online? Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#public-key-encryption-in-dy">Public Key Encryption in DY*</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#key-storage">Key storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#encryption">Encryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#decryption">Decryption</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id12">Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-data-module">The <code class="docutils literal notranslate"><span class="pre">Data</span></code> module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id13">The abstract message and state types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparation-for-public-key-encryption">Preparation for Public Key Encryption</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id17">The protocol steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sending-a-ping">Sending a Ping</a></li>
<li class="toctree-l4"><a class="reference internal" href="#replying-with-an-ack">Replying with an Ack</a></li>
<li class="toctree-l4"><a class="reference internal" href="#receiving-an-ack">Receiving an Ack</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id19">An example protocol run</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-run-module">The <code class="docutils literal notranslate"><span class="pre">Run</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setup-of-key-storage">Setup of Key Storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-setup-key-storage">How-To: Setup Key Storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-actual-protocol-run">The actual protocol run</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#a-first-implementation-of-nsl">A First Implementation of NSL</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="stating-sec-props.html">Stating Security Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="proof-method.html">Proving Security Properties</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Security Analysis of Cryptographic Protocols with DY*</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Modelling Protocols in DY*</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/modelling-protocols.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="modelling-protocols-in-dy">
<span id="sec-modelling"></span><h1>Modelling Protocols in DY*<a class="headerlink" href="#modelling-protocols-in-dy" title="Link to this heading"></a></h1>
<p>In this section,
we will start to implement the models of our simple example protocols in DY*.
But first, we need to look at two more concepts,</p>
<section id="wire-format-and-abstract-formats-for-messages-and-sessions">
<h2>Wire-format and Abstract Formats for Messages and Sessions<a class="headerlink" href="#wire-format-and-abstract-formats-for-messages-and-sessions" title="Link to this heading"></a></h2>
<p><span class="todo-inline">TODO: should this concept move to the concepts section? (without code records)</span></p>
<p>On the lowest level of a real network,
messages are sent in a wire-format
which can be thought of as a byte-stream without any structure.
But the different network layers interpret this stream
and give it some structure to make processing on higher layers easier.
For example a UDP message contains
some header that has several fields with meta-information followed by the actual
content of the message.
Further, the higher layers don’t really care about or even need to
know how their message is encoded on the lower layers.
They just work with the content they need.</p>
<p>In DY* we use the same idea:
The content of entries on the trace are stored in the wire-format, which is called <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">bytes</span></code>.
But if we implement a protocol we don’t want to work with the wire-format,
instead we are only interested in the <em>content</em> of the messages.
We collect the different components of our messages in an <em>abstract format</em>.</p>
<section id="abstract-formats-for-messages">
<h3>Abstract Formats for Messages<a class="headerlink" href="#abstract-formats-for-messages" title="Link to this heading"></a></h3>
<div class="admonition example">
<p class="admonition-title">Example: Abstract Message Format for the Two-Message Protocol</p>
<p>The first message of the Two-Message Protocol (the Ping)
has the following abstract structure:
it consists of two entries,
one of which is the name of Alice and the other one is some nonce.</p>
<p>The second message (the Ack) contains only one entry: the nonce.</p>
</div>
<p>In our implementations, we use F*’s <a class="reference external" href="https://fstar-lang.org/tutorial/book/part1/part1_inductives.html#records">record type</a> for abstract message formats.</p>
<div class="admonition example" id="ex-abstract-messages-twomessagep">
<p class="admonition-title">Example: The records for the Abstract Format for the Two-Message Protocol</p>
<p>We define a new type for the Ping message,
collecting the two entries:</p>
<blockquote>
<div><div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">ping_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<p>The name of Alice is captured in the <code class="code docutils literal notranslate"><span class="pre">alice</span></code> component.
It is a field of type <code class="code docutils literal notranslate"><span class="pre">principal</span></code> (which is just a <code class="code docutils literal notranslate"><span class="pre">string</span></code>).</p>
<p>The nonce is caputured in the <code class="code docutils literal notranslate"><span class="pre">n_a</span></code> component.
This field is of type <code class="code docutils literal notranslate"><span class="pre">bytes</span></code>.</p>
<p>Similarly, we define a new type for the Ack message:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition example">
<p class="admonition-title">Example: Abstract Message Format for the Online? Example</p>
<p>The messages of the Online? protocol,
have the same structures as the messages for the Two-Message protocol.
We can thus use the same record types.</p>
</div>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Abstract Message Format for the Needham-Schroeder Protocol</p>
<p>Describe the abstract message format for the Needham-Schroeder protocol
and define the corresponding record types.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>The first message consists of two parts:
the name of Alice, and a nonce.
Similarly to before, we define the record:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">message1_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The second message also has two parts:
the two nonces.
We define the record:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">message2_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
  <span class="n">n_b</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The final message contains only the nonce of Bob:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">message3_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">n_b</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="abstract-formats-for-states">
<h3>Abstract Formats for States<a class="headerlink" href="#abstract-formats-for-states" title="Link to this heading"></a></h3>
<p>We do the same for states:
States are also stored on the trace in the wire-format,
however, we want to work with a more structured abstract format.</p>
<div class="admonition example">
<p class="admonition-title">Example: Abstract State Format for the Two-Message Protocol</p>
<p>In the Two-Message protocol,
we have three states
(recall from <a class="reference internal" href="introduction.html#ex-states-twomessage"><span class="std std-ref">Example: States in one run of the Two-Message Protocol</span></a>):</p>
<ul class="simple">
<li><p>The first state (SentPing) consists of two parts: the nonce <span class="math notranslate nohighlight">\(n_A\)</span> and the name of Bob.</p></li>
<li><p>The second state (SentAck) also consists of two parts: the nonce <span class="math notranslate nohighlight">\(n_A\)</span> and the name of Alice.</p></li>
<li><p>Finally, the third state (ReceivedAck) also consists of two parts: the nonce <span class="math notranslate nohighlight">\(n_A\)</span> and the name of Bob.</p></li>
</ul>
<p>This describes the abstract state format.</p>
</div>
<div class="admonition example" id="ex-abstract-state-twomessage">
<p class="admonition-title">Example: The records for the Abstract State Format for the Two-Message Protocol</p>
<p>From the abstract state format,
we define the record types:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">sent_ping_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">bob</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">sent_ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">received_ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">bob</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Abstract State Format for the Needham-Schroeder Protocol</p>
<p>Describe the abstract state format for the Needham-Schroeder protocol
and define the corresponding record types.
(Refer to <a class="reference internal" href="introduction.html#ex-states-ns"><span class="std std-ref">Exercise:States in the Needham-Schroeder Protocol</span></a> for the states.)
Consider <em>only</em> the states storing the progress of the protocol. (I.e., ignore the states for storing keys.)</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>There are 4 kinds of states for storing the protocol progress:</p>
<ul class="simple">
<li><p>The state, after Alice sent the first messge (SentMsg1):
it contains two parts: the nonce <span class="math notranslate nohighlight">\(n_A\)</span> and the name of Bob</p></li>
<li><p>The state after Bob replied with a second message (SentMsg2):
it contains three parts: the two nonces <span class="math notranslate nohighlight">\(n_A\)</span> and <span class="math notranslate nohighlight">\(n_B\)</span> and the name of Alice</p></li>
<li><p>The state after Alice receives the third message from Bob:
it contains three parts: the two nonces and the name of Bob</p></li>
<li><p>The state after Bob received the third message from Alice:
it stores the same things as the previous state of Bob:
the two nonces and the name of Alice</p></li>
</ul>
<p>We define the record types:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">sent_msg1_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">bob</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">sent_msg2_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
  <span class="n">n_b</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">sent_msg3_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">bob</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
  <span class="n">n_b</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">received_msg3_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
  <span class="n">n_b</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="translating-between-abstract-and-wire-format">
<h3>Translating between Abstract and Wire-Format<a class="headerlink" href="#translating-between-abstract-and-wire-format" title="Link to this heading"></a></h3>
<p>Once we have our abstract message and state formats,
we need to take care of transforming this abstract format to the
wire-format and vice versa.
For example, when sending a message and when receiving a message,
we need to translate from the abstract message format to the wire-format and vice versa, respectively.
Similarly, when we want to store a state on the trace,
we need to translate from the abstract state format to the wire-format.
We call the translations <em>serializing</em> (abstract to wire-format) and <em>parsing</em> (wire to abstract format).</p>
<p>We use a tool called <a class="reference external" href="https://github.com/TWal/comparse">Comparse</a> for translating between abstract and wire-format.
We will not go into the details of how Comparse works.
We just use it and explain everything necessary for that.</p>
<div class="admonition remember">
<p class="admonition-title">Remember</p>
<ul class="simple">
<li><p>Everything stored on the trace, is stored using the <em>wire-format</em> <code class="code docutils literal notranslate"><span class="pre">bytes</span></code>.</p></li>
<li><p>In a protocol model, we work with <em>abstract formats</em>
for messages and states, i.e., just the contents.</p></li>
<li><p>Translating from abstract to wire-format is called <em>serializing</em></p></li>
<li><p>Translating from wire to abstract format is called <em>parsing</em></p></li>
</ul>
</div>
</section>
</section>
<section id="the-traceful-and-option-monads">
<h2>The <code class="docutils literal notranslate"><span class="pre">traceful</span></code> and <code class="docutils literal notranslate"><span class="pre">option</span></code> Monads<a class="headerlink" href="#the-traceful-and-option-monads" title="Link to this heading"></a></h2>
<section id="the-traceful-monad">
<h3>The <code class="docutils literal notranslate"><span class="pre">traceful</span></code> Monad<a class="headerlink" href="#the-traceful-monad" title="Link to this heading"></a></h3>
<p>As we have seen previously,
the core object for capturing the overall state and for
stating and reasoning about properties of a protocol,
is the <em>global trace</em>.</p>
<p>Every protocol step is a sequence of reading entries from the current trace,
or adding new entries to the trace.
Each action in this sequence works with the new trace resulting from the previous action.</p>
<div class="admonition example">
<p class="admonition-title">Example: Explicit Trace Manipulation in the Two-Message Protocol</p>
<p>The explicit trace manipulations of the first step of the Two-Message protocol (see <a class="reference internal" href="introduction.html#example-twomessage-localview"><span class="std std-ref">Example: Local View of Two-Message Protocol</span></a>) is:</p>
<ol class="arabic simple" start="0">
<li><p>The current trace before the step begins is <code class="code docutils literal notranslate"><span class="pre">tr_in</span></code></p></li>
<li><p>Generate a nonce <span class="math notranslate nohighlight">\(n_A\)</span> and store it on the current trace <code class="code docutils literal notranslate"><span class="pre">tr_in</span></code>.
This results in the new trace <code class="code docutils literal notranslate"><span class="pre">tr_nonce</span></code>.</p></li>
<li><p>Send the first message, i.e., append the message to the current trace <code class="code docutils literal notranslate"><span class="pre">tr_nonce</span></code>.
This results in the new trace <code class="code docutils literal notranslate"><span class="pre">tr_message</span></code>.</p></li>
<li><p>Store the SentPing state, i.e., append the new state to the current trace <code class="code docutils literal notranslate"><span class="pre">tr_message</span></code>.
This results in the new trace <code class="code docutils literal notranslate"><span class="pre">tr_state</span></code>.</p></li>
</ol>
<p>The whole first step transforms the input trace <code class="code docutils literal notranslate"><span class="pre">tr_in</span></code> to the final trace <code class="code docutils literal notranslate"><span class="pre">tr_state</span></code>.</p>
</div>
<p>This explicit trace passing from one action to the next,
is rather cumbersome and we want to avoid doing that manually.
DY* offers the <code class="code docutils literal notranslate"><span class="pre">traceful</span></code> monad for <em>implicit</em> trace handling.
With this, we can just write the sequence of actions <em>without</em> having to think of the underlying traces.</p>
<p>At this point, you do <em>not</em> need to know what a monad is.
We will see everything we need to <em>use</em> the monad in the following.
The important general intuition is that monadic actions
compute some return value (just like normal functions)
but may have <em>side effects</em>.
In our case that means,
a traceful action works with the trace and may change the trace.
For example,
sending a message has the side effect,
that the message is added to the trace.</p>
<div class="admonition remember">
<p class="admonition-title">Remember: Intuition for Monads</p>
<p>Monadic actions are functions with <em>side effects</em>.</p>
<p>Specifically, a <em>traceful</em> action may look at and change the current trace.</p>
</div>
<div class="admonition infobox">
<p class="admonition-title">Info on Monads</p>
<p>If you want to understand the general concept of monads in F*, we refer to the corresponding <a class="reference external" href="https://fstar-lang.org/tutorial/book/part2/part2_par.html#a-first-model-of-computational-effects">chapter in the F* Book</a>.</p>
<div class="toggle-header docutils container">
<p><strong>If you are familiar with monads</strong></p>
</div>
<div class="toggle-content box docutils container">
<p>The <code class="code docutils literal notranslate"><span class="pre">traceful</span></code> monad
is a <em>state monad</em>, where the state is the trace
with the additional condition, that the new trace can only append entries to the old trace.
The value/result type can be anything.</p>
</div>
</div>
<p>In the previous example, we see that each step has an effect on the trace (i.e., changes the trace).
We can thus consider the steps as traceful actions.</p>
<div class="admonition example">
<p class="admonition-title">Example: Implicit Trace Manipulation in the Two-Message Protocol</p>
<p>Using the <code class="code docutils literal notranslate"><span class="pre">traceful</span></code> monad, we can write the first step of the Two Message protocol as:</p>
<ol class="arabic simple">
<li><p>Generate a new nonce <span class="math notranslate nohighlight">\(n_A\)</span> (this implicitly changes the trace)</p></li>
<li><p>Send the first message (this implicitly takes the trace after action 1 and produces a new trace)</p></li>
<li><p>Store the SentPing state (this implicitly takes the trace after action 2 and produces a new trace)</p></li>
</ol>
<p>Which is exactly our intuitive description from <a class="reference internal" href="introduction.html#example-twomessage-localview"><span class="std std-ref">Example: Local View of Two-Message Protocol</span></a>.</p>
</div>
<section id="sequential-composition-of-traceful-functions">
<h4>Sequential composition of traceful functions<a class="headerlink" href="#sequential-composition-of-traceful-functions" title="Link to this heading"></a></h4>
<p>Combining two <code class="docutils literal notranslate"><span class="pre">traceful</span></code> actions sequentially,
like steps 1., 2. and 3. in the previous example,
is done with <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code>:
<code class="code highlight fstar docutils literal highlight-fstar"><span class="n">traceful_action_1</span> <span class="o">;*</span> <span class="n">traceful_action_2</span></code>.</p>
<div class="toggle-header docutils container">
<p><strong>If you are familiar with monads</strong></p>
</div>
<div class="toggle-content box docutils container">
<p><code class="code highlight fstar docutils literal highlight-fstar"><span class="n">a</span><span class="o">;*</span> <span class="n">b</span></code> is syntactic sugar for <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">bind</span> <span class="n">a</span> <span class="o">(</span><span class="k">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">)</span></code></p>
</div>
<div class="admonition example">
<p class="admonition-title">Example: Sequential Composition of Traceful Functions</p>
<p>The following code snippet</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">send_msg</span> <span class="n">message</span> <span class="o">;*</span>
<span class="n">store_state</span> <span class="n">alice</span> <span class="n">state</span>
</pre></div>
</div>
<p>executes two traceful actions sequentially:</p>
<ol class="arabic simple">
<li><p>A message (<code class="docutils literal notranslate"><span class="pre">message</span></code>) is sent (i.e., added to the end of the current trace)</p></li>
<li><p>A new state (<code class="docutils literal notranslate"><span class="pre">state</span></code>) is stored for <code class="docutils literal notranslate"><span class="pre">alice</span></code> (i.e., the state is added to the trace after the message)</p></li>
</ol>
</div>
</section>
<section id="accessing-return-values-of-traceful-functions">
<h4>Accessing return values of traceful functions<a class="headerlink" href="#accessing-return-values-of-traceful-functions" title="Link to this heading"></a></h4>
<p>To access the computed value of a traceful action, we use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">return_value</span> <span class="o">=</span> <span class="n">traceful_action</span> <span class="k">in</span>
<span class="c">// now we can use return_value in subsequent actions</span>
</pre></div>
</div>
<div class="toggle-header docutils container">
<p><strong>If you are familiar with monads</strong></p>
</div>
<div class="toggle-content box docutils container">
<p><code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="n">a</span> <span class="k">in</span> <span class="n">b</span></code> is syntactic sugar for <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">bind</span> <span class="n">a</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">)</span></code></p>
</div>
<div class="admonition example">
<p class="admonition-title">Example: Accessing Return Values of Traceful Functions</p>
<p>With <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">gen_rand</span> <span class="k">in</span></code> we can access the nonce, returned by the traceful <code class="docutils literal notranslate"><span class="pre">gen_rand</span></code> function
and use it later on under the name <code class="docutils literal notranslate"><span class="pre">n_a</span></code>.</p>
<p><em>Note:</em> <code class="docutils literal notranslate"><span class="pre">gen_rand</span></code> as a traceful function also changes the underlying trace,
but with <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code> we are only accessing the computed <em>value</em>. The new trace is passed on implicitly as before.</p>
</div>
</section>
<section id="returning-a-value-inside-a-traceful-function">
<span id="sec-traceful-return"></span><h4>Returning a value inside a traceful function<a class="headerlink" href="#returning-a-value-inside-a-traceful-function" title="Link to this heading"></a></h4>
<p>If we compute some value inside a traceful function,
which we want to return to the caller of the function,
we use <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">value</span></code>.</p>
<div class="admonition example">
<p class="admonition-title">Example: Returning a Value inside a Traceful Function</p>
<p>Consider the example from above,
where we send a message and then store a state.
Recall, that sending a message is just adding the message to the trace.
If later, someone should receive this message,
the receiver needs to know the timestamp of the message on the trace.
Thus, the send function returns exactly this timestamp and our bigger function
needs to also return the timestamp.</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">msg_ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="n">message</span> <span class="k">in</span> <span class="c">// send the message and store the returned timestamp</span>
<span class="n">store_state</span> <span class="n">alice</span> <span class="n">state</span> <span class="o">;*</span>        <span class="c">// do some other traceful actions</span>
<span class="n">return</span> <span class="n">msg_ts</span>                     <span class="c">// return the message timestamp as final result of the traceful function</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="the-option-monad">
<h3>The <code class="docutils literal notranslate"><span class="pre">option</span></code> Monad<a class="headerlink" href="#the-option-monad" title="Link to this heading"></a></h3>
<p>Another thing, that we want to simplify is combining functions that may fail.</p>
<p>Consider as an example a function where we want to
decrypt a cipher text, and then parse the resulting plain text to some abstract message format.
Both of the steps (decryption and parsing) may fail
and we want our overall function to succeed, only if both steps succeed.</p>
<p>Luckily, there is already a builtin type in F* capturing possible failure: the <code class="docutils literal notranslate"><span class="pre">option</span></code> type.
So we can write our function as</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">match</span> <span class="n">decrypt</span> <span class="n">cipher_text</span> <span class="k">with</span>
<span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>        <span class="c">// fail if decryption fails</span>
<span class="o">|</span> <span class="nc">Some</span> <span class="n">plaintext</span> <span class="o">-&gt;</span> <span class="o">(</span> <span class="c">// decryption was successful</span>
    <span class="k">match</span> <span class="n">parse</span> <span class="n">plaintext</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>               <span class="c">// fail if parsing fails</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">abstract_plaintext</span> <span class="o">-&gt;</span> <span class="c">// parsing was successful</span>
        <span class="o">...</span> <span class="c">// do something with abstract_plaintext</span>
<span class="o">)</span>
</pre></div>
</div>
<p>This works perfectly fine, but is a lot of lines for just two actions!</p>
<p>To simplify the nested matches, we define the <code class="docutils literal notranslate"><span class="pre">option</span></code> monad.
The corresponding side effect here would be failure,
i.e., an optional action computes some value but may fail,
with the intuition that the execution stops in the failure case.</p>
<p>Similarly to <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code> for the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> monad,
we have <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;?</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">?</span></code> for composing functions that may fail
and accessing return values of such functions.</p>
<div class="admonition example">
<p class="admonition-title">Example: <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;?</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">?</span></code> for the <code class="docutils literal notranslate"><span class="pre">option</span></code> monad</p>
<p>Consider our example from before:
a function that decrypts a cipher text, parses the resulting plain text
and does something with the abstract plaintext.
Each of the actions may fail and we want the overall function to succeed only if all actions succeed.
We can write this as:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">?</span> <span class="n">plaintext</span> <span class="o">=</span> <span class="n">decrypt</span> <span class="n">cipher_text</span> <span class="k">in</span> <span class="c">// Try to decrypt the ciphertext.</span>
     <span class="c">// The whole step fails, if decryption fails. If decryption is successful, the result value is called plaintext.</span>
<span class="kd">let</span><span class="o">?</span> <span class="n">abstract_plaintext</span> <span class="o">=</span> <span class="n">parse</span> <span class="n">plaintext</span> <span class="k">in</span> <span class="c">// Try to parse the plaintext. If successful the result value is called abstract_plaintext</span>
<span class="n">some_function</span> <span class="n">abstract_plaintext</span><span class="o">;?</span>  <span class="c">// Do something with the abstract plaintext. This step may fail (causing the whole function to fail).</span>
<span class="nc">Some</span> <span class="n">abstract_plaintext</span>  <span class="c">// if all steps succeeded, the final return value of the function is the abstract plaintext</span>
</pre></div>
</div>
<p>See how the previous two nested matches are now just two lines (the first two)!</p>
</div>
</section>
<section id="the-traceful-option-monad">
<h3>The <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> Monad<a class="headerlink" href="#the-traceful-option-monad" title="Link to this heading"></a></h3>
<p>Most of the actions in a protocol step will be actions that work with the trace
<em>and</em> may fail.
For example,
in the last step of the Two-Message protocol,
Alice checks whether she previously started a flow
with the received nonce.
This action needs to look at the trace, but may fail if she did not start a flow with this nonce.</p>
<p>So we have a combination of the previous two side effects.
And indeed the combination of <code class="docutils literal notranslate"><span class="pre">traceful</span></code> and <code class="docutils literal notranslate"><span class="pre">option</span></code>, where we have <code class="docutils literal notranslate"><span class="pre">option</span></code> inside <code class="docutils literal notranslate"><span class="pre">traceful</span></code>,
i.e., <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="n">a</span><span class="o">)</span></code> is again a monad.</p>
<p>The intuition for sequentially composing two traceful + option actions is:</p>
<ul class="simple">
<li><p>the second action only gets executed if the first one is successful</p></li>
<li><p>if the first action fails, the changes on the underlying trace of the first action are still captured</p></li>
</ul>
<p>With this,
we model that the individual steps may fail,
but that all side-effects on the trace are recorded
up until the point of failure.</p>
<p>Just like before we have <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*?</span></code> for sequential composition and
<code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code> for accessing the return value of traceful + optional actions.</p>
<div class="admonition example" id="example-composition-in-traceful-option">
<p class="admonition-title">Example: Composition in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> Monad</p>
<p>Consider the following function in the traceful + option monad:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">f</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="kt">int</span><span class="o">):</span> <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="o">(</span>
    <span class="n">add_entry_</span> <span class="n">en</span><span class="o">;*?</span>
    <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="s2">&quot;added entry&quot;</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="k">else</span> <span class="n">return</span> <span class="nc">None</span>
</pre></div>
</div>
<p>This function takes an <code class="code highlight fstar docutils literal highlight-fstar"><span class="kt">int</span></code> <code class="docutils literal notranslate"><span class="pre">x</span></code>,
if <code class="docutils literal notranslate"><span class="pre">x</span></code> is less than 2,
an entry <code class="docutils literal notranslate"><span class="pre">en</span></code> is added to the current trace
and the string “added entry” is returned.
If <code class="docutils literal notranslate"><span class="pre">x</span></code> is not less than 2,
the function fails (and returns <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code>).</p>
<p>We sequentially execute this function 3 times with different values for <code class="docutils literal notranslate"><span class="pre">x</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">f3</span> <span class="o">=</span> <span class="n">f</span> <span class="mi">1</span><span class="o">;*?</span> <span class="n">f</span> <span class="mi">2</span><span class="o">;*?</span> <span class="n">f</span> <span class="mi">0</span>
</pre></div>
</div>
<p>and see how the trace evolves (beginning with an empty trace) and what the final return value is.</p>
<ol class="arabic simple">
<li><p>We begin with an empty trace <code class="docutils literal notranslate"><span class="pre">tr0</span></code>
and execute <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">1</span></code>.
This returns an optional string <code class="docutils literal notranslate"><span class="pre">opt_str1</span></code> and a new trace <code class="docutils literal notranslate"><span class="pre">tr1</span></code>.
Since 1 is less than 2,
the entry <code class="docutils literal notranslate"><span class="pre">en</span></code> will be added to the trace <code class="docutils literal notranslate"><span class="pre">tr0</span></code>
and <code class="docutils literal notranslate"><span class="pre">opt_str1</span></code> is <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">Some</span> <span class="s2">&quot;added entry&quot;</span></code>.</p></li>
<li><p>We then execute <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">2</span></code> with the new trace <code class="docutils literal notranslate"><span class="pre">tr1</span></code>.
This again, returns an optional string <code class="docutils literal notranslate"><span class="pre">opt_str2</span></code> and a new trace <code class="docutils literal notranslate"><span class="pre">tr2</span></code>.
Since 2 is not less than 2,
<code class="docutils literal notranslate"><span class="pre">opt_str2</span></code> is <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code> and the trace doesn’t change.</p></li>
<li><p>Since the previous step returned <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code>,
the final <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">0</span></code> is not executed.</p></li>
</ol>
<p>In total,
after step 3 we have a return value <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code>
and a trace <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[</span><span class="n">en</span><span class="o">]</span></code>.</p>
<p>To better understand the behaviour of the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad,
lets look at what happens if we switch the order of the three actions in the function <code class="docutils literal notranslate"><span class="pre">f3</span></code>:
(the first row is the case we just looked at)</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">f3</span></code></p></th>
<th class="head"><p>return value</p></th>
<th class="head"><p>new trace</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">1</span><span class="o">;*?</span>  <span class="n">f</span> <span class="mi">2</span><span class="o">;*?</span>  <span class="n">f</span> <span class="mi">0</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[</span><span class="n">en</span><span class="o">]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">0</span><span class="o">;*?</span>  <span class="n">f</span> <span class="mi">1</span><span class="o">;*?</span>  <span class="n">f</span> <span class="mi">2</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[</span><span class="n">en</span><span class="o">;</span>
<span class="n">en</span><span class="o">]</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">2</span><span class="o">;*?</span>  <span class="n">f</span> <span class="mi">1</span><span class="o">;*?</span>  <span class="n">f</span> <span class="mi">0</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[</span> <span class="o">]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">1</span><span class="o">;*?</span>  <span class="n">f</span> <span class="mi">0</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">Some</span> <span class="s2">&quot;added entry&quot;</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[</span><span class="n">en</span><span class="o">;</span>
<span class="n">en</span><span class="o">]</span></code></p></td>
</tr>
</tbody>
</table>
<p>Looking at the first three rows,
this highlights that monadic actions have <em>side effects</em>.
Although the return value is the same for all three rows,
the final trace is different.</p>
</div>
<p><span class="todo-inline">TODO: where should the following box go?</span></p>
<div class="admonition remember" id="remember-last-action-in-traceful-option">
<p class="admonition-title">Remember</p>
<p>The <em>last</em> action in a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function,
must be</p>
<ul class="simple">
<li><p>a call to a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> action or</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">return</span></code> of <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code> or <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">Some</span> <span class="n">value</span></code></p></li>
</ul>
</div>
</section>
<section id="comparing-traceful-option-with-traceful">
<span id="sec-comparing-traceful-option-traceful"></span><h3>Comparing <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> with <code class="docutils literal notranslate"><span class="pre">traceful</span></code><a class="headerlink" href="#comparing-traceful-option-with-traceful" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad can be considered
a special case of the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> monad:
Every action in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad
can be considered as an action in the plain <code class="docutils literal notranslate"><span class="pre">traceful</span></code> monad,
if we ignore the knowledge that the return type is an option.</p>
<p>We already saw this in the function <code class="docutils literal notranslate"><span class="pre">f</span></code> in the previous example:
The function uses the <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">return</span></code> of the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> monad (in Lines 5 and 7)
to return the computed value.
Since, the return type of <code class="docutils literal notranslate"><span class="pre">f</span></code>, considered as a plain <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action,
is an option,
we need to return <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">Some</span> <span class="n">value</span></code> or <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code>.</p>
<p>It is important to know
which of the two monads we want,
when composing <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> actions.</p>
<div class="admonition example">
<p class="admonition-title">Example: Comparing Composition of <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> actions with <code class="docutils literal notranslate"><span class="pre">traceful</span></code> actions</p>
<p>To highlight the difference between sequential composition
in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad
with composition in the plain <code class="docutils literal notranslate"><span class="pre">traceful</span></code> monad,
lets use <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code> instead of <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*?</span></code> in the function <code class="docutils literal notranslate"><span class="pre">f3</span></code> in the previous example:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">f3</span> <span class="o">=</span> <span class="n">f</span> <span class="mi">1</span><span class="o">;*</span> <span class="n">f</span> <span class="mi">2</span><span class="o">;*</span> <span class="n">f</span> <span class="mi">0</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> monad,
the composition just passes on the trace
without looking at the return values of the function.
Thus, the execution of <code class="docutils literal notranslate"><span class="pre">f3</span></code> does <strong>not</strong> stop
when <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">2</span></code> fails (as in the previous example)!
<code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">2</span></code> doesn’t change the trace and
<code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">0</span></code> is successfully executed.</p>
<p>The overall result of the new <code class="docutils literal notranslate"><span class="pre">f3</span></code> is
<code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">Some</span> <span class="s2">&quot;added entry&quot;</span></code>
and the new trace is <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[</span><span class="n">en</span><span class="o">;</span> <span class="n">en</span><span class="o">]</span></code>.</p>
<p>Look back at the first line in the table in the previous example
and compare the results when using <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*?</span></code>.</p>
</div>
<div class="admonition remember">
<p class="admonition-title">Remember</p>
<p>If we compose two <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> actions with <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code>,
the second action gets executed in any case, even if the first action fails.</p>
<p>If we compose them instead with <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*?</span></code>,
the second action is not executed when the first action fails.</p>
</div>
<p><span class="todo-inline">TODO: add a link/pointer to the example file in the repo (examples/Basics/DY.Basics.Monads.fst)</span></p>
</section>
<section id="combining-actions-from-different-monads">
<h3>Combining actions from different Monads<a class="headerlink" href="#combining-actions-from-different-monads" title="Link to this heading"></a></h3>
<p>We have now seen three monads,
and we looked at how to sequentially execute
actions <em>within the same</em> monad.
However,
it is often the case that we need to
combine actions from <em>different</em> monads.</p>
<div class="admonition example">
<p class="admonition-title">Example: The Three Monads in one Protocol Step</p>
<p>Consider the following prototypical excerpt of a protocol step:</p>
<ol class="arabic simple">
<li><p>receive a message</p></li>
<li><p>parse the received message</p></li>
<li><p>send a new message</p></li>
</ol>
<p>These actions are all in different monads:</p>
<ol class="arabic simple">
<li><p>receiving a message is a traceful action that may fail (if there is no message entry at the provided timestamp) (<code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code>)</p></li>
<li><p>parsing a message is an action that may fail, but does not need the trace (<code class="docutils literal notranslate"><span class="pre">option</span></code>)</p></li>
<li><p>sending a message is a traceful action that never fails (<code class="docutils literal notranslate"><span class="pre">traceful</span></code>)</p></li>
</ol>
</div>
<p>It is possible to compose actions of different monads,
but one has to be extra careful
which composition to use
and what the overall type of the function will be.</p>
<section id="the-overall-type">
<h4>The Overall Type<a class="headerlink" href="#the-overall-type" title="Link to this heading"></a></h4>
<p>Let’s first think about the overall type of a function
executing several actions from different monads.</p>
<p>Recall the main intuition:
monadic actions are functions with side effects.
If we compose several actions with different side effects,
the overall function may have <em>all</em> of the individual side effects.</p>
<p>In our case, we have the three side effects of
working with the trace, potential failure and “work with the trace and may fail”.
Observe, that the last one captures both side effects of the first two.
From this, we intuitively see that
whenever we compose actions from different monads,
the overall function will be in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad,
since we may have an effect on the trace and may fail.</p>
<p>Putting things a bit differently, this means,
that if you want to write a function in the <code class="docutils literal notranslate"><span class="pre">option</span></code> monad,
you <em>can not</em> use any <code class="docutils literal notranslate"><span class="pre">traceful</span></code> or <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> actions
inside,
since this would mean having more side effects
than just the failure case from <code class="docutils literal notranslate"><span class="pre">option</span></code>
specified in the type of your function.
And similarly,
if you are writing a non-optional <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function,
you can not use an <code class="docutils literal notranslate"><span class="pre">option</span></code> or <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> action inside,
since the failure side effect is not covered by the specified type.</p>
<div class="admonition remember">
<p class="admonition-title">Remember</p>
<p>If you compse actions from different monads,
you will end up in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad.</p>
<ul class="simple">
<li><p>Inside an <code class="docutils literal notranslate"><span class="pre">option</span></code> function,
you <em>can not</em> call <code class="docutils literal notranslate"><span class="pre">traceful</span></code> or <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> actions.</p></li>
<li><p>Inside a plain non-optional <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function,
you <em>can not</em> call <code class="docutils literal notranslate"><span class="pre">option</span></code> or <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> actions.</p></li>
</ul>
</div>
</section>
<section id="how-to-compose">
<h4>How to Compose<a class="headerlink" href="#how-to-compose" title="Link to this heading"></a></h4>
<p>Now that we know,
we are in a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function,
we have to think about
how to call <code class="docutils literal notranslate"><span class="pre">option</span></code> and plain <code class="docutils literal notranslate"><span class="pre">traceful</span></code> actions
inside our function.</p>
<section id="traceful-inside-traceful-option">
<h5><code class="docutils literal notranslate"><span class="pre">traceful</span></code> inside <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code><a class="headerlink" href="#traceful-inside-traceful-option" title="Link to this heading"></a></h5>
<p>Plain non-optional <code class="docutils literal notranslate"><span class="pre">traceful</span></code> actions
already have the “may modify trace” side effect,
but are missing the “might fail” effect.
Intuitively, a non-optional action,
just does not fail and always produces a result and a new trace.
We can thus use the plain <code class="docutils literal notranslate"><span class="pre">traceful</span></code> <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code>.</p>
<div class="admonition example">
<p class="admonition-title">Example: <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action inside <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code></p>
<p>In most of the protocol steps,
we will send some message.
This is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action,
since it appends the message to the trace,
that returns the timestamp of the message in the new trace.
The action never fails, since entries can always be added to the trace.</p>
<p>In the protocol step we can write</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">send_msg</span> <span class="n">message</span><span class="o">;*</span>
<span class="o">...</span> <span class="c">// some other traceful + option actions</span>
</pre></div>
</div>
<p>Or, if we want to use the returned timestamp</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="n">message</span> <span class="k">in</span>
<span class="o">...</span> <span class="c">// some other traceful + option actions that can use ts</span>
</pre></div>
</div>
</div>
<p>Recall from <a class="reference internal" href="modelling-tracefulmonad.html#remember-last-action-in-traceful-option"><span class="std std-ref">before</span></a>
that the last action in a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function,
needs to be a call to another <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> action (as in the example above),
or a <code class="docutils literal notranslate"><span class="pre">return</span></code> of an <code class="docutils literal notranslate"><span class="pre">option</span></code>.
So if we want to have a plain <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action as the last step in our function,
we need to have a <code class="docutils literal notranslate"><span class="pre">return</span></code> after that.</p>
<div class="admonition example">
<p class="admonition-title">Example: <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action as <em>last</em> action inside <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code></p>
<p>If sending a message is the last action in our protocol step,
and we want to return the message timestamp,
we need to write</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="n">message</span> <span class="k">in</span>
<span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">ts</span><span class="o">)</span>
</pre></div>
</div>
</div>
</section>
<section id="traceful-option-actions-inside-traceful-option">
<h5><code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> actions inside <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code><a class="headerlink" href="#traceful-option-actions-inside-traceful-option" title="Link to this heading"></a></h5>
<p>A special case of the above, are <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> actions
inside the overall <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function.
You may wonder why we need to talk about this case here.
Isn’t this just combining actions within the <em>same</em> monad?</p>
<p>Well, we have seen <a class="reference internal" href="modelling-tracefulmonad.html#sec-comparing-traceful-option-traceful"><span class="std std-ref">before</span></a>
that we can use both <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*?</span></code>
to combine <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> actions.
And it depends on whether we want the second action to be executed
if the first one fails or not.</p>
<div class="admonition example">
<p class="admonition-title">Example: Using both <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*?</span></code> for <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> actions</p>
<p>We look again at the function <code class="docutils literal notranslate"><span class="pre">f</span></code> from <a class="reference internal" href="modelling-tracefulmonad.html#example-composition-in-traceful-option"><span class="std std-ref">the previous example</span></a>
and use a mix of <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*?</span></code> to combine
the calls for different arguments:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">f3</span></code></p></th>
<th class="head"><p>return value</p></th>
<th class="head"><p>new trace</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">1</span><span class="o">;*?</span>  <span class="n">f</span> <span class="mi">2</span><span class="o">;*</span> <span class="n">f</span> <span class="mi">0</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">Some</span> <span class="s2">&quot;added entry&quot;</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[</span><span class="n">en</span><span class="o">;</span> <span class="n">en</span><span class="o">]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">1</span><span class="o">;*</span> <span class="n">f</span> <span class="mi">3</span> <span class="o">;*</span> <span class="n">f</span> <span class="mi">1</span> <span class="o">;*</span>
<span class="n">f</span> <span class="mi">2</span> <span class="o">;*?</span> <span class="n">f</span> <span class="mi">0</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[</span><span class="n">en</span><span class="o">;</span> <span class="n">en</span><span class="o">]</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="mi">1</span><span class="o">;*</span> <span class="n">f</span> <span class="mi">3</span> <span class="o">;*?</span> <span class="n">f</span> <span class="mi">1</span> <span class="o">;*</span>
<span class="n">f</span> <span class="mi">2</span> <span class="o">;*?</span> <span class="n">f</span> <span class="mi">0</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">None</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[</span><span class="n">en</span><span class="o">]</span></code></p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="option-inside-traceful-option">
<h5><code class="docutils literal notranslate"><span class="pre">option</span></code> inside <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code><a class="headerlink" href="#option-inside-traceful-option" title="Link to this heading"></a></h5>
<p>An <code class="docutils literal notranslate"><span class="pre">option</span></code> action,
already has the “may fail” effect,
but is missing the “modifies trace” effect,
since it doesn’t even operate on a trace.
Intuitively,
an action not working with the trace
can be seen as a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action
that doesn’t change the trace.
That is, an <code class="docutils literal notranslate"><span class="pre">option</span></code> action
can be seen as a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action
that computes some value and passes the underlying trace on unchanged.
This behavior can be realized with the <code class="docutils literal notranslate"><span class="pre">return</span></code> we <a class="reference internal" href="modelling-tracefulmonad.html#sec-traceful-return"><span class="std std-ref">previously</span></a> introduced.
<code class="docutils literal notranslate"><span class="pre">return</span></code> takes some value and attaches the current trace to it unchanged.</p>
<div class="admonition example">
<p class="admonition-title">Example: <code class="docutils literal notranslate"><span class="pre">option</span></code> action inside <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code></p>
<p>When we receive a message in some protocol step,
the message is in the wire format.
Since we want to work with the abstract format,
we need to parse the received message.
Parsing may fail but does not need to look at the trace.
Thus, parsing is an <code class="docutils literal notranslate"><span class="pre">option</span></code> action.
The overall protocol step will be a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function.</p>
<p>Thus, we need to use <code class="docutils literal notranslate"><span class="pre">return</span></code> around the call to <code class="docutils literal notranslate"><span class="pre">parse</span></code> inside the protocol step:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">abstract_message</span> <span class="o">=</span> <span class="n">return</span> <span class="o">(</span><span class="n">parse</span> <span class="n">wire_message</span><span class="o">)</span> <span class="k">in</span>
</pre></div>
</div>
</div>
<p><span class="todo-inline">TODO: add an exercise</span></p>
<div class="admonition remember">
<p class="admonition-title">Remember</p>
<p>To call an <code class="docutils literal notranslate"><span class="pre">option</span></code> action
inside a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function,
you need to use <code class="docutils literal notranslate"><span class="pre">return</span></code> around the call to the action.</p>
</div>
</section>
</section>
<section id="summary">
<h4>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h4>
<p>To summarize,
it is possible to combine actions from different monads.
If we do so, we will end up in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad.
To combine these actions, we need to take special care of which
<code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> to use.
The following gives an overview:</p>
<div class="admonition remember" id="monads-combine">
<p class="admonition-title">Remember: Which <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> to use?</p>
<p>If you want to call an action <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">act</span> <span class="o">:</span> <span class="n">m</span> <span class="n">ret</span></code>
inside a function <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">f</span> <span class="o">:</span> <span class="n">m&#39;</span> <span class="n">ret&#39;</span></code>,
where <code class="docutils literal notranslate"><span class="pre">m</span></code> and <code class="docutils literal notranslate"><span class="pre">m'</span></code> are two of the three monads we have seen,
and <code class="docutils literal notranslate"><span class="pre">ret</span></code> and <code class="docutils literal notranslate"><span class="pre">ret'</span></code> some return types,
you can use the following table to choose the right composition and accessing return values:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">m'</span></code> (the monad of <code class="docutils literal notranslate"><span class="pre">f</span></code>)</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">m</span></code> (the monad of <code class="docutils literal notranslate"><span class="pre">act</span></code>)</p></th>
<th class="head"><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;</span></code></p></th>
<th class="head"><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code></p></th>
<th class="head"><p>comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">option</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">option</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;?</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">?</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">traceful</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">traceful</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code></p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code> or
<code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*?</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code>
or
<code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code></p></td>
<td><p>depending on
wanted behavior
in error case:</p>
<p>should the rest
be executed if
the first action
fails or not?</p>
</td>
</tr>
<tr class="row-odd"><td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">option</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*?</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code></p></td>
<td><p><em>must</em> use
<code class="docutils literal notranslate"><span class="pre">return</span></code> around
call to action</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">traceful</span></code> and <code class="docutils literal notranslate"><span class="pre">ret'</span></code> is
not <code class="docutils literal notranslate"><span class="pre">option</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="o">;*</span></code></p></td>
<td><p><code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code></p></td>
<td><p>if <em>last</em> action
in <code class="docutils literal notranslate"><span class="pre">f</span></code>, a
<code class="docutils literal notranslate"><span class="pre">return</span></code> must
follow</p></td>
</tr>
</tbody>
</table>
<p>Plain <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> (i.e., non-monadic actions) can be used inside any monadic function.</p>
</div>
<p>We now have all pre-requisites to start our first protocol model in DY*.</p>
</section>
</section>
</section>
<section id="a-model-of-the-two-message-protocol">
<h2>A Model of the Two-Message Protocol<a class="headerlink" href="#a-model-of-the-two-message-protocol" title="Link to this heading"></a></h2>
<p>We build the DY* model of the Two-Message protocol following the <a class="reference internal" href="introduction.html#example-twomessage-localview"><span class="std std-ref">local-view description</span></a> step by step.</p>
<section id="setup">
<span id="model-twomessage-setup"></span><h3>Setup<a class="headerlink" href="#setup" title="Link to this heading"></a></h3>
<p>Create a new folder <code class="docutils literal notranslate"><span class="pre">TwoMessageP</span></code> and add the following <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>:</p>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">TUTORIAL_HOME</span><span class="w"> </span><span class="o">?=</span><span class="w"> </span>../..

<span class="nv">EXAMPLE_DIRS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>path_to/TwoMessageP

<span class="cp">include $(TUTORIAL_HOME)/Makefile</span>
</pre></div>
</div>
<p>If your run <code class="docutils literal notranslate"><span class="pre">make</span></code> in the <code class="docutils literal notranslate"><span class="pre">TwoMessageP</span></code> folder now,
it will verify all of core DY*.
This produces a lot of output on the terminal (including some warnings)
and takes quite some time (around 10 Minutes)!
You only have to do this once though, so you may as well start it now and let it run.</p>
<p>It is best practice to separate the definition of the abstract message and state types from the protocol steps.
We create two files <code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Data.fst</span></code> and <code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Protocol.fst</span></code> in the <code class="docutils literal notranslate"><span class="pre">TwoMessageP</span></code> folder.
Both of them are F* modules and as such must begin with</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">name_of_file_without_fst</span>
</pre></div>
</div>
<p>To import functions from core DY*, we need to open the corresponding modules in both:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">open</span> <span class="nc">Comparse</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Lib</span>
</pre></div>
</div>
<p>If the environment variables and the Makefile are setup correctly,
you should be able to (interactively) check both of the files successfully.
If the previous <code class="docutils literal notranslate"><span class="pre">make</span></code> has finished and you do <code class="docutils literal notranslate"><span class="pre">make</span></code> again,
it should be much faster and you should see a few lines related to the two files in the folder.</p>
</section>
<section id="the-abstract-message-and-state-types">
<h3>The abstract message and state types<a class="headerlink" href="#the-abstract-message-and-state-types" title="Link to this heading"></a></h3>
<p>We define the types for the abstract message and state format in the <code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Data</span></code> file.</p>
<section id="messages">
<h4>Messages<a class="headerlink" href="#messages" title="Link to this heading"></a></h4>
<p>When we previously introduced the abstract message format
and looked at the example for the Two-Message protocol,
we already used valid F* syntax.
So we can just copy the two record type definitions for <code class="docutils literal notranslate"><span class="pre">ping_t</span></code> and <code class="docutils literal notranslate"><span class="pre">ack_t</span></code>
from the <a class="reference internal" href="modelling-wireabstractformats.html#ex-abstract-messages-twomessagep"><span class="std std-ref">previous example</span></a>.</p>
<p>Now that we have the types for the two messages separately,
we want to collect them in a single type for messages.
We do this, by defining a new type <code class="docutils literal notranslate"><span class="pre">message_t</span></code>
and use constructors for the two messages:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">message_t</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Ping</span><span class="o">:</span> <span class="o">(</span><span class="n">ping</span><span class="o">:</span><span class="n">ping_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">message_t</span>
  <span class="o">|</span> <span class="nc">Ack</span><span class="o">:</span>  <span class="o">(</span><span class="n">ack</span><span class="o">:</span><span class="n">ack_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">message_t</span>
</pre></div>
</div>
<p>This fully defines our abstract message format.
Whenever we have a <code class="docutils literal notranslate"><span class="pre">msg</span></code> of type <code class="docutils literal notranslate"><span class="pre">message_t</span></code>,
we know from the constructor whether it is a Ping or Ack message
and we can access the corresponding fields from the <code class="docutils literal notranslate"><span class="pre">ping_t</span></code> or <code class="docutils literal notranslate"><span class="pre">ack_t</span></code> record.</p>
<div class="admonition example">
<p class="admonition-title">Example: Recap – Instantiating and Accessing Values of Record Types</p>
<p>A concret instance of a Ping message with content “Alice” and <span class="math notranslate nohighlight">\(n\)</span>, can be specified as</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">msg</span> <span class="o">:</span> <span class="n">message_t</span> <span class="o">=</span> <span class="nc">Ping</span> <span class="o">{</span><span class="n">alice</span> <span class="o">=</span> <span class="s2">&quot;Alice&quot;</span><span class="o">;</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">n</span><span class="o">}</span>
</pre></div>
</div>
<p>Given this <code class="docutils literal notranslate"><span class="pre">msg</span></code>, we can access say the <code class="docutils literal notranslate"><span class="pre">alice</span></code> field value with:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">al</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Ping</span><span class="o">?.</span><span class="n">ping</span> <span class="n">msg</span><span class="o">).</span><span class="n">alice</span>
</pre></div>
</div>
</div>
<p>We now need to deal with parsing and serializing of our abstract message format from/to the wire format.
Luckily, we don’t have to write parsing and serializing by hand,
since the tool <a class="reference external" href="https://github.com/TWal/comparse">Comparse</a> can construct those
automatically from the type definitions.</p>
<p>To invoke Comparse for a given type, we have to call</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_</span><span class="o">(</span><span class="n">name_of_type</span><span class="o">)]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">name_of_type</span><span class="o">))</span>
</pre></div>
</div>
<p>In our case, we need:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_ping_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ping_t</span><span class="o">))</span>

<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_ack_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ack_t</span><span class="o">))</span>

<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_message_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">message_t</span><span class="o">))</span>
</pre></div>
</div>
<p>This generates parsing and serializing functions for each of our abstract message types.</p>
<p>However, this does not quite work yet.
We need to guide Comparse a bit.
Since Comparse is so general, we need to add some annotations to our types.
We need to add
<code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span></code> right before the type definitions, i.e.,</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span>
<span class="k">type</span> <span class="n">ping_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>We need to do that also for <code class="docutils literal notranslate"><span class="pre">ack_t</span></code> and <code class="docutils literal notranslate"><span class="pre">message_t</span></code>.</p>
<p>Once you added all annotations, the splices should verify.
Verifying these lines takes a while (up to 15 Seconds)!
This is one of the reasons to separate them from other functions that you may want to
re-check frequently (for example protocol steps).</p>
<div class="admonition info">
<p class="admonition-title">Common Mistake: Forgetting <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span></code></p>
<p>If you try <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_ping_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ping_t</span><span class="o">))</span></code>,
but get an error of the form</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- ’tc’ failed
- ’tcc’ failed
- Cannot type (3) DY.Core.Bytes.Type.ps_bytes in context ([]). Error = ( - Name
  &quot;DY.Core.Bytes.Type.ps_bytes&quot; not found )
</pre></div>
</div>
<p>you probably forgot to add the annotation <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span></code>
right before the type you are splicing (here <code class="docutils literal notranslate"><span class="pre">ping_t</span></code>).</p>
</div>
<div class="admonition info">
<p class="admonition-title">Common Mistake: Not using <code class="docutils literal notranslate"><span class="pre">ps_name_of_type</span></code> in the first argument of <code class="docutils literal notranslate"><span class="pre">splice</span></code></p>
<p>If you get an error of the form</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Splice declared the name DY.TwoMessageP.Data.something_else_than_ps_ack_t but it was not defined.
Those defined were: [DY.TwoMessageP.Data.ps_ack_t]
</pre></div>
</div>
<p>you probably didn’t use <code class="docutils literal notranslate"><span class="pre">ps_ack_t</span></code> in the brackets of the splice.</p>
<p>The term in this brackets really needs to be <code class="docutils literal notranslate"><span class="pre">ps_</span></code> followed by the name of the type (here <code class="docutils literal notranslate"><span class="pre">ack_t</span></code>)!</p>
<p>That is, <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">something_else_than_ps_ack_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ack_t</span><span class="o">))</span></code> will produce the above error,
while <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_ack_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ack_t</span><span class="o">))</span></code> will not.</p>
</div>
<p>The final step for serializing and parsing is to declare our message type <code class="docutils literal notranslate"><span class="pre">message_t</span></code>
an instance of Comparse’s <code class="docutils literal notranslate"><span class="pre">parseable_serializable</span></code> class, like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="n">parseable_serializeable_bytes_message_t</span><span class="o">:</span> <span class="n">parseable_serializeable</span> <span class="n">bytes</span> <span class="n">message_t</span> <span class="o">=</span>
  <span class="n">mk_parseable_serializeable</span> <span class="n">ps_message_t</span>
</pre></div>
</div>
<p>We don’t need to understand the details of this line.
The important part is, that now we can call <code class="docutils literal notranslate"><span class="pre">parse</span></code> and <code class="docutils literal notranslate"><span class="pre">serialize</span></code> for instances of our message type.</p>
<div class="admonition example">
<p class="admonition-title">Example: <code class="docutils literal notranslate"><span class="pre">serialize</span></code> and <code class="docutils literal notranslate"><span class="pre">parse</span></code> for <code class="docutils literal notranslate"><span class="pre">message_t</span></code></p>
<p>With <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span> <span class="n">msg</span> <span class="o">:</span> <span class="n">message_t</span> <span class="o">=</span> <span class="nc">Ping</span> <span class="o">{</span><span class="n">alice</span> <span class="o">=</span> <span class="s2">&quot;Alice&quot;</span><span class="o">;</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">empty</span><span class="o">}</span></code> from above, we can write</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">_</span> <span class="o">=</span>
  <span class="kd">let</span> <span class="n">msg_wire</span> <span class="o">:</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">serialize</span> <span class="n">message_t</span> <span class="n">msg</span> <span class="k">in</span> <span class="c">// serialize the abstract format to the wire format</span>
  <span class="kd">let</span> <span class="n">msg_</span> <span class="o">=</span> <span class="n">parse</span> <span class="n">message_t</span> <span class="n">msg_wire</span> <span class="k">in</span>  <span class="c">// parse from the wire format to an abstract message</span>
</pre></div>
</div>
<p>Note that we have to tell <code class="docutils literal notranslate"><span class="pre">serialize</span></code> and <code class="docutils literal notranslate"><span class="pre">parse</span></code> what the abstract type is that we consider (here <code class="docutils literal notranslate"><span class="pre">message_t</span></code>).</p>
</div>
<p>We don’t need to care about <em>how</em> the abstract messages are translated to the wire format,
i.e., how <code class="docutils literal notranslate"><span class="pre">msg_wire</span></code> looks like.
We just use the following properties that Comparse provides automatically:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">parse_serialize_inv_lemma</span> <span class="n">x</span> <span class="o">=</span>
  <span class="n">parse</span> <span class="n">message_t</span> <span class="o">(</span><span class="n">serialize</span> <span class="n">message_t</span> <span class="n">x</span><span class="o">)</span> <span class="o">==</span> <span class="nc">Some</span> <span class="n">x</span>

<span class="kd">let</span> <span class="n">serialize_parse_inv_lemma</span> <span class="n">buff</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">parse</span> <span class="n">message_t</span> <span class="n">buf</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">serialize</span> <span class="n">message_t</span> <span class="n">x</span> <span class="o">==</span> <span class="n">buf</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">True</span>
</pre></div>
</div>
<div class="toggle-header docutils container">
<p><strong>Discussion</strong></p>
</div>
<div class="toggle-content box docutils container">
<p>These inverse properties of parsing and serializing are quite strong
and may not be true for some real-world protocols!
There might be different abstract messages that have the same serialization.
Or the other way around: a wire format message could be parsed to two different abstract formats.
There are examples of format confusion attacks for several protocols.</p>
<p>Thus, enforcing the inverse properties “hides” some attacks
that can not be found when using Comparse for generating the parser and serializer of a type.</p>
</div>
<p>Your <code class="docutils literal notranslate"><span class="pre">DY.TwoMessageP.Data.fst</span></code> file should now look like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">TwoMessageP</span><span class="p">.</span><span class="nc">Data</span>

<span class="k">open</span> <span class="nc">Comparse</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Lib</span>

<span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span>
<span class="k">type</span> <span class="n">ping_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span>
<span class="k">type</span> <span class="n">ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span>
<span class="k">type</span> <span class="n">message_t</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Ping</span><span class="o">:</span> <span class="o">(</span><span class="n">ping</span><span class="o">:</span><span class="n">ping_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">message_t</span>
  <span class="o">|</span> <span class="nc">Ack</span><span class="o">:</span>  <span class="o">(</span><span class="n">ack</span><span class="o">:</span><span class="n">ack_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">message_t</span>

<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_ping_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ping_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_ack_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ack_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_message_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">message_t</span><span class="o">))</span>

<span class="n">instance</span> <span class="n">parseable_serializeable_bytes_message_t</span><span class="o">:</span> <span class="n">parseable_serializeable</span> <span class="n">bytes</span> <span class="n">message_t</span> <span class="o">=</span>
  <span class="n">mk_parseable_serializeable</span> <span class="n">ps_message_t</span>
</pre></div>
</div>
<p>We defined types for the abstract formats for Ping and Ack messages.
We then collected them in an overall <code class="docutils literal notranslate"><span class="pre">message_t</span></code> type.
Finally, we used Comparse to generate parsers and serializers for our types,
so that we can call <code class="docutils literal notranslate"><span class="pre">parse</span></code> and <code class="docutils literal notranslate"><span class="pre">serialize</span></code> for values of type <code class="docutils literal notranslate"><span class="pre">message_t</span></code>.</p>
</section>
<section id="states">
<h4>States<a class="headerlink" href="#states" title="Link to this heading"></a></h4>
<p>We do the exact same thing for our <a class="reference internal" href="modelling-wireabstractformats.html#ex-abstract-state-twomessage"><span class="std std-ref">abstract state formats</span></a>.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Define the abstract state format and parsing and serializing for them</p>
<ol class="arabic">
<li><p>Copy the record types for the single abstract states.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">sent_ping_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">bob</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">type</span> <span class="n">sent_ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">type</span> <span class="n">received_ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">bob</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</li>
<li><p>Collect the types for the single states into an overall <code class="docutils literal notranslate"><span class="pre">state_t</span></code> type.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">state_t</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">SentPing</span><span class="o">:</span> <span class="o">(</span><span class="n">ping</span><span class="o">:</span><span class="n">sent_ping_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">state_t</span>
  <span class="o">|</span> <span class="nc">SentAck</span><span class="o">:</span> <span class="o">(</span><span class="n">ack</span><span class="o">:</span><span class="n">sent_ack_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">state_t</span>
  <span class="o">|</span> <span class="nc">ReceivedAck</span><span class="o">:</span> <span class="o">(</span><span class="n">rack</span><span class="o">:</span><span class="n">received_ack_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">state_t</span>
</pre></div>
</div>
</div>
</li>
<li><p>Use Comparse to generate a parser and serializer for <code class="docutils literal notranslate"><span class="pre">state_t</span></code>.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_sent_ping_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">sent_ping_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_sent_ack_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">sent_ack_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_received_ack_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">received_ack_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_state_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">state_t</span><span class="o">))</span>
</pre></div>
</div>
<p>Don’t forget to add <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span></code> for every type!</p>
</div>
</li>
<li><p>Make <code class="docutils literal notranslate"><span class="pre">state_t</span></code> an instance of Comparse’s <code class="docutils literal notranslate"><span class="pre">parseable_serializable</span></code> class.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="n">parseable_serializeable_bytes_state_t</span><span class="o">:</span> <span class="n">parseable_serializeable</span> <span class="n">bytes</span> <span class="n">state_t</span> <span class="o">=</span>
  <span class="n">mk_parseable_serializeable</span> <span class="n">ps_state_t</span>
</pre></div>
</div>
</div>
</li>
</ol>
</div>
<p>There is one final technicality that we need to do for the state type.
We need to make it an instance of DY*’s <code class="docutils literal notranslate"><span class="pre">local_state</span></code> like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="n">local_state_state_t</span><span class="o">:</span> <span class="n">local_state</span> <span class="n">state_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;TwoMessage.State&quot;</span><span class="o">;</span>
  <span class="n">format</span> <span class="o">=</span> <span class="n">parseable_serializeable_bytes_state_t</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This ensures that our protocol-level states do not interfere with any state internal to DY*.</p>
</section>
<section id="id2">
<h4>Summary<a class="headerlink" href="#id2" title="Link to this heading"></a></h4>
<p>We now have our abstract message and state types
and can translate those to and from the wire format.
This is all that goes into the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module.</p>
<div class="admonition remember">
<p class="admonition-title">How-To: Define abstract message and state formats</p>
<ul class="simple">
<li><p>The abstract formats for messages and states go into the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module.</p></li>
<li><p>For each message and state in the protocol,
define its own type as a record.</p></li>
<li><p>Collect the individual record types for messages and states in an overall type <code class="docutils literal notranslate"><span class="pre">message_t</span></code> and <code class="docutils literal notranslate"><span class="pre">state_t</span></code>
using constructors for each of the cases.</p></li>
<li><p>Use Comparse to generate a parser and serializer for the types, with
<code class="code highlight fstar docutils literal highlight-fstar"><span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_name_of_type</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">name_of_type</span><span class="o">))</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span></code> annotations.</p></li>
<li><p>Define <code class="docutils literal notranslate"><span class="pre">parseable_serializable</span></code> instances for <code class="docutils literal notranslate"><span class="pre">message_t</span></code> and <code class="docutils literal notranslate"><span class="pre">state_t</span></code>.</p></li>
<li><p>Define <code class="docutils literal notranslate"><span class="pre">local_state</span></code> instance for <code class="docutils literal notranslate"><span class="pre">state_t</span></code>.</p></li>
</ul>
</div>
</section>
</section>
<section id="the-protocol-steps">
<h3>The protocol steps<a class="headerlink" href="#the-protocol-steps" title="Link to this heading"></a></h3>
<p>We will now implement the protocol steps in the <code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Protocol</span></code> module.</p>
<p>First, we need to import some libraries that we need later.
From above, we already have</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">open</span> <span class="nc">Comparse</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Lib</span>
</pre></div>
</div>
<p>we add two more DY* libraries from the tutorial repo,
that offer a simplified interface to some of the core DY* functions:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Simplified</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Extend</span>
</pre></div>
</div>
<p>These are imports for DY* functionality,
but we also want to use the abstract message and state types,
we just defined.
So we finally need to import</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">TwoMessage</span><span class="p">.</span><span class="nc">Data</span>
</pre></div>
</div>
<p>Our model of the Two-Message Protocol,
will consist of 3 functions,
one for each step of the <a class="reference internal" href="introduction.html#example-twomessage-localview"><span class="std std-ref">local-view description</span></a>.</p>
<section id="the-first-step-sending-a-ping">
<h4>The first step: Sending a Ping<a class="headerlink" href="#the-first-step-sending-a-ping" title="Link to this heading"></a></h4>
<p>Recall what happens in the first step of the protocol,
where Alice sends a Ping message:</p>
<ol class="arabic simple">
<li><p>Alice generates a new nonce <span class="math notranslate nohighlight">\(n_A\)</span></p></li>
<li><p>Alice sends the Ping message containing the nonce <span class="math notranslate nohighlight">\(n_A\)</span>
together with her name.</p></li>
<li><p>She stores the nonce <span class="math notranslate nohighlight">\(n_A\)</span> and Bob’s name in a new session.</p></li>
</ol>
<section id="the-type">
<h5>The type<a class="headerlink" href="#the-type" title="Link to this heading"></a></h5>
<p>Let’s first think about the type of this protocol step.
Since we will send a message and store a new state,
the step is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function.
Sending a message and storing a new state are both actions
that will always succeed, so we have a plain non-optional <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function.</p>
<p>The input arguments are the names of Alice and Bob,
where Alice is the acting party and Bob is the intended receiver
of the message.</p>
<p>The return values are
the session ID of the new session of Alice,
where she stored the nonce,
so that we know which of Alice’s sessions is the one
related to this run of the protocol
and
the timestamp of the Ping message,
so that we know where Bob can read the Ping on the trace.</p>
<p>In total, we have:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">send_ping</span><span class="o">:</span>
  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">bob</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">)</span>
</pre></div>
</div>
</section>
<section id="generating-the-nonce">
<h5>Generating the nonce<a class="headerlink" href="#generating-the-nonce" title="Link to this heading"></a></h5>
<p>To generate the nonce <span class="math notranslate nohighlight">\(n_A\)</span>,
we use the function <code class="docutils literal notranslate"><span class="pre">gen_rand</span></code> from the <code class="docutils literal notranslate"><span class="pre">DY.Simplified</span></code> library.
This is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action, so we need to use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code>
to give a name to the nonce:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">gen_rand</span> <span class="k">in</span>
</pre></div>
</div>
</section>
<section id="sending-the-message">
<h5>Sending the message<a class="headerlink" href="#sending-the-message" title="Link to this heading"></a></h5>
<p>We build the abstract Ping message with</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">ping</span> <span class="o">=</span> <span class="nc">Ping</span> <span class="o">{</span><span class="n">alice</span> <span class="o">=</span> <span class="n">alice</span><span class="o">;</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
</pre></div>
</div>
<p>Note that this is a non-monadic action,
i.e., an action without any side effects.
We are just defining a concrete instance of an abstract message.
Hence, we use the plain <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> here.
Recall,
that plain <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> s can be used inside any monad.</p>
<p>Before sending the Ping,
we need to translate it to the wire format.
That is, we need to serialize it:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">ping_wire</span> <span class="o">=</span> <span class="n">serialize</span> <span class="n">message_t</span> <span class="n">ping</span> <span class="k">in</span>
</pre></div>
</div>
<p>Again, serializing is a non-monadic action,
so we have the plain <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code>.</p>
<p>Observe that we need to tell the <code class="docutils literal notranslate"><span class="pre">serialize</span></code> function
the type of the second argument (here <code class="docutils literal notranslate"><span class="pre">message_t</span></code>),
so that it knows which format to use.</p>
<p>Now, we can send the serialized Ping message
with the <code class="docutils literal notranslate"><span class="pre">send_msg</span></code> function from <code class="docutils literal notranslate"><span class="pre">DY.Core</span></code>.
This function is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function
that adds the message to the trace
and returns
the timestamp of the message on the trace.
This time, we have to use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code> to give the returned timestamp a name
(<code class="docutils literal notranslate"><span class="pre">traceful</span></code> action inside a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function):</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">msg_ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="n">ping_wire</span> <span class="k">in</span>
</pre></div>
</div>
<p>The message is now sent and we can turn to storing the new state.</p>
</section>
<section id="storing-the-state">
<h5>Storing the state<a class="headerlink" href="#storing-the-state" title="Link to this heading"></a></h5>
<p>As for the message,
we first define the abstract state with</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">ping_state</span> <span class="o">=</span> <span class="nc">SentPing</span> <span class="o">{</span><span class="n">bob</span> <span class="o">=</span> <span class="n">bob</span><span class="o">;</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
</pre></div>
</div>
<p>We can then use the <code class="docutils literal notranslate"><span class="pre">start_new_session</span></code> function from
the simplified <code class="docutils literal notranslate"><span class="pre">DY.Simplified</span></code> library,
which returns the sessoin ID of the new session that was created.
This is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action,
hence we use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code> again.</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">sid</span> <span class="o">=</span> <span class="n">start_new_session</span> <span class="n">alice</span> <span class="n">ping_state</span> <span class="k">in</span>
</pre></div>
</div>
<p>Note, that in contrast to messages,
we do not need to serialize the abstract state first!
This is handled internally by the <code class="docutils literal notranslate"><span class="pre">start_new_session</span></code> function
which is very convenient.</p>
<p>That’s it for storing the state.</p>
</section>
<section id="returning">
<h5>Returning<a class="headerlink" href="#returning" title="Link to this heading"></a></h5>
<p>We performed all actions
(generating the nonce, sending the Ping message and storing a new state)
and can now finish the protocol step
by returning the new session id and the message timestamp:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">return</span> <span class="o">(</span><span class="n">sid</span><span class="o">,</span> <span class="n">msg_ts</span><span class="o">)</span>
</pre></div>
</div>
</section>
<section id="id3">
<h5>Summary<a class="headerlink" href="#id3" title="Link to this heading"></a></h5>
<p>In total, the function looks like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">send_ping</span><span class="o">:</span>
  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">bob</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">)</span>
<span class="kd">let</span> <span class="n">send_ping</span> <span class="n">alice</span> <span class="n">bob</span> <span class="o">=</span>
  <span class="kd">let</span><span class="o">*</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">gen_rand</span> <span class="k">in</span>

  <span class="kd">let</span> <span class="n">ping</span> <span class="o">=</span> <span class="nc">Ping</span> <span class="o">{</span><span class="n">alice</span> <span class="o">=</span> <span class="n">alice</span><span class="o">;</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">ping_wire</span> <span class="o">=</span> <span class="n">serialize</span> <span class="n">message_t</span> <span class="n">ping</span> <span class="k">in</span>
  <span class="kd">let</span><span class="o">*</span> <span class="n">msg_ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="n">ping_wire</span> <span class="k">in</span>

  <span class="kd">let</span> <span class="n">ping_state</span> <span class="o">=</span> <span class="nc">SentPing</span> <span class="o">{</span><span class="n">bob</span> <span class="o">=</span> <span class="n">bob</span><span class="o">;</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
  <span class="kd">let</span><span class="o">*</span> <span class="n">sid</span> <span class="o">=</span> <span class="n">start_new_session</span> <span class="n">alice</span> <span class="n">ping_state</span> <span class="k">in</span>

  <span class="n">return</span> <span class="o">(</span><span class="n">sid</span><span class="o">,</span> <span class="n">msg_ts</span><span class="o">)</span>
</pre></div>
</div>
</section>
</section>
<section id="the-second-step-replying-with-an-ack">
<h4>The second step: Replying with an Ack<a class="headerlink" href="#the-second-step-replying-with-an-ack" title="Link to this heading"></a></h4>
<p>In the second protocol step,
Bob receives a Ping message,
sends back the received nonce
and stores a new state for the session
with Alice and the none received in the message.</p>
<section id="id4">
<h5>The Type<a class="headerlink" href="#id4" title="Link to this heading"></a></h5>
<p>We begin again with the type of this second step.
We are now reading from the trace, sending a message
and storing a new state.
So this step is also a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function.
But now, reading the Ping message may fail
(either when receiving, if there is no message entry at the
given timestamp or when parsing the wire format message to a Ping)
and so the whole step mail fail and we end up with a
<code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function.</p>
<p>The input arguments are
the name of Bob (the receiving and replying participant)
and the timestamp of the Ping message.</p>
<p>The return values are the same as for the first protocol step:
the session ID of the new session of Bob,
where he stores the received nonce and name for this protocol run
and the timestamp of his reply (the Ack).</p>
<p>Thus, we have the type:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">receive_ping_and_send_ack</span><span class="o">:</span>
  <span class="o">(</span><span class="n">bob</span><span class="o">:</span><span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">ping_ts</span><span class="o">:</span><span class="n">timestamp</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">))</span>
</pre></div>
</div>
</section>
<section id="receiving-the-ping">
<h5>Receiving the Ping<a class="headerlink" href="#receiving-the-ping" title="Link to this heading"></a></h5>
<p>To read the message from the trace,
i.e., receiving a message,
we call the <code class="docutils literal notranslate"><span class="pre">recv_msg</span></code> function from <code class="docutils literal notranslate"><span class="pre">DY.Core</span></code>.
It takes as an argument the timestamp of the message
and returns the content of the message in wire format.
This can fail, if the entry at the provided timestamp
is not a message entry (for example, if it is a state entry,
or a generate nonce entry).
<code class="docutils literal notranslate"><span class="pre">recv_msg</span></code> is thus a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function.
Since we want the overall protocol step to fail,
if receiving the message fails,
we use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code> to store the read message content:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">recv_msg</span> <span class="n">msg_ts</span> <span class="k">in</span>
</pre></div>
</div>
<p>If receiving is successful,
<code class="docutils literal notranslate"><span class="pre">msg</span></code> contains the content of the message
and the step continues.
We now have to translate the wire format <code class="docutils literal notranslate"><span class="pre">msg</span></code>
to our abstract Ping type.
Translating from wire to abstract format is parsing
and we would like to call</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">parse</span> <span class="n">message_t</span> <span class="n">msg</span>
</pre></div>
</div>
<p>Parsing is an action that might fail,
but does not need to look at or change the trace.
Hence, parsing is an <code class="docutils literal notranslate"><span class="pre">option</span></code> action.
Now recall from the <a class="reference internal" href="modelling-tracefulmonad.html#monads-combine"><span class="std std-ref">monad introduction</span></a>
that if we want to use an <code class="docutils literal notranslate"><span class="pre">option</span></code> action
inside a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> action,
we need to use a <code class="docutils literal notranslate"><span class="pre">return</span></code> around the call.
And again, we want our overall step to fail,
if parsing fails,
so we use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">png</span> <span class="o">=</span> <span class="n">return</span> <span class="o">(</span><span class="n">parse</span> <span class="n">message_t</span> <span class="n">msg</span><span class="o">)</span> <span class="k">in</span>
</pre></div>
</div>
<p>If parsing is successful,
we now have the abstract format of
the message content stored at the input argument timestamp.
Now, we need to check that the received message
is indeed a Ping message (and not an Ack for example).
If it is not a Ping message,
the whole step should fail.</p>
<p>For this check,
we use the <code class="docutils literal notranslate"><span class="pre">guard_tr</span></code> function from <code class="docutils literal notranslate"><span class="pre">DY.Core</span></code>.
This function takes a <code class="docutils literal notranslate"><span class="pre">bool</span></code> as argument
and has the behavior: if the bool is <code class="code highlight fstar docutils literal highlight-fstar"><span class="bp">true</span></code>,
the execution continues with an unchanged trace,
if it is <code class="code highlight fstar docutils literal highlight-fstar"><span class="bp">false</span></code> the execution stops.</p>
<p>With this, we can write:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">guard_tr</span> <span class="o">(</span><span class="nc">Ping</span><span class="o">?</span> <span class="n">png</span><span class="o">);*?</span>
</pre></div>
</div>
<p>This checks, if the received abstract message is a Ping or not
and stops the execution if not.</p>
<p>Now, we know that the received message is indeed a Ping
and we can finally access the values that we need:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nc">Ping</span> <span class="n">png</span> <span class="o">=</span> <span class="n">png</span> <span class="k">in</span>
<span class="kd">let</span> <span class="n">alice</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">alice</span> <span class="k">in</span>
<span class="kd">let</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">n_a</span> <span class="k">in</span>
</pre></div>
</div>
<p>Note: The first line above just removes the <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">Ping</span></code> constructor.
The received and parsed <code class="docutils literal notranslate"><span class="pre">png</span></code> is of the general <code class="docutils literal notranslate"><span class="pre">message_t</span></code> type,
but to access the field values of the <code class="docutils literal notranslate"><span class="pre">ping_t</span></code> record,
we need to remove the <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">Ping</span></code> constructor first.</p>
<p>This concludes receiving of the message
and reading its content.</p>
</section>
<section id="sending-the-ack">
<h5>Sending the Ack<a class="headerlink" href="#sending-the-ack" title="Link to this heading"></a></h5>
<p>We can now build the reply by
defining the concrete instance of the <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">ack_t</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">ack</span> <span class="o">=</span> <span class="nc">Ack</span> <span class="o">{</span><span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
</pre></div>
</div>
<p>To send the reply,
we first need to serialize it to the wire format
and can then use the <code class="docutils literal notranslate"><span class="pre">send_msg</span></code> function,
we already saw in the first protocol step.
This time, we do both serializing and sending together:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">ack_ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="o">(</span><span class="n">serialize</span> <span class="n">message_t</span> <span class="n">ack</span><span class="o">)</span> <span class="k">in</span>
</pre></div>
</div>
<p>Remember that sending a message is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action
that does not fail,
hence we have to use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code> here.</p>
</section>
<section id="id5">
<h5>Storing the State<a class="headerlink" href="#id5" title="Link to this heading"></a></h5>
<p>The remaining part of the second protocol step
is storing a new state for Bob.
This works the same as in the first protocol step.
We first define the content of the new state
in the abstract format:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">ack_state</span> <span class="o">=</span> <span class="nc">SentAck</span> <span class="o">{</span><span class="n">alice</span><span class="o">;</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
</pre></div>
</div>
<p>and then start a new session for Bob with this new content:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">sess_id</span> <span class="o">=</span> <span class="n">start_new_session</span> <span class="n">bob</span> <span class="n">ack_state</span> <span class="k">in</span>
</pre></div>
</div>
<p>Recall, we don’t have to serialize the state content,
as this is done implicitly inside the <code class="docutils literal notranslate"><span class="pre">start_new_session</span></code> function.
Again, this is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function that does not fail,
hence the <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code>.</p>
</section>
<section id="id6">
<h5>Returning<a class="headerlink" href="#id6" title="Link to this heading"></a></h5>
<p>Finally, we have to return the
session ID of the new session
and the timestamp of the Ack.
Remember, that we are now in a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function,
hence we need to return an <code class="docutils literal notranslate"><span class="pre">option</span></code>
(in contrast to the first protocol step):</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="o">(</span><span class="n">sess_id</span><span class="o">,</span> <span class="n">ack_ts</span><span class="o">))</span>
</pre></div>
</div>
</section>
<section id="id7">
<h5>Summary<a class="headerlink" href="#id7" title="Link to this heading"></a></h5>
<p>Collecting everything from above,
the second protocol step looks like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">receive_ping_and_send_ack</span><span class="o">:</span>
  <span class="o">(</span><span class="n">bob</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">ping_ts</span><span class="o">:</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">))</span>
<span class="kd">let</span> <span class="n">receive_ping_and_send_ack</span> <span class="n">bob</span> <span class="n">msg_ts</span> <span class="o">=</span>
  <span class="kd">let</span><span class="o">*?</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">recv_msg</span> <span class="n">msg_ts</span> <span class="k">in</span>
  <span class="kd">let</span><span class="o">*?</span> <span class="n">png</span> <span class="o">=</span> <span class="n">return</span> <span class="o">(</span><span class="n">parse</span> <span class="n">message_t</span> <span class="n">msg</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">guard_tr</span> <span class="o">(</span><span class="nc">Ping</span><span class="o">?</span> <span class="n">png</span><span class="o">);*?</span>

  <span class="kd">let</span> <span class="nc">Ping</span> <span class="n">png</span> <span class="o">=</span> <span class="n">png</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">alice</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">alice</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">n_a</span> <span class="k">in</span>

  <span class="kd">let</span> <span class="n">ack</span> <span class="o">=</span> <span class="nc">Ack</span> <span class="o">{</span><span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
  <span class="kd">let</span><span class="o">*</span> <span class="n">ack_ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="o">(</span><span class="n">serialize</span> <span class="n">message_t</span> <span class="n">ack</span><span class="o">)</span> <span class="k">in</span>

  <span class="kd">let</span> <span class="n">ack_state</span> <span class="o">=</span> <span class="nc">SentAck</span> <span class="o">{</span><span class="n">alice</span><span class="o">;</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
  <span class="kd">let</span><span class="o">*</span> <span class="n">sess_id</span> <span class="o">=</span> <span class="n">start_new_session</span> <span class="n">bob</span> <span class="n">ack_state</span> <span class="k">in</span>

  <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="o">(</span><span class="n">sess_id</span><span class="o">,</span> <span class="n">ack_ts</span><span class="o">))</span>
</pre></div>
</div>
</section>
</section>
<section id="the-third-step-receiving-an-ack">
<h4>The third step: Receiving an Ack<a class="headerlink" href="#the-third-step-receiving-an-ack" title="Link to this heading"></a></h4>
<p>In the final protocol step,
Alice receives an Acknowledgment from Bob
and checks whether she previously started a run with Bob
and the nonce received in the Ack.
If this is the case,
she stores that this run is now completed.</p>
<section id="id8">
<h5>The Type<a class="headerlink" href="#id8" title="Link to this heading"></a></h5>
<p>This step reads the Ack message from the trace
and looks for a previous state of Alice on the trace
and updates that state.
The step is thus a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function.
As in the previous step,
reading (and parsing) the Ack message may fail
as well as finding a previous state of Alice.
We thus have a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function.</p>
<p>The input arguments are the name of the acting participant,
i.e., Alice and the timestamp of the acknowledgment.</p>
<p>The return value is the session ID of the session
that Alice now considers as completed.</p>
<p>The type is:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">receive_ack</span><span class="o">:</span>
  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">ack_ts</span><span class="o">:</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="n">state_id</span><span class="o">)</span>
</pre></div>
</div>
</section>
<section id="receiving-the-ack">
<h5>Receiving the Ack<a class="headerlink" href="#receiving-the-ack" title="Link to this heading"></a></h5>
<p>Receiving and parsing of the Ack
is the same as for the Ping message in the previous step.</p>
<p>We first call the <code class="docutils literal notranslate"><span class="pre">recv_msg</span></code> function with the provided timestamp of the Ack.
Recall, this is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> action
that might fail, if the trace entry at this timestamp
is not a message entry.
We thus have to use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code></p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">recv_msg</span> <span class="n">ack_ts</span> <span class="k">in</span>
</pre></div>
</div>
<p>If this action is successful,
we now have the Ack in the wire format.
To translate it to our abstract format,
we call <code class="docutils literal notranslate"><span class="pre">parse</span></code>. Since this is an <code class="docutils literal notranslate"><span class="pre">option</span></code> action
inside a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> function,
we need to wrap the call in a <code class="docutils literal notranslate"><span class="pre">return</span></code> and use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">return</span> <span class="o">(</span><span class="n">parse</span> <span class="n">message_t</span> <span class="n">msg</span><span class="o">)</span> <span class="k">in</span>
</pre></div>
</div>
<p>If this action is successful,
we have the abstract message that was on the trace
at the provided timestamp.
We now need to check that this message
is indeed an Ack.
For this we use again the <code class="docutils literal notranslate"><span class="pre">guard_tr</span></code> function:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">guard_tr</span> <span class="o">(</span><span class="nc">Ack</span><span class="o">?</span> <span class="n">ack</span><span class="o">);*?</span>
</pre></div>
</div>
<p>Reading the Ack from the trace was successful
and we can now access the data with</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nc">Ack</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">ack</span> <span class="k">in</span>
<span class="kd">let</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">ack</span><span class="o">.</span><span class="n">n_a</span> <span class="k">in</span>
</pre></div>
</div>
<p>Note again, that the first line just removes the <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">Ack</span></code> constructor
to then access the <code class="docutils literal notranslate"><span class="pre">n_a</span></code> record field of the <code class="docutils literal notranslate"><span class="pre">ack_t</span></code> type.</p>
</section>
<section id="searching-a-previous-state">
<h5>Searching a previous state<a class="headerlink" href="#searching-a-previous-state" title="Link to this heading"></a></h5>
<p>At this point,
Alice received a nonce <span class="math notranslate nohighlight">\(n_A\)</span> as an acknowledgment.
She now wants to check, whether she actually
started a run with this nonce.</p>
<p>That is,
we are looking for a previous state of Alice
that is a <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">SentPing</span></code> state and contains the same nonce
<span class="math notranslate nohighlight">\(n_A\)</span>.</p>
<p>For this, we use the <code class="docutils literal notranslate"><span class="pre">lookup_state</span></code> function
from <code class="docutils literal notranslate"><span class="pre">DY.Extend</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="o">(</span><span class="n">sid</span><span class="o">,</span> <span class="n">st</span><span class="o">)</span> <span class="o">=</span> <span class="n">lookup_state</span> <span class="o">#</span><span class="n">state_t</span> <span class="n">alice</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">st</span> <span class="o">-&gt;</span>
         <span class="nc">SentPing</span><span class="o">?</span> <span class="n">st</span>
     <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nc">SentPing</span><span class="o">?.</span><span class="n">ping</span> <span class="n">st</span><span class="o">).</span><span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span>
  <span class="o">)</span> <span class="k">in</span>
</pre></div>
</div>
<p>This function takes three arguments:</p>
<ul>
<li><p>the implicit abstract state type (here <code class="docutils literal notranslate"><span class="pre">state_t</span></code>)</p></li>
<li><p>the participant for which we want to find a state (here <code class="docutils literal notranslate"><span class="pre">alice</span></code>)</p></li>
<li><p>a property of an abstract state <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">propt</span><span class="o">:</span> <span class="n">state_t</span> <span class="o">-&gt;</span> <span class="kt">bool</span></code></p>
<p>Here the property checks that
the state is a <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">SentPing</span></code> state
and the stored nonce in the state is the same as the received nonce <span class="math notranslate nohighlight">\(n_A\)</span>
from the Ack message.</p>
</li>
</ul>
<p>The lookup function returns the
session ID of the found state and
the content, i.e. the abstract state.
The action may fail,
if there is no state of the principal satisfying the property.</p>
<div class="toggle-header docutils container">
<p><strong>Discussion: How lookup works</strong></p>
</div>
<div class="toggle-content box docutils container">
<p>The <code class="docutils literal notranslate"><span class="pre">lookup_state</span></code> function
looks for the first state entry on the trace
(starting from the back/most recent time)
that satisfies the property.
It does <em>not</em> check that this state entry
is the most recent one in the session.
I.e., it could be the case,
that the returned state is not the current state
of the principal.
In our case here that means,
that we do not check whether Alice already completed the run before.</p>
<p>For the examples in this tutorial,
this implementation of the lookup function
is sufficient.
A future feature in DY*
will change the behavior of the lookup
to include the check to look only at the
most recent states of sessions.</p>
</div>
<div class="toggle-header docutils container">
<p><strong>Discussion: Why use lookup?</strong></p>
</div>
<div class="toggle-content box docutils container">
<p>From the analysis of cryptographic protocols
you may be used to the attacker
specifying the concrete session in
follow-up steps.
In our example, we could have added an
additional argument to the <code class="docutils literal notranslate"><span class="pre">receive_ack</span></code> step
for the session that Alice should be in.
I.e., she would check whether the received nonce
corresponds to the nonce stored in that
specific session and then finish this session.</p>
<p>Instead, we use the state lookup function here
which is closer to how web servers work.
They look at the content of received messages
and try to find the corresponding session from that.
For example by looking at some session ID provided in the message.</p>
<p>Both models cover a range of session mixup attacks.
If the attacker can provide the session,
he can inject data in possibly unrelated sessions.
With the lookup, we also get session mixup
since the key we use for lookup might not be unique across sessions.</p>
<p>Both models can be implemented in DY*.</p>
</div>
<p>Now that we have the previous state of Alice,
we can access the fields and see who was the other participant of that run</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">bob</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SentPing</span><span class="o">?.</span><span class="n">ping</span> <span class="n">st</span><span class="o">).</span><span class="n">bob</span> <span class="k">in</span>
</pre></div>
</div>
<p>Unfortunately,
this does not work immediately as we would expect.
We need to use another <code class="docutils literal notranslate"><span class="pre">guard_tr</span></code> first.</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">guard_tr</span> <span class="o">(</span><span class="nc">SentPing</span><span class="o">?</span> <span class="n">st</span><span class="o">);*?</span>
</pre></div>
</div>
<p>This guard should always be satisfied,
since the lookup function returns a state
satisfying the property,
which already includes that the state is
a <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">SentPing</span></code> state.
So it doesn’t change the function,
but it is needed for a technical reason
for DY* to argue that the found state is a <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">SentPing</span></code> state.</p>
<div class="toggle-header docutils container">
<p><strong>The technical reason</strong></p>
</div>
<div class="toggle-content box docutils container">
<p>In the bind of the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad,
the second action can’t make use of the fact,
that it is executed only if the first action was successful.
It turns out to be technically very difficult
to express this behavior for the second action
in the type definition of the bind.</p>
</div>
<p>We have now found that Alice previously
started a run with the nonce received in the Ack.</p>
</section>
<section id="setting-the-new-state">
<h5>Setting the new state<a class="headerlink" href="#setting-the-new-state" title="Link to this heading"></a></h5>
<p>The next action is finishing the run.
We do this by updating the previous session of Alice
to a <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">ReceivedAck</span></code> state.</p>
<p>Recall from the introduction of <a class="reference internal" href="introduction.html#sec-intro-states"><span class="std std-ref">States</span></a>
and <a class="reference internal" href="introduction.html#sec-intro-trace"><span class="std std-ref">The Global Trace</span></a>
that a (full) state of a principal consists of several sessions
and that state entries on the trace contain only a single
state and not a complete session or full state of a principal.
The content of a state are stored together
with the name of the principal
and the session ID on the trace.
We may have several state entries for the same principal and session ID.
In this case the intended meaning is,
that the most recent of those entries is the current state
of this session.</p>
<p>Updating the state of a session,
is thus just adding a new state entry to the trace
with the new content
for the same principal and session ID.
This can be done with the <code class="docutils literal notranslate"><span class="pre">set_state</span></code> function:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">set_state</span> <span class="n">alice</span> <span class="n">sid</span> <span class="o">(</span><span class="nc">ReceivedAck</span> <span class="o">{</span><span class="n">bob</span><span class="o">;</span> <span class="n">n_a</span><span class="o">});*</span>
</pre></div>
</div>
<p>It is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action that does not fail,
it takes as arguments the principal (<code class="docutils literal notranslate"><span class="pre">alice</span></code>),
the session ID (<code class="docutils literal notranslate"><span class="pre">sid</span></code>)
and the content of the state in its abstract format (the <code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">ReceivedAck</span></code> state)</p>
</section>
<section id="id9">
<h5>Returning<a class="headerlink" href="#id9" title="Link to this heading"></a></h5>
<p>The protocol step returns the session ID
of the session of Alice that has now finished.</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">sid</span><span class="o">)</span>
</pre></div>
</div>
</section>
<section id="id10">
<h5>Summary<a class="headerlink" href="#id10" title="Link to this heading"></a></h5>
<p>The final protocol step looks like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">receive_ack</span><span class="o">:</span>
  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">ack_ts</span><span class="o">:</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="n">state_id</span><span class="o">)</span>
<span class="kd">let</span> <span class="n">receive_ack</span> <span class="n">alice</span> <span class="n">ack_ts</span> <span class="o">=</span>
  <span class="kd">let</span><span class="o">*?</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">recv_msg</span> <span class="n">ack_ts</span> <span class="k">in</span>
  <span class="kd">let</span><span class="o">*?</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">return</span> <span class="o">(</span><span class="n">parse</span> <span class="n">message_t</span> <span class="n">ack</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">guard_tr</span> <span class="o">(</span><span class="nc">Ack</span><span class="o">?</span> <span class="n">ack</span><span class="o">);*?</span>

  <span class="kd">let</span> <span class="nc">Ack</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">ack</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">ack</span><span class="o">.</span><span class="n">n_a</span> <span class="k">in</span>

  <span class="kd">let</span><span class="o">*?</span> <span class="o">(</span><span class="n">sid</span><span class="o">,</span> <span class="n">st</span><span class="o">)</span> <span class="o">=</span> <span class="n">lookup_state</span> <span class="o">#</span><span class="n">state_t</span> <span class="n">alice</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">st</span> <span class="o">-&gt;</span>
          <span class="nc">SentPing</span><span class="o">?</span> <span class="n">st</span>
      <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nc">SentPing</span><span class="o">?.</span><span class="n">ping</span> <span class="n">st</span><span class="o">).</span><span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span>
    <span class="o">)</span> <span class="k">in</span>
  <span class="n">guard_tr</span><span class="o">(</span><span class="nc">SentPing</span><span class="o">?</span> <span class="n">st</span><span class="o">);*?</span>
  <span class="kd">let</span> <span class="n">bob</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SentPing</span><span class="o">?.</span><span class="n">ping</span> <span class="n">st</span><span class="o">).</span><span class="n">bob</span> <span class="k">in</span>

  <span class="n">set_state</span> <span class="n">alice</span> <span class="n">sid</span> <span class="o">(</span><span class="nc">ReceivedAck</span> <span class="o">{</span><span class="n">bob</span><span class="o">;</span> <span class="n">n_a</span><span class="o">});*</span>

  <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">sid</span><span class="o">)</span>
</pre></div>
</div>
<p>This concludes the model of the  Two-message protocol.
We defined the abstract message and state types in
<code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Data</span></code> and the three protocol steps
as functions in <code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Protocol</span></code>.</p>
<p>You should be able to run <code class="docutils literal notranslate"><span class="pre">make</span></code> now in the example folder.</p>
</section>
</section>
</section>
<section id="an-example-protocol-run">
<span id="sec-ex-run-two-message-implementation"></span><h3>An Example Protocol Run<a class="headerlink" href="#an-example-protocol-run" title="Link to this heading"></a></h3>
<p>Now that we have our model of the Two-Message protocol,
we need to check that we modeled the right behavior.
We do this by implementing an example run of the protocol
using the protocol functions from the model.
We can then print the trace after this run and see
whether the run finishes successfully
and whether the trace looks as we expect.</p>
<p>Recall from <a class="reference internal" href="introduction.html#ex-run-two-messagep"><span class="std std-ref">before</span></a>
that the trace after one successful run of the Two-Message protocol
should look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1. Generate nonce n_A
2. Message: Ping (Alice, n_A)
3. Session 0 of Alice: SentPing n_A to Bob
4. Message: Ack n_A
5. Session 0 of Bob: SentAck n_A to Alice
6. Session 0 of Alice: ReceivedAck n_A from Bob
</pre></div>
</div>
<section id="id11">
<h4>Setup<a class="headerlink" href="#id11" title="Link to this heading"></a></h4>
<p>We implement the example run in a new module <code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Run</span></code>
in the same <code class="docutils literal notranslate"><span class="pre">TwoMessageP</span></code> folder.
We begin the module with the usual imports of the DY* libraries
and of course our protocol model:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Lib</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Simplified</span>

<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">TwoMessage</span><span class="p">.</span><span class="nc">Protocol</span>
</pre></div>
</div>
<p>As a second setup,
we add a new target to our <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>
so that we can execute the extracted code and print the trace.
Add the following at the end of the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> in the <code class="docutils literal notranslate"><span class="pre">TwoMessageP</span></code> folder:</p>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="nf">test</span><span class="o">:</span>
<span class="w">     </span><span class="nb">cd</span><span class="w"> </span><span class="k">$(</span>TUTORIAL_HOME<span class="k">)</span>/obj<span class="p">;</span><span class="w"> </span><span class="k">$(</span>FSTAR_EXE<span class="k">)</span><span class="w"> </span>--ocamlenv<span class="w"> </span>ocamlbuild<span class="w"> </span>-use-ocamlfind<span class="w"> </span>-pkg<span class="w"> </span>batteries<span class="w"> </span>-pkg<span class="w"> </span>fstar.lib<span class="w"> </span>DY_TwoMessage_Run.native
<span class="w">     </span><span class="k">$(</span>TUTORIAL_HOME<span class="k">)</span>/obj/DY_TwoMessage_Run.native
</pre></div>
</div>
<p>If you now run <code class="docutils literal notranslate"><span class="pre">make</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>,
the second command should produce some warnings on the terminal
and end with the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Finished, 4 targets (0 cached) in 00:00:00.
../../obj/DY_TwoMessage_Run.native
</pre></div>
</div>
<p>You are now set up to start implementing the example protocol run
in the new <code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Run</span></code> module.
This will consist of three parts:</p>
<ol class="arabic simple">
<li><p>Calling the protocol steps.</p></li>
<li><p>Printing the trace after the run.</p></li>
<li><p>Executing the example run.</p></li>
</ol>
</section>
<section id="the-example-run">
<h4>The example run<a class="headerlink" href="#the-example-run" title="Link to this heading"></a></h4>
<p>The example run, will be a function where we call the
protocol steps in the expected order.
Since the individual steps are functions in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad,
our overall run function will also be in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad.
The run does not take any input arguments and does not return any value.
The type of the run function is thus</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">run</span><span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="kt">unit</span><span class="o">)</span>
</pre></div>
</div>
<p>The first step of the protocol is the <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> step.
This step takes as arguments the names of the two participants,
i.e., Alice and Bob.
Since we need these names later on again,
it is useful to define them in two variables:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">alice</span> <span class="o">=</span> <span class="s2">&quot;Alice&quot;</span> <span class="k">in</span>
<span class="kd">let</span> <span class="n">bob</span> <span class="o">=</span> <span class="s2">&quot;Bob&quot;</span> <span class="k">in</span>
</pre></div>
</div>
<p>We can now call the <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> step with <code class="docutils literal notranslate"><span class="pre">alice</span></code> and <code class="docutils literal notranslate"><span class="pre">bob</span></code>.
This is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> action that returns
the new session ID of Alice for this new run
and the timestamp of the Ping message on the trace.
For the second step, we need the timestamp of the Ping,
so we save the computed values of the <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> step
with <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="o">(</span><span class="n">alice_sid</span><span class="o">,</span> <span class="n">ping_ts</span><span class="o">)</span> <span class="o">=</span> <span class="n">send_ping</span> <span class="n">alice</span> <span class="n">bob</span> <span class="k">in</span>
</pre></div>
</div>
<p>The second protocol step (<code class="docutils literal notranslate"><span class="pre">receive_ping_and_send_ack</span></code>)
takes as arguments the name of Bob (i.e., the variable <code class="docutils literal notranslate"><span class="pre">bob</span></code>)
and the timestamp of the Ping
that the first step just computed (<code class="docutils literal notranslate"><span class="pre">ping_ts</span></code>).
The second step is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> action
and we want the overall run to fail,
if this step fails,
so we use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code> to store the computed values:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="o">(</span><span class="n">bob_sid</span><span class="o">,</span> <span class="n">ack_ts</span><span class="o">)</span> <span class="o">=</span> <span class="n">receive_ping_and_send_ack</span> <span class="n">bob</span> <span class="n">ping_ts</span> <span class="k">in</span>
</pre></div>
</div>
<p>The final step takes as argument the name of Alice
(stored in <code class="docutils literal notranslate"><span class="pre">alice</span></code>)
and the timestamp of the Ack.
This last step is also a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> action
and we want the run to fail, if this step fails.
Since we don’t want to continue our run after this step,
we don’t need to save the computed values and can just use:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">receive_ack</span> <span class="n">alice</span> <span class="n">ack_ts</span><span class="o">;*?</span>
</pre></div>
</div>
<p>This concludes the implementation of the example protocol run.
We called the protocol steps in the expected order,
passing on the arguments (in particular the message timestamps) from the previous steps.</p>
</section>
<section id="printing-the-trace">
<h4>Printing the Trace<a class="headerlink" href="#printing-the-trace" title="Link to this heading"></a></h4>
<p>Inside the <code class="docutils literal notranslate"><span class="pre">run</span></code> function,
we want to print the trace,
after the run.</p>
<p>Printing in F* works with <code class="code highlight fstar docutils literal highlight-fstar"><span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span></code> which takes
a string as argument that is then printed.
As you noticed before,
the <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> produced some lines of output, even though
we didn’t have any run yet.
It is thus useful,
to print some recognizable string before the actual output starts.
For example like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="s2">&quot;************* Trace *************</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>
</pre></div>
</div>
<p>To print the actual trace,
we use the <code class="docutils literal notranslate"><span class="pre">trace_to_string</span></code> function from <code class="docutils literal notranslate"><span class="pre">DY.Lib</span></code>.
This function takes two arguments:
some printer functions and the trace to be printed.
It returns a string.
For now, we can just use the default printers <code class="docutils literal notranslate"><span class="pre">default_trace_to_string_printers</span></code>.</p>
<p>But how do we get the trace after the example run?
There is the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function <code class="docutils literal notranslate"><span class="pre">get_trace</span></code> in <code class="docutils literal notranslate"><span class="pre">DY.Core</span></code>
that returns the current trace.
We can thus access the trace after the example run,
by calling <code class="docutils literal notranslate"><span class="pre">get_trace</span></code> after the calls to the protocol steps:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">get_trace</span> <span class="k">in</span>
</pre></div>
</div>
<p>Now that we have the trace,
we can call <code class="docutils literal notranslate"><span class="pre">trace_to_string</span></code>
and print the resulting string:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="o">(</span>
   <span class="n">trace_to_string</span> <span class="n">default_trace_to_string_printers</span> <span class="n">tr</span>
 <span class="o">)</span> <span class="k">in</span>
</pre></div>
</div>
<p>This concludes printing of the trace.</p>
<p>However, the <code class="docutils literal notranslate"><span class="pre">run</span></code> function has return type
<code class="docutils literal notranslate"><span class="pre">traceful</span> <span class="pre">(option</span> <span class="pre">unit)</span></code>,
so we need to return something in the end.
In our case,
we can just go with</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="bp">()</span><span class="o">)</span>
</pre></div>
</div>
<p>The overall <code class="docutils literal notranslate"><span class="pre">run</span></code> function looks like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">run</span><span class="o">:</span>
  <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="kt">unit</span><span class="o">)</span>
<span class="kd">let</span> <span class="n">run</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="kd">let</span> <span class="n">alice</span> <span class="o">=</span> <span class="s2">&quot;Alice&quot;</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">bob</span> <span class="o">=</span> <span class="s2">&quot;Bob&quot;</span> <span class="k">in</span>

  <span class="kd">let</span><span class="o">*</span> <span class="o">(</span><span class="n">alice_sid</span><span class="o">,</span> <span class="n">ping_ts</span><span class="o">)</span> <span class="o">=</span> <span class="n">send_ping</span> <span class="n">alice</span> <span class="n">bob</span> <span class="k">in</span>
  <span class="kd">let</span><span class="o">*?</span> <span class="o">(</span><span class="n">bob_sid</span><span class="o">,</span> <span class="n">ack_ts</span><span class="o">)</span> <span class="o">=</span>
    <span class="n">receive_ping_and_send_ack</span> <span class="n">bob</span> <span class="n">ping_ts</span> <span class="k">in</span>
  <span class="n">receive_ack</span> <span class="n">alice</span> <span class="n">ack_ts</span><span class="o">;*?</span>


  <span class="kd">let</span><span class="o">*</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">get_trace</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="s2">&quot;************* Trace *************</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="o">(</span>
    <span class="n">trace_to_string</span> <span class="n">default_trace_to_string_printers</span> <span class="n">tr</span>
    <span class="o">)</span> <span class="k">in</span>

  <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="bp">()</span><span class="o">)</span>
</pre></div>
</div>
<p>You can run <code class="docutils literal notranslate"><span class="pre">make</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> now.
But you will not see any output from the <code class="docutils literal notranslate"><span class="pre">run</span></code> function,
only some warnings and output from the extraction process.</p>
</section>
<section id="executing-the-run">
<h4>Executing the Run<a class="headerlink" href="#executing-the-run" title="Link to this heading"></a></h4>
<p>As a final step,
we need to call our <code class="docutils literal notranslate"><span class="pre">run</span></code> function,
when the module is executed.
We achieve this by adding</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run</span> <span class="bp">()</span> <span class="n">empty_trace</span>
</pre></div>
</div>
<p>at the end of the module.</p>
<p>If you run <code class="docutils literal notranslate"><span class="pre">make</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> now,
you will see the <code class="docutils literal notranslate"><span class="pre">***</span> <span class="pre">Trace</span> <span class="pre">***</span></code> string
followed by the trace after the run.
The trace should look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{&quot;TraceID&quot;: 0, &quot;Type&quot;: &quot;Nonce&quot;, &quot;Usage&quot;: {&quot;Type&quot;: &quot;NoUsage&quot;}}
{&quot;TraceID&quot;: 1, &quot;Type&quot;: &quot;Message&quot;, &quot;Content&quot;: &quot;[Alice, [Nonce #0,]]&quot;}
{&quot;TraceID&quot;: 2, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;TwoMessage.State&quot;, &quot;Content&quot;: &quot;[Bob, [Nonce #0,]]&quot;}
{&quot;TraceID&quot;: 3, &quot;Type&quot;: &quot;Message&quot;, &quot;Content&quot;: &quot; [Nonce #0,]&quot;}
{&quot;TraceID&quot;: 4, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;TwoMessage.State&quot;, &quot;Content&quot;: &quot;[Alice, [Nonce #0,]]&quot;}
{&quot;TraceID&quot;: 5, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;TwoMessage.State&quot;, &quot;Content&quot;: &quot;[Bob, [Nonce #0,]]&quot;}
</pre></div>
</div>
</section>
<section id="pretty-printing">
<h4>Pretty Printing<a class="headerlink" href="#pretty-printing" title="Link to this heading"></a></h4>
<p>We can print the content of the trace entries nicer,
by defining our own printer functions for our
message and state types.
Download the <code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Run.Printing.fst</span></code> file from the <a class="reference external" href="https://github.com/REPROSEC/dolev-yao-star-tutorial-code/blob/main/examples/TwoMessageP/DY.TwoMessage.Run.Printing.fst">Tutorial Repo on GitHub</a>.
Import the module in the <code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Run</span></code> module
and change the default printers to <code class="docutils literal notranslate"><span class="pre">get_trace_to_string_printers</span></code>.</p>
<p>The printing should now look like:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="o">(</span>
   <span class="n">trace_to_string</span> <span class="n">get_trace_to_string_printers</span> <span class="n">tr</span>
 <span class="o">)</span> <span class="k">in</span>
</pre></div>
</div>
<p>Run <code class="docutils literal notranslate"><span class="pre">make</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> again.
The trace should now look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{&quot;TraceID&quot;: 0, &quot;Type&quot;: &quot;Nonce&quot;, &quot;Usage&quot;: {&quot;Type&quot;: &quot;NoUsage&quot;}}
{&quot;TraceID&quot;: 1, &quot;Type&quot;: &quot;Message&quot;, &quot;Content&quot;: &quot;Ping [name = (Nonce #0), n_a = (Alice)]&quot;}
{&quot;TraceID&quot;: 2, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;TwoMessage.State&quot;, &quot;Content&quot;: &quot;SentPing [n_a = (Nonce #0), to = (Bob)]&quot;}
{&quot;TraceID&quot;: 3, &quot;Type&quot;: &quot;Message&quot;, &quot;Content&quot;: &quot;Ack [n_a = (Nonce #0)]&quot;}
{&quot;TraceID&quot;: 4, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;TwoMessage.State&quot;, &quot;Content&quot;: &quot;SentAck [n_a = (Nonce #0), to = (Alice)]&quot;}
{&quot;TraceID&quot;: 5, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;TwoMessage.State&quot;, &quot;Content&quot;: &quot;ReceivedAck [n_a = (Nonce #0), from = (Bob)]&quot;}
</pre></div>
</div>
<p>Which is much closer to our <a class="reference internal" href="introduction.html#ex-run-two-messagep"><span class="std std-ref">previous</span></a> intuitive description of the trace.</p>
</section>
</section>
</section>
<section id="how-to-modelling-a-protocol-in-dy">
<h2>How To: Modelling a Protocol in DY*<a class="headerlink" href="#how-to-modelling-a-protocol-in-dy" title="Link to this heading"></a></h2>
<p>Before we continue to model the next protocol,
let’s summarize how we build a model of a protocol in DY*
using our model of the Two-Message protocol as an example.</p>
<div class="admonition remember" id="howto-modelling-protocols">
<p class="admonition-title">How-To: Modelling a Protocol in DY*</p>
<p><em>Technical Setup:</em></p>
<ul>
<li><p>create a new folder</p></li>
<li><div class="toggle-header docutils container">
<p>add a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">TUTORIAL_HOME</span><span class="w"> </span><span class="o">?=</span><span class="w"> </span>../..

<span class="nv">EXAMPLE_DIRS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>path_to/TwoMessageP

<span class="cp">include $(TUTORIAL_HOME)/Makefile</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p>create two modules: <code class="docutils literal notranslate"><span class="pre">Data.fst</span></code> and <code class="docutils literal notranslate"><span class="pre">Protocol.fst</span></code></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">TwoMessage</span><span class="p">.</span><span class="nc">Data</span>

<span class="k">open</span> <span class="nc">Comparse</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Lib</span>
</pre></div>
</div>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">TwoMessage</span><span class="p">.</span><span class="nc">Protocol</span>

<span class="k">open</span> <span class="nc">Comparse</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Lib</span>

<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Simplified</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Extend</span>

<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">TwoMessage</span><span class="p">.</span><span class="nc">Data</span>
</pre></div>
</div>
</div>
</li>
</ul>
<p><em>Define abstract message and state formats:</em></p>
<ul>
<li><p>The abstract formats for messages and states go into the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module.</p></li>
<li><div class="toggle-header docutils container">
<p>For each message and state in the protocol,
define its own type as a record.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">ping_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">type</span> <span class="n">ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">sent_ping_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">bob</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">type</span> <span class="n">sent_ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">type</span> <span class="n">received_ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">bob</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p>Collect the individual record types for messages and states in an overall type <code class="docutils literal notranslate"><span class="pre">message_t</span></code> and <code class="docutils literal notranslate"><span class="pre">state_t</span></code>
using constructors for each of the cases.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">message_t</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Ping</span><span class="o">:</span> <span class="o">(</span><span class="n">ping</span><span class="o">:</span><span class="n">ping_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">message_t</span>
  <span class="o">|</span> <span class="nc">Ack</span><span class="o">:</span>  <span class="o">(</span><span class="n">ack</span><span class="o">:</span><span class="n">ack_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">message_t</span>
</pre></div>
</div>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">state_t</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">SentPing</span><span class="o">:</span> <span class="o">(</span><span class="n">ping</span><span class="o">:</span><span class="n">sent_ping_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">state_t</span>
  <span class="o">|</span> <span class="nc">SentAck</span><span class="o">:</span> <span class="o">(</span><span class="n">ack</span><span class="o">:</span><span class="n">sent_ack_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">state_t</span>
  <span class="o">|</span> <span class="nc">ReceivedAck</span><span class="o">:</span> <span class="o">(</span><span class="n">rack</span><span class="o">:</span><span class="n">received_ack_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">state_t</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p>Use Comparse to generate a parser and serializer for the types, with
<code class="code highlight fstar docutils literal highlight-fstar"><span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_name_of_type</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">name_of_type</span><span class="o">))</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span></code> annotations.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_ping_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ping_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_ack_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ack_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_message_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">message_t</span><span class="o">))</span>
</pre></div>
</div>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span>
<span class="k">type</span> <span class="n">ping_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p>Define <code class="docutils literal notranslate"><span class="pre">parseable_serializable</span></code> instances for <code class="docutils literal notranslate"><span class="pre">message_t</span></code> and <code class="docutils literal notranslate"><span class="pre">state_t</span></code>.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="n">parseable_serializeable_bytes_message_t</span><span class="o">:</span> <span class="n">parseable_serializeable</span> <span class="n">bytes</span> <span class="n">message_t</span> <span class="o">=</span>
  <span class="n">mk_parseable_serializeable</span> <span class="n">ps_message_t</span>
</pre></div>
</div>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="n">parseable_serializeable_bytes_state_t</span><span class="o">:</span> <span class="n">parseable_serializeable</span> <span class="n">bytes</span> <span class="n">state_t</span> <span class="o">=</span>
  <span class="n">mk_parseable_serializeable</span> <span class="n">ps_state_t</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p>Define <code class="docutils literal notranslate"><span class="pre">local_state</span></code> instance for <code class="docutils literal notranslate"><span class="pre">state_t</span></code>.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="n">local_state_state</span><span class="o">:</span> <span class="n">local_state</span> <span class="n">state_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;P.State&quot;</span><span class="o">;</span>
  <span class="n">format</span> <span class="o">=</span> <span class="n">parseable_serializeable_bytes_state_t</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</li>
</ul>
<p><em>Implement the protocol steps:</em></p>
<ul>
<li><p>The protocol steps go into the <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> module.</p></li>
<li><p>For each step think about the <em>type</em> first:</p>
<ul class="simple">
<li><p>The <em>monad</em>:</p>
<ul>
<li><p>Every step will be in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> monad, since it works with the trace.</p></li>
<li><p>The step is in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad,
if it may fail.
(For example when reading a message from the trace,
parsing a message to an expected format, looking up a particular state, etc.)</p></li>
<li><p>Most steps will probably be in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad.
(A typical exception is the very first step of the protocol.)</p></li>
</ul>
</li>
<li><p>Typical <em>input arguments</em> are:</p>
<ul>
<li><p>the active participant in this step (of type <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">principal</span></code>)</p></li>
<li><p>the timestamp of the message that is received in this step (of type <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">timestamp</span></code>)</p></li>
<li><p>the session IDs of the state of the active participant,
where private and public keys are stored (of type <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">state_id</span></code>)</p></li>
</ul>
</li>
<li><p>Typical <em>return values</em> are:</p>
<ul>
<li><p>the timestamp of the message sent in this step (of type <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">timestamp</span></code>)</p></li>
<li><p>the session ID of the active participant that has been used or updated in this step (of type <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">state_id</span></code>)</p></li>
<li><p>The verly last step of the protocol usually doesn’t have any return values and hence has return type <code class="code highlight fstar docutils literal highlight-fstar"><span class="kt">unit</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>The general structure of one protocol step is:</p>
<ol class="arabic">
<li><p>Receiving the message:</p>
<ol class="arabic">
<li><div class="toggle-header docutils container">
<p><em>receive</em> the message at the provided timestamp</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">recv_msg</span> <span class="n">msg_ts</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p><em>decrypt</em> the message</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">plaintext</span> <span class="o">=</span> <span class="n">pke_dec_with_key_lookup</span> <span class="o">#</span><span class="n">message_t</span> <span class="n">alice</span> <span class="n">keys_sid</span> <span class="n">key_tag</span> <span class="n">cipher</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p><em>parse</em> the message to the abstract format</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">abstract_msg</span> <span class="o">=</span> <span class="n">return</span> <span class="o">(</span><span class="n">parse</span> <span class="n">message_t</span> <span class="n">msg</span><span class="o">)</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p><em>check</em> that the message is of the <em>expected format</em> for the step</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">guard_tr</span> <span class="o">(</span><span class="nc">Ping</span><span class="o">?</span> <span class="n">asbtract_msg</span><span class="o">);*?</span>
</pre></div>
</div>
</div>
</li>
</ol>
</li>
<li><div class="toggle-header docutils container">
<p><em>Find</em> the <em>session</em> of the active participant corresponding to the received message.
This includes checks of the received data and the stored data.</p>
</div>
<div class="toggle-content docutils container">
<blockquote>
<div><div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="o">(</span><span class="n">st</span><span class="o">,</span> <span class="n">sid</span><span class="o">)</span> <span class="o">=</span> <span class="n">lookup_state</span> <span class="o">#</span><span class="n">state_t</span> <span class="n">alice</span> <span class="n">some_property</span> <span class="k">in</span>
</pre></div>
</div>
</div></blockquote>
</div>
</li>
<li><p>Generate the next message (the reply):</p>
<ol class="arabic">
<li><p>compute the <em>abstract</em> reply</p></li>
<li><div class="toggle-header docutils container">
<p><em>serialize</em> the reply</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">wire_msg</span> <span class="o">=</span> <span class="n">serialize</span> <span class="o">#</span><span class="n">bytes</span> <span class="n">message_t</span> <span class="n">abstract_msg</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p><em>encrypt</em> the reply</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">cipher</span> <span class="o">=</span> <span class="n">pke_enc_for</span> <span class="n">alice</span> <span class="n">bob</span> <span class="n">key_sid</span> <span class="n">key_tag</span> <span class="n">plaintext</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p><em>send</em> the reply</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">reply_ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="n">ciper</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
</ol>
</li>
<li><div class="toggle-header docutils container">
<p><em>Update</em> the corresponding <em>session</em></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">set_state</span> <span class="n">alice</span> <span class="n">sid</span> <span class="n">abstract_state</span><span class="o">;*</span>
</pre></div>
</div>
</div>
</li>
<li><p><em>Return</em> the message timestamp from Step 3.4. and the session ID updated in Step 4.</p></li>
</ol>
</li>
</ul>
<p><em>Check the model with an example run:</em></p>
<p>After implementing the protocol steps,
you should check that they model the protocol in the correct way.
I.e., call the steps in the right order of an example run of the protocol
and closely look at the produced trace:</p>
<ul>
<li><div class="toggle-header docutils container">
<p>In a <code class="docutils literal notranslate"><span class="pre">Run</span></code> module,</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">TwoMessage</span><span class="p">.</span><span class="nc">Run</span>

<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Lib</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Simplified</span>

<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">TwoMessage</span><span class="p">.</span><span class="nc">Protocol</span>
</pre></div>
</div>
</div>
<ul>
<li><p>define a <code class="docutils literal notranslate"><span class="pre">run</span></code> function where you</p>
<ul>
<li><div class="toggle-header docutils container">
<p>call the protocol steps in the order of an example run of the protocol,
passing on arguments (message timestamps, session IDs) as needed.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">run</span><span class="o">:</span>
  <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="kt">unit</span><span class="o">)</span>
<span class="kd">let</span> <span class="n">run</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="kd">let</span> <span class="n">alice</span> <span class="o">=</span> <span class="s2">&quot;Alice&quot;</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">bob</span> <span class="o">=</span> <span class="s2">&quot;Bob&quot;</span> <span class="k">in</span>

  <span class="kd">let</span><span class="o">*</span> <span class="o">(</span><span class="n">alice_sid</span><span class="o">,</span> <span class="n">ping_ts</span><span class="o">)</span> <span class="o">=</span> <span class="n">send_ping</span> <span class="n">alice</span> <span class="n">bob</span> <span class="k">in</span>
  <span class="kd">let</span><span class="o">*?</span> <span class="o">(</span><span class="n">bob_sid</span><span class="o">,</span> <span class="n">ack_ts</span><span class="o">)</span> <span class="o">=</span>
    <span class="n">receive_ping_and_send_ack</span> <span class="n">bob</span> <span class="n">ping_ts</span> <span class="k">in</span>
  <span class="n">receive_ack</span> <span class="n">alice</span> <span class="n">ack_ts</span><span class="o">;*?</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p>access the trace after the run with <code class="docutils literal notranslate"><span class="pre">get_trace</span></code></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">get_trace</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p>print the trace with <code class="code highlight fstar docutils literal highlight-fstar"><span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span></code> using <code class="docutils literal notranslate"><span class="pre">trace_to_string</span></code> with
either <code class="docutils literal notranslate"><span class="pre">default_trace_to_string_printers</span></code> or a custom <code class="docutils literal notranslate"><span class="pre">get_trace_to_string_printers</span></code> for pretty printing.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="s2">&quot;************* Trace *************</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>
<span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="o">(</span>
   <span class="n">trace_to_string</span> <span class="n">default_trace_to_string_printers</span> <span class="n">tr</span>
 <span class="o">)</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
</ul>
</li>
<li><div class="toggle-header docutils container">
<p>call the <code class="docutils literal notranslate"><span class="pre">run</span></code> function on the empty trace when executing the module</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run</span> <span class="bp">()</span> <span class="n">empty_trace</span>
</pre></div>
</div>
</div>
</li>
</ul>
</li>
<li><div class="toggle-header docutils container">
<p>Add the <code class="docutils literal notranslate"><span class="pre">test</span></code> target to the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="nf">test</span><span class="o">:</span>
<span class="w">  </span><span class="nb">cd</span><span class="w"> </span><span class="k">$(</span>TUTORIAL_HOME<span class="k">)</span>/obj<span class="p">;</span><span class="w"> </span><span class="k">$(</span>FSTAR_EXE<span class="k">)</span><span class="w"> </span>--ocamlenv<span class="w"> </span>ocamlbuild<span class="w"> </span>-use-ocamlfind<span class="w"> </span>-pkg<span class="w"> </span>batteries<span class="w"> </span>-pkg<span class="w"> </span>fstar.lib<span class="w"> </span>DY_TwoMessage_Run.native
<span class="w">  </span><span class="k">$(</span>TUTORIAL_HOME<span class="k">)</span>/obj/DY_TwoMessage_Run.native
</pre></div>
</div>
</div>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>.</p></li>
<li><p>Look at the output and check:</p>
<ul class="simple">
<li><p>Did the example run succeed? I.e., do you see any output after the <code class="docutils literal notranslate"><span class="pre">***Trace***</span></code> string?
(If not, move <code class="docutils literal notranslate"><span class="pre">get_trace</span></code> and <code class="code highlight fstar docutils literal highlight-fstar"><span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span></code> around until you find the step that is failing.)</p></li>
<li><p>Does the trace look like expected? Do all entries appear with the right values?</p></li>
</ul>
</li>
</ul>
</div>
</section>
<section id="a-model-of-the-online-protocol">
<h2>A Model of the Online? Protocol<a class="headerlink" href="#a-model-of-the-online-protocol" title="Link to this heading"></a></h2>
<p>Let us now turn to the Online? protocol and implement a protocol model in DY*.
The only difference to the Two-Message protocol is
that the messages are <em>encrypted</em> for the respective participants.
So the model of the Online? protocol will be very similar
to the previous one of the Two-Message protocol,
and we will here focus on the new differences.</p>
<p>First, we discuss how encryption is modelled in DY*.</p>
<section id="public-key-encryption-in-dy">
<h3>Public Key Encryption in DY*<a class="headerlink" href="#public-key-encryption-in-dy" title="Link to this heading"></a></h3>
<section id="key-storage">
<span id="pke-key-storage-model"></span><h4>Key storage<a class="headerlink" href="#key-storage" title="Link to this heading"></a></h4>
<p>We don’t model a PKI in DY*,
instead we just assume that every participant
has some private decryption keys and
some public encryption keys associated with other principals
in her state.
To easily access the keys,
we collect all private keys in one session
and all public keys in another session.
We already saw this, when we first introduced states
and in particular <a class="reference internal" href="introduction.html#ex-online-global-sessions-for-keys"><span class="std std-ref">sessions for global information</span></a>.
So states look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>State Alice:
  Session 0: collection of private decryption keys
  Session 1: collection of public encryption keys
  ...
</pre></div>
</div>
<p>A participant may have several private keys
for different purposes.
Think of a protocol with several sub-protocols.
For each of the sub-protocols there could be
a separate private key which is only used for this sub-protocol.
All of those keys are stored in the same session (Session 0 in the example above).
To use the correct keys in the protocol steps,
we need to store the information which key is used for which purpose.
We do this, by tagging the keys.
That is, the collection of private keys
is a dictionary with the dictionary key being a tag
and the values are the keys.
So Session 0 in the above example could look like the following
(using the notation <code class="docutils literal notranslate"><span class="pre">lookup_key</span> <span class="pre">=</span> <span class="pre">value</span></code>):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Session 0: {
    &quot;SubProt1&quot; = priv_key_for_sub_protocol_1
  , &quot;SubProt2&quot; = priv_key_for_sub_protocol_2
  , &quot;Other&quot; = priv_key_for_some_other_purpose
}
</pre></div>
</div>
<p>Similarly, a participant may have several public encryption keys
for different purposes.
Additionally, for public keys there are different keys for different
other participants.
For example, Alice could have two public keys
specific to one of the sub-protocols,
one for Bob and one for Charlie.
Hence, to identify the correct key for encryption,
we now use the tag together with the name of the other participant.
Thus, the collection of public keys
is a dictionary with the dictionary key
being the pair of a tag and a participant name.
So Session 1 from above could look like the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Session 1: {
    (&quot;SubProt1&quot;, Bob) = pub_key_for_Bob_for_sub_protocol_1
  , (&quot;SubProt1&quot;, Charlie) = pub_key_for_Charlie_for_sub_protocol_1
  , (&quot;SubProt2&quot;, Bob) = pub_key_for_Bob_for_sub_protocol_2
}
</pre></div>
</div>
<p>In the above examples,
we used Session 0 to store Alice’s private keys
and Session 1 for her public keys.
However, the sessions for the keys are not fixed
and can be allocated dynamically.
Usually this happens in a setup phase before any protocol run.</p>
<p>This setup is <em>not</em> part of the protocol <em>model</em> itself.
Just like protocol runs are not part of the protocol model,
but need to be implemented separately
(recall <a class="reference internal" href="#sec-ex-run-two-message-implementation"><span class="std std-ref">the example run for the Two-Message protocol</span></a>).
But since the protocol steps in the model
need to know where keys are stored
for de- and encryption,
we need to add these session IDs as additional arguments to the steps.
That is, for implementing a protocol step
in which you want to encrypt something,
you can assume that you get the session ID
of the state where public keys are stored
as an argument.
If you then want to implement an actual run of the protocol,
you need to generate those key sessions (and IDs) in a setup phase
and pass them on as arguments to the protocol steps in the run.
We will see how key setup works later,
when we implement an example run for the Online? protocol.</p>
<p>For now, it suffices to remember
that private and public keys are stored in separate sessions
at a principal
and that we use a tag to lookup a private key
and a tag participant pair to lookup a public key.
With this model of the key storage in mind,
we can now look at how encryption and decryption works in DY*.</p>
</section>
<section id="encryption">
<h4>Encryption<a class="headerlink" href="#encryption" title="Link to this heading"></a></h4>
<p>If Alice wants to encrypt some plaintext for Bob,
she needs to lookup Bob’s public key in her public keys session,
and use this key to encrypt the plaintext.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">DY.Simplified</span></code> there is a function <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> that does those steps.
It takes as arguments:</p>
<ul class="simple">
<li><p>the participant that does the encryption</p></li>
<li><p>the participant whose public key is used for encryption</p></li>
<li><p>the session ID where the active participant stores her known public keys</p></li>
<li><p>the tag of the key (used to lookup the right key in the public keys session)</p></li>
<li><p>the abstract message</p></li>
</ul>
<p>and returns the corresponding ciphertext in wire format.
The type is</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">pke_enc_for</span><span class="o">:</span>
  <span class="o">#</span><span class="n">a</span><span class="o">:</span><span class="nc">Type</span> <span class="o">-&gt;</span> <span class="o">{|</span> <span class="n">parseable_serializeable</span> <span class="n">bytes</span> <span class="n">a</span> <span class="o">|}</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="n">active</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">for</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="n">public_keys_sid</span><span class="o">:</span> <span class="n">state_id</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">key_tag</span><span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="n">abstract_msg</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">cipher</span><span class="o">:</span> <span class="n">bytes</span><span class="o">))</span>
</pre></div>
</div>
<p>The function fails if there is no key for the respective participant
with the given tag
stored in the given session of the active participant.</p>
<div class="admonition example" id="ex-pke-encryption">
<p class="admonition-title">Example: Encrypting an abstract message</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> function from <code class="docutils literal notranslate"><span class="pre">DY.Simplified</span></code> can be called like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">pke_enc_for</span> <span class="o">#</span><span class="n">message_t</span> <span class="n">alice</span> <span class="n">bob</span> <span class="n">alices_public_keys_sid</span> <span class="n">key_tag</span> <span class="o">(</span><span class="nc">Ping</span> <span class="o">{</span><span class="n">alice</span><span class="o">;</span> <span class="n">n_a</span><span class="o">})</span>
</pre></div>
</div>
<p>Where Alice wants to encrypt the abstract Ping for Bob
using <code class="docutils literal notranslate"><span class="pre">key_tag</span></code> as key to lookup the public key of Bob
in her session with the ID <code class="docutils literal notranslate"><span class="pre">alices_public_keys_sid</span></code>,
where she stores her known public keys.</p>
</div>
</section>
<section id="decryption">
<h4>Decryption<a class="headerlink" href="#decryption" title="Link to this heading"></a></h4>
<p>Decryption works very similar,
where the active participant now has to lookup her private key
in her private keys session.</p>
<p>Again, there is a function <code class="docutils literal notranslate"><span class="pre">pke_dec_with_key_lookup</span></code> in <code class="docutils literal notranslate"><span class="pre">DY.Simplified</span></code>
for decryption.
It takes as arguments:</p>
<ul class="simple">
<li><p>the active (decrypting) participant</p></li>
<li><p>the session ID, where the participant stores her private keys</p></li>
<li><p>the tag of the key (used to lookup the right key in the private keys session)</p></li>
<li><p>the ciphertext</p></li>
</ul>
<p>and returns the corresponding abstract plaintext.
The type is:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">pke_dec_with_key_lookup</span><span class="o">:</span>
  <span class="o">#</span><span class="n">a</span><span class="o">:</span><span class="nc">Type</span> <span class="o">-&gt;</span> <span class="o">{|</span> <span class="n">parseable_serializeable</span> <span class="n">bytes</span> <span class="n">a</span> <span class="o">|}</span> <span class="o">-&gt;</span>
  <span class="n">principal</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="n">private_keys_sid</span><span class="o">:</span> <span class="n">state_id</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">key_tag</span><span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="n">cipher</span><span class="o">:</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">abstract_plain</span><span class="o">:</span> <span class="n">a</span><span class="o">))</span>
</pre></div>
</div>
<p>The function may fail if one of the following is true:</p>
<ul class="simple">
<li><p>there is no key with the given tag in the given keys session</p></li>
<li><p>the ciphertext was not encrypted with the key
corresponding to the given tag in the given keys session</p></li>
<li><p>parsing of the decrypted plain text fails</p></li>
</ul>
<div class="admonition example" id="ex-pke-decryption">
<p class="admonition-title">Example: Decrypting a cipher text to an abstract message</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pke_dec_with_key_lookup</span></code> function from <code class="docutils literal notranslate"><span class="pre">DY.Simplified</span></code> can be called like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">pke_dec_with_key_lookup</span> <span class="o">#</span><span class="n">message_t</span> <span class="n">bob</span> <span class="n">bobs_private_keys_sid</span> <span class="n">key_tag</span> <span class="n">cipher</span>
</pre></div>
</div>
<p>Here Bob wants to decrypt the <code class="docutils literal notranslate"><span class="pre">cipher</span></code>
using the key with tag <code class="docutils literal notranslate"><span class="pre">key_tag</span></code> stored in his session with ID <code class="docutils literal notranslate"><span class="pre">bobs_private_keys_sid</span></code>.</p>
</div>
<div class="admonition remember">
<p class="admonition-title">Remember: Public Key Encryption in DY*</p>
<p><em>Key Storage</em>:</p>
<ul>
<li><div class="toggle-header docutils container">
<p>All private keys are stored in <em>one</em> session
as a dictionary with dictionary key being some tag.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>State Alice:
  Session 0: {
      &quot;SubProt1&quot; = priv_key_for_sub_protocol_1
    , &quot;SubProt2&quot; = priv_key_for_sub_protocol_2
    , &quot;Other&quot; = priv_key_for_some_other_purpose
  }
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p>All public keys are stored in <em>one</em> session
as a dictionary with the dictionary key being a tag together with the name of a participant.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>State Alice:
  Session 1: {
      (&quot;SubProt1&quot;, Bob) = pub_key_for_sub_protocol_1_for_Bob
    , (&quot;SubProt1&quot;, Charlie) = pub_key_for_sub_protocol_1_for_Charlie
    , (&quot;SubProt2&quot;, Bob) = pub_key_for_sub_protocol_2_for_Bob
  }
</pre></div>
</div>
</div>
</li>
<li><p>The session IDs of the key sessions
are generated in a setup phase outside of the protocol steps.
Thus, the protocol steps take them as an extra argument.</p></li>
</ul>
<p><em>Encryption</em>:</p>
<ul>
<li><div class="toggle-header docutils container">
<p>using <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> from <code class="docutils literal notranslate"><span class="pre">DY.Simplified</span></code></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">ping_encrypted</span> <span class="o">=</span> <span class="n">pke_enc_for</span> <span class="o">#</span><span class="n">message_t</span> <span class="n">alice</span> <span class="n">bob</span> <span class="n">alices_public_keys_sid</span> <span class="n">key_tag</span> <span class="o">(</span><span class="nc">Ping</span> <span class="o">{</span><span class="n">alice</span><span class="o">;</span> <span class="n">n_a</span><span class="o">})</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
<li><p>takes the abstract plain text and returns the cipher text in wire format (i.e., includes serializing)</p></li>
</ul>
<p><em>Decryption</em>:</p>
<ul>
<li><div class="toggle-header docutils container">
<p>using <code class="docutils literal notranslate"><span class="pre">pke_dec_with_key_lookup</span></code> from <code class="docutils literal notranslate"><span class="pre">DY.Simplified</span></code></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">ping_plain</span> <span class="o">=</span> <span class="n">pke_dec_with_key_lookup</span> <span class="o">#</span><span class="n">message_t</span> <span class="n">bob</span> <span class="n">bobs_private_keys_sid</span> <span class="n">key_tag</span> <span class="n">cipher</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
<li><p>takes the cipher text in wire format and returns the abstract plain text (i.e., includes parsing)</p></li>
</ul>
</div>
<p>With this, we can now implement the model of the Online? protocol.</p>
</section>
</section>
<section id="id12">
<h3>Setup<a class="headerlink" href="#id12" title="Link to this heading"></a></h3>
<p>As for the <a class="reference internal" href="#model-twomessage-setup"><span class="std std-ref">Two-Message protocol</span></a>,
create a new folder <code class="docutils literal notranslate"><span class="pre">Online</span></code> and add</p>
<ul>
<li><div class="toggle-header docutils container">
<p>a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">TUTORIAL_HOME</span><span class="w"> </span><span class="o">?=</span><span class="w"> </span>../..

<span class="nv">EXAMPLE_DIRS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>path_to/Online

<span class="cp">include $(TUTORIAL_HOME)/Makefile</span>
</pre></div>
</div>
</div>
</li>
<li><div class="toggle-header docutils container">
<p>a <code class="docutils literal notranslate"><span class="pre">DY.Online.Data</span></code> module</p>
</div>
<div class="toggle-content docutils container">
<blockquote>
<div><div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">Online</span><span class="p">.</span><span class="nc">Data</span>

<span class="k">open</span> <span class="nc">Comparse</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Lib</span>
</pre></div>
</div>
</div></blockquote>
</div>
</li>
<li><div class="toggle-header docutils container">
<p>a <code class="docutils literal notranslate"><span class="pre">DY.Online.Protocol</span></code> module.</p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">Online</span><span class="p">.</span><span class="nc">Protocol</span>

<span class="k">open</span> <span class="nc">Comparse</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Lib</span>

<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Simplified</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Extend</span>

<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">Online</span><span class="p">.</span><span class="nc">Data</span>
</pre></div>
</div>
</div>
</li>
</ul>
</section>
<section id="the-data-module">
<h3>The <code class="docutils literal notranslate"><span class="pre">Data</span></code> module<a class="headerlink" href="#the-data-module" title="Link to this heading"></a></h3>
<section id="id13">
<h4>The abstract message and state types<a class="headerlink" href="#id13" title="Link to this heading"></a></h4>
<p>We begin the DY* model of the Online? protocol with the abstract message and state types
in the <code class="docutils literal notranslate"><span class="pre">DY.Online.Data</span></code> module.</p>
<section id="id14">
<h5>Messages<a class="headerlink" href="#id14" title="Link to this heading"></a></h5>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Abstract message format</p>
<p>Define the abstract format for the messages of the Online? protocol
as records in DY*.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>The messages of the Online? protocol have the same content
as the messages in the Two-Message protocol.
Hence, we have the same abstract format and
can use the same records:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">ping_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">type</span> <span class="n">ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">type</span> <span class="n">message_t</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Ping</span><span class="o">:</span> <span class="o">(</span><span class="n">ping</span><span class="o">:</span><span class="n">ping_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">message_t</span>
  <span class="o">|</span> <span class="nc">Ack</span><span class="o">:</span>  <span class="o">(</span><span class="n">ack</span><span class="o">:</span><span class="n">ack_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">message_t</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition remember">
<p class="admonition-title">Remember</p>
<p>The abstract format of messages only defines the <em>content</em> of the message.</p>
<p>In particular, the following are <em>not</em> part of the abstract format:</p>
<ul class="simple">
<li><p>the structure of the message (for example: Is it a pair? Is it a 3-tuple where the second component is a pair?)</p></li>
<li><p>whether the message (or parts of it) are encrypted</p></li>
</ul>
</div>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Serializing and Parsing for the abstract message format</p>
<p>Define serializer and parser for the abstract message format using Comparse.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>Add <code class="code highlight fstar docutils literal highlight-fstar"><span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span></code> to the record types and add</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_ping_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ping_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_ack_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">ack_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_message_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">message_t</span><span class="o">))</span>

<span class="n">instance</span> <span class="n">parseable_serializeable_bytes_message_t</span><span class="o">:</span> <span class="n">parseable_serializeable</span> <span class="n">bytes</span> <span class="n">message_t</span> <span class="o">=</span>
  <span class="n">mk_parseable_serializeable</span> <span class="n">ps_message_t</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id15">
<h5>States<a class="headerlink" href="#id15" title="Link to this heading"></a></h5>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Abstract state format</p>
<p>Completely define the abstract state format for states related to the Online? protocol.
(You do not need to think about the states where keys are stored.)</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>Again, the content of the states of the Online? protocol
are the same as the ones in the Two-Message protocol:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="c">// the record types for the individual states</span>
<span class="c">// and the combined state_t type</span>

<span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span>
<span class="k">type</span> <span class="n">sent_ping_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">bob</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span>
<span class="k">type</span> <span class="n">sent_ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span>
<span class="k">type</span> <span class="n">received_ack_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">bob</span> <span class="o">:</span> <span class="n">principal</span><span class="o">;</span>
  <span class="n">n_a</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">;</span>
<span class="o">}</span>

<span class="o">[@@</span> <span class="n">with_bytes</span> <span class="n">bytes</span><span class="o">]</span>
<span class="k">type</span> <span class="n">state_t</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">SentPing</span><span class="o">:</span> <span class="o">(</span><span class="n">ping</span><span class="o">:</span><span class="n">sent_ping_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">state_t</span>
  <span class="o">|</span> <span class="nc">SentAck</span><span class="o">:</span> <span class="o">(</span><span class="n">ack</span><span class="o">:</span><span class="n">sent_ack_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">state_t</span>
  <span class="o">|</span> <span class="nc">ReceivedAck</span><span class="o">:</span> <span class="o">(</span><span class="n">rack</span><span class="o">:</span><span class="n">received_ack_t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">state_t</span>

<span class="c">// serializing and parsing using Comparse</span>

<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_sent_ping_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">sent_ping_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_sent_ack_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">sent_ack_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_received_ack_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">received_ack_t</span><span class="o">))</span>
<span class="o">%</span><span class="n">splice</span> <span class="o">[</span><span class="n">ps_state_t</span><span class="o">]</span> <span class="o">(</span><span class="n">gen_parser</span> <span class="o">(</span><span class="k">`</span><span class="n">state_t</span><span class="o">))</span>

<span class="n">instance</span> <span class="n">parseable_serializeable_bytes_state_t</span><span class="o">:</span> <span class="n">parseable_serializeable</span> <span class="n">bytes</span> <span class="n">state_t</span> <span class="o">=</span>
     <span class="n">mk_parseable_serializeable</span> <span class="n">ps_state_t</span>

<span class="c">// the local_state instance</span>

<span class="n">instance</span> <span class="n">local_state_state_t</span><span class="o">:</span> <span class="n">local_state</span> <span class="n">state_t</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;Online.State&quot;</span><span class="o">;</span>
  <span class="n">format</span> <span class="o">=</span> <span class="n">parseable_serializeable_bytes_state_t</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id16">
<h5>Summary<a class="headerlink" href="#id16" title="Link to this heading"></a></h5>
<p>The content of the messages and states of the Online? protocol
are the same as for the Two-Message protocol.
Hence, the definitions of the abstract formats are the same
and your <code class="docutils literal notranslate"><span class="pre">DY.Online.Data</span></code> module should now be the same
as the <code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Data</span></code> module
(except for the tag of the states in the <code class="docutils literal notranslate"><span class="pre">local_state</span></code> instance).</p>
</section>
</section>
<section id="preparation-for-public-key-encryption">
<h4>Preparation for Public Key Encryption<a class="headerlink" href="#preparation-for-public-key-encryption" title="Link to this heading"></a></h4>
<p>Finally, we need a tag for the protocol related keys
used for public key en-/decryption of the messages.
We define this tag as a global constant also in the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module.</p>
<p>For example:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">key_tag</span> <span class="o">=</span> <span class="s2">&quot;Online.Key&quot;</span>
</pre></div>
</div>
<p>This concludes the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module and we can continue
with the implementation of the protocol steps.</p>
</section>
</section>
<section id="id17">
<h3>The protocol steps<a class="headerlink" href="#id17" title="Link to this heading"></a></h3>
<p>Recall again,
that the only difference of the Two-Message and the Online? protocol
is that the messages are now encrypted for the respective participants.
For this, we use
the <a class="reference internal" href="#ex-pke-encryption"><span class="std std-ref">encryption function</span></a> <code class="code highlight fstar docutils literal highlight-fstar"><span class="n">pke_enc_for</span></code>
and the <a class="reference internal" href="#ex-pke-decryption"><span class="std std-ref">decryption function</span></a> <code class="docutils literal notranslate"><span class="pre">pke_dec_with_key_lookup</span></code>.</p>
<section id="sending-a-ping">
<h4>Sending a Ping<a class="headerlink" href="#sending-a-ping" title="Link to this heading"></a></h4>
<p>As a first attempt,
you might try to just copy the <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> step from the model of the Two-Message protocol:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">val</span> <span class="n">send_ping</span><span class="o">:</span>
<span class="linenos"> 2</span>  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">bob</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span>
<span class="linenos"> 3</span>  <span class="n">traceful</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">)</span>
<span class="linenos"> 4</span><span class="kd">let</span> <span class="n">send_ping</span> <span class="n">alice</span> <span class="n">bob</span> <span class="o">=</span>
<span class="linenos"> 5</span>  <span class="kd">let</span><span class="o">*</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">gen_rand</span> <span class="k">in</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>  <span class="kd">let</span> <span class="n">ping</span> <span class="o">=</span> <span class="nc">Ping</span> <span class="o">{</span><span class="n">alice</span> <span class="o">=</span> <span class="n">alice</span><span class="o">;</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
<span class="hll"><span class="linenos"> 8</span>  <span class="kd">let</span> <span class="n">ping_wire</span> <span class="o">=</span> <span class="n">serialize</span> <span class="n">message_t</span> <span class="n">ping</span> <span class="k">in</span>
</span><span class="hll"><span class="linenos"> 9</span>  <span class="kd">let</span><span class="o">*</span> <span class="n">msg_ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="n">ping_wire</span> <span class="k">in</span>
</span><span class="linenos">10</span>
<span class="linenos">11</span>  <span class="kd">let</span> <span class="n">ping_state</span> <span class="o">=</span> <span class="nc">SentPing</span> <span class="o">{</span><span class="n">bob</span> <span class="o">=</span> <span class="n">bob</span><span class="o">;</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
<span class="linenos">12</span>  <span class="kd">let</span><span class="o">*</span> <span class="n">sid</span> <span class="o">=</span> <span class="n">start_new_session</span> <span class="n">alice</span> <span class="n">ping_state</span> <span class="k">in</span>
<span class="linenos">13</span>
<span class="linenos">14</span>  <span class="n">return</span> <span class="o">(</span><span class="n">sid</span><span class="o">,</span> <span class="n">msg_ts</span><span class="o">)</span>
</pre></div>
</div>
<p>Now that we want to encrypt the message before sending it in Line 9,
we need to adapt Line 8.
We want to call <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> here instead of the <code class="docutils literal notranslate"><span class="pre">serialize</span></code>.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Preparing the encryption</p>
<p>What are the arguments to the call of <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> at this point?
(Who wants to decrypt for who? Using what key?)</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">alice</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bob</span></code></p></li>
<li><p>some state ID of alice, where she stores public encryption keys</p></li>
<li><p>the key tag defined in the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module</p></li>
<li><p>the abstract Ping message <code class="docutils literal notranslate"><span class="pre">ping</span></code></p></li>
</ul>
<p>So the call looks like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">pke_enc_for</span> <span class="n">alice</span> <span class="n">bob</span> <span class="n">alice_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">ping</span>
</pre></div>
</div>
</div>
</div>
<p>We observe that the only “undefined” argument is
the session ID of the state where Alice stores her public encryption keys.
Recall from the <a class="reference internal" href="#pke-key-storage-model"><span class="std std-ref">introduction of the key storage model</span></a>,
that this session ID needs to be added as an extra argument to the protocol step.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Adding the public key session ID as argument</p>
<p>Add the key session ID where Alice stores her public keys
as extra argument to the <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> step.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">val</span> <span class="n">send_ping</span><span class="o">:</span>
<span class="hll"><span class="linenos">2</span>  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">alice_public_keys_sid</span><span class="o">:</span> <span class="n">state_id</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="linenos">3</span>  <span class="o">(</span><span class="n">bob</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">traceful</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">)</span>
<span class="hll"><span class="linenos">4</span><span class="kd">let</span> <span class="n">send_ping</span> <span class="n">alice</span> <span class="n">alice_public_keys_sid</span> <span class="n">bob</span> <span class="o">=</span>
</span><span class="linenos">5</span>  <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we want to call <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> in Line 8
and send the resulting cipher text in Line 9.
Since encryption is a monadic action,
we first need to think about the relevant monads
and which <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> to use.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Calling <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> in <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> – the Monads</p>
<ol class="arabic simple">
<li><p>What monad is the <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> action in?</p></li>
<li><p>What monad is the <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> function in?</p></li>
<li><p>What <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> do we have to use in Line 8?</p></li>
</ol>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> action
(since it may fail, if there is not the right key in the provided session.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">send_ping</span></code> is a <code class="docutils literal notranslate"><span class="pre">traceful</span></code> function.</p></li>
<li><p>None. We can not call <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> inside <code class="docutils literal notranslate"><span class="pre">send_ping</span></code>,
since it has more side effects.</p></li>
</ol>
</div>
</div>
<p>Since we want to call <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> in the <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> function,
we need to change the monad of <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> to <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code>.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Calling <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> in <code class="docutils literal notranslate"><span class="pre">send_ping</span></code></p>
<ol class="arabic simple">
<li><p>Change the type of <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> so that <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> is a function in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad.</p></li>
</ol>
<blockquote>
<div><div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">send_ping</span><span class="o">:</span>
  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">alice_public_keys_sid</span><span class="o">:</span> <span class="n">state_id</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">bob</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">))</span>
</pre></div>
</div>
</div>
</div></blockquote>
<ol class="arabic" start="2">
<li><p>Change Line 8 to use <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code>. What <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> do we have to use?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>Since we want the overall step to fail,
if encryption fails, we use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code> in Line 8:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">ping_encrypted</span> <span class="o">=</span> <span class="n">pke_enc_for</span> <span class="n">alice</span> <span class="n">bob</span> <span class="n">alice_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">ping</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
<li><p>Is there anything else we need to change in the <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> function?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>As we changed the monad of <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> to <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code>,
we now need to return an <code class="docutils literal notranslate"><span class="pre">option</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="o">(</span><span class="n">sid</span><span class="o">,</span> <span class="n">msg_ts</span><span class="o">))</span>
</pre></div>
</div>
</div>
</li>
</ol>
</div>
<p>Putting everything together, the <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> step for the Online? protocol looks like this
(highlighting the changes to the <code class="docutils literal notranslate"><span class="pre">send_ping</span></code> step from the Two-Message protocol):</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">val</span> <span class="n">send_ping</span><span class="o">:</span>
<span class="hll"><span class="linenos"> 2</span>  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">alice_public_keys_sid</span><span class="o">:</span> <span class="n">state_id</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">bob</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="hll"><span class="linenos"> 3</span>  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">))</span>
</span><span class="hll"><span class="linenos"> 4</span><span class="kd">let</span> <span class="n">send_ping</span> <span class="n">alice</span> <span class="n">alice_public_keys_sid</span> <span class="n">bob</span> <span class="o">=</span>
</span><span class="linenos"> 5</span>  <span class="kd">let</span><span class="o">*</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">gen_rand</span> <span class="k">in</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>  <span class="kd">let</span> <span class="n">ping</span> <span class="o">=</span> <span class="nc">Ping</span> <span class="o">{</span><span class="n">alice</span> <span class="o">=</span> <span class="n">alice</span><span class="o">;</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
<span class="hll"><span class="linenos"> 8</span>  <span class="kd">let</span><span class="o">*?</span> <span class="n">ping_encrypted</span> <span class="o">=</span> <span class="n">pke_enc_for</span> <span class="n">alice</span> <span class="n">bob</span> <span class="n">alice_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">ping</span> <span class="k">in</span>
</span><span class="hll"><span class="linenos"> 9</span>  <span class="kd">let</span><span class="o">*</span> <span class="n">msg_ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="n">ping_encrypted</span> <span class="k">in</span>
</span><span class="linenos">10</span>
<span class="linenos">11</span>  <span class="kd">let</span> <span class="n">ping_state</span> <span class="o">=</span> <span class="nc">SentPing</span> <span class="o">{</span><span class="n">bob</span> <span class="o">=</span> <span class="n">bob</span><span class="o">;</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
<span class="linenos">12</span>  <span class="kd">let</span><span class="o">*</span> <span class="n">sid</span> <span class="o">=</span> <span class="n">start_new_session</span> <span class="n">alice</span> <span class="n">ping_state</span> <span class="k">in</span>
<span class="linenos">13</span>
<span class="hll"><span class="linenos">14</span>  <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="o">(</span><span class="n">sid</span><span class="o">,</span> <span class="n">msg_ts</span><span class="o">))</span>
</span></pre></div>
</div>
<div class="admonition info">
<p class="admonition-title">Common Mistakes</p>
<p>If you changed Line 8 to</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">ping_encrypted</span> <span class="o">=</span> <span class="n">pke_enc_for</span> <span class="n">alice</span> <span class="n">bob</span> <span class="n">alice_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">ping</span> <span class="k">in</span>
</pre></div>
</div>
<p>and get the error</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- Expected type traceful (option (*?u8*) _)
  but
      ...
  has type traceful (state_id &amp; timestamp)
</pre></div>
</div>
<p>you probably forgot to</p>
<ul>
<li><p>add <code class="docutils literal notranslate"><span class="pre">option</span></code> to the monad of <code class="docutils literal notranslate"><span class="pre">send_ping</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">send_ping</span><span class="o">:</span>
  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">alice_public_keys_sid</span><span class="o">:</span> <span class="n">state_id</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">bob</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">))</span>
</pre></div>
</div>
</li>
<li><p>or to return an <code class="docutils literal notranslate"><span class="pre">option</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="o">(</span><span class="n">sid</span><span class="o">,</span> <span class="n">msg_ts</span><span class="o">))</span>
</pre></div>
</div>
</li>
</ul>
</div>
</section>
<section id="replying-with-an-ack">
<h4>Replying with an Ack<a class="headerlink" href="#replying-with-an-ack" title="Link to this heading"></a></h4>
<p>As for <code class="docutils literal notranslate"><span class="pre">send_ping</span></code>,
we will build the second protocol step for the Online? protocol
from the second step of the Two-Message protocol
and focus on the differences.</p>
<p>Start by copying the <code class="docutils literal notranslate"><span class="pre">receive_ping_and_send_ack</span></code> step from
<code class="docutils literal notranslate"><span class="pre">DY.TwoMessage.Protocol</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">val</span> <span class="n">receive_ping_and_send_ack</span><span class="o">:</span>
<span class="linenos"> 2</span>   <span class="n">principal</span> <span class="o">-&gt;</span> <span class="n">timestamp</span> <span class="o">-&gt;</span>
<span class="linenos"> 3</span>   <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">))</span>
<span class="linenos"> 4</span><span class="kd">let</span> <span class="n">receive_ping_and_send_ack</span> <span class="n">bob</span> <span class="n">msg_ts</span> <span class="o">=</span>
<span class="linenos"> 5</span>  <span class="kd">let</span><span class="o">*?</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">recv_msg</span> <span class="n">msg_ts</span> <span class="k">in</span>
<span class="hll"><span class="linenos"> 6</span>  <span class="kd">let</span><span class="o">*?</span> <span class="n">png_</span> <span class="o">=</span> <span class="n">return</span> <span class="o">(</span><span class="n">parse</span> <span class="n">message_t</span> <span class="n">msg</span><span class="o">)</span> <span class="k">in</span>
</span><span class="linenos"> 7</span>  <span class="n">guard_tr</span> <span class="o">(</span><span class="nc">Ping</span><span class="o">?</span> <span class="n">png_</span><span class="o">);*?</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>  <span class="kd">let</span> <span class="nc">Ping</span> <span class="n">png</span> <span class="o">=</span> <span class="n">png_</span> <span class="k">in</span>
<span class="linenos">10</span>  <span class="kd">let</span> <span class="n">alice</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">alice</span> <span class="k">in</span>
<span class="linenos">11</span>  <span class="kd">let</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">n_a</span> <span class="k">in</span>
<span class="linenos">12</span>
<span class="linenos">13</span>  <span class="kd">let</span> <span class="n">ack</span> <span class="o">=</span> <span class="nc">Ack</span> <span class="o">{</span><span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
<span class="hll"><span class="linenos">14</span>  <span class="kd">let</span><span class="o">*</span> <span class="n">ack_ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="o">(</span><span class="n">serialize</span> <span class="n">message_t</span> <span class="n">ack</span><span class="o">)</span> <span class="k">in</span>
</span><span class="linenos">15</span>
<span class="linenos">16</span>  <span class="kd">let</span> <span class="n">ack_state</span> <span class="o">=</span> <span class="nc">SentAck</span> <span class="o">{</span><span class="n">alice</span><span class="o">;</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
<span class="linenos">17</span>  <span class="kd">let</span><span class="o">*</span> <span class="n">sess_id</span> <span class="o">=</span> <span class="n">start_new_session</span> <span class="n">bob</span> <span class="n">ack_state</span> <span class="k">in</span>
<span class="linenos">18</span>
<span class="linenos">19</span>  <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="o">(</span><span class="n">sess_id</span><span class="o">,</span> <span class="n">ack_ts</span><span class="o">))</span>
</pre></div>
</div>
<p>The main differences between the Online? and the Two-Message protocol are:</p>
<ul class="simple">
<li><p>the received Ping is encrypted and hence Bob needs to decrypt the message in Line 6</p></li>
<li><p>the Ack needs to be encrypted for Alice in Line 14</p></li>
</ul>
<section id="decrypting-the-ping">
<h5>Decrypting the Ping<a class="headerlink" href="#decrypting-the-ping" title="Link to this heading"></a></h5>
<p>We begin with decrypting the received message.
For this we want to use the <a class="reference internal" href="#ex-pke-decryption"><span class="std std-ref">decryption function</span></a> <code class="docutils literal notranslate"><span class="pre">pke_dec_with_key_lookup</span></code>.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Preparing the Decryption</p>
<p>What are the arguments to the call of <code class="docutils literal notranslate"><span class="pre">pke_dec_with_key_lookup</span></code>
in Line 6?
(Who wants to decrypt? Using what key?)</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bob</span></code></p></li>
<li><p>some state ID of Bob, where he stores his private decryption keys</p></li>
<li><p>the key tag defined in the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module</p></li>
<li><p>the wire-format ciphertext <code class="docutils literal notranslate"><span class="pre">msg</span></code></p></li>
</ul>
<p>So the call looks like this:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">pke_dec_with_key_lookup</span> <span class="o">#</span><span class="n">message_t</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span> <span class="n">key_tag</span> <span class="n">msg</span>
</pre></div>
</div>
</div>
</div>
<p>Again, we currently don’t have Bob’s private key session ID available
and need to add it as extra argument to the protocol step.
So the type of the step changes to:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">receive_ping_and_send_ack</span><span class="o">:</span>
  <span class="n">principal</span> <span class="o">-&gt;</span> <span class="n">state_id</span> <span class="o">-&gt;</span> <span class="n">timestamp</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">))</span>
<span class="kd">let</span> <span class="n">receive_ping_and_send_ack</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span> <span class="n">msg_ts</span> <span class="o">=</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>We are now ready to call the decryption function.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Calling <code class="docutils literal notranslate"><span class="pre">pke_dec_with_key_lookup</span></code> in <code class="docutils literal notranslate"><span class="pre">receive_ping_and_send_ack</span></code></p>
<ol class="arabic">
<li><p>Can we call <code class="docutils literal notranslate"><span class="pre">pke_dec_with_key_lookup</span></code> inside <code class="docutils literal notranslate"><span class="pre">receive_ping_and_send_ack</span></code>?
(Think about the relevant monads.)</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>Yes. Both the decryption action and the overall function are in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad.</p>
</div>
</li>
<li><p>What <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> do we need to use in Line 6?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>Since we want the protocol step to fail,
if decryption fails,
we need to use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code>.</p>
</div>
</li>
<li><p>Change Line 6 accordingly.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">png_</span> <span class="o">=</span> <span class="n">pke_dec_with_key_lookup</span> <span class="o">#</span><span class="n">message_t</span> <span class="n">bob</span> <span class="n">private_keys_sid</span> <span class="n">key_tag</span> <span class="n">msg</span> <span class="k">in</span>
</pre></div>
</div>
<p>Recall, that decryption includes parsing,
so the returned <code class="docutils literal notranslate"><span class="pre">png_</span></code> is already in the abstract message format
and we don’t need to explicitly call <code class="docutils literal notranslate"><span class="pre">parse</span></code>.</p>
</div>
</li>
</ol>
</div>
<p>This concludes decryption of the received message to an abstract Ping message.</p>
</section>
<section id="encrypting-the-ack">
<h5>Encrypting the Ack<a class="headerlink" href="#encrypting-the-ack" title="Link to this heading"></a></h5>
<p>Encrypting the Ack message works just like
encrypting the Ping in the first protocol step.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Encrypting the Ack</p>
<p>Change the step so that the Ack is encrypted for Alice.</p>
<p>You may want to think about the following and adapt the model accordingly:</p>
<ol class="arabic">
<li><p>What are the arguments for the encryption function?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bob</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alice</span></code></p></li>
<li><p>a session ID where Bob stores his public encryption keys</p></li>
<li><p>the key tag defined in the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module</p></li>
<li><p>the abstract Ack <code class="docutils literal notranslate"><span class="pre">ack</span></code></p></li>
</ul>
</div>
</li>
<li><p>Does the type of the protocol step need to change?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>Yes, we need to add the session ID for the public keys of Bob as extra argument:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">receive_ping_and_send_ack</span><span class="o">:</span>
  <span class="n">principal</span> <span class="o">-&gt;</span> <span class="n">state_id</span> <span class="o">-&gt;</span> <span class="n">state_id</span> <span class="o">-&gt;</span>
  <span class="n">timestamp</span> <span class="o">-&gt;</span> <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">))</span>
<span class="kd">let</span> <span class="n">receive_ping_and_send_ack</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span> <span class="n">bob_public_keys_sid</span> <span class="n">msg_ts</span> <span class="o">=</span>
  <span class="o">...</span>
</pre></div>
</div>
</div>
</li>
<li><p>Can we call the encryption function here and what <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> should we use?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>Yes, since both the encryption action and the overall protocol step are in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad.
Since we want the whole step to fail, if encryption fails,
we use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code>.</p>
<p>Line 14 changes to:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">ack_encrypted</span> <span class="o">=</span> <span class="n">pke_enc_for</span> <span class="n">bob</span> <span class="n">alice</span> <span class="n">bob_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">ack</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</li>
</ol>
</div>
</section>
<section id="id18">
<h5>Summary<a class="headerlink" href="#id18" title="Link to this heading"></a></h5>
<p>To summarize, we</p>
<ul class="simple">
<li><p>used <code class="docutils literal notranslate"><span class="pre">pke_dec_with_key_lookup</span></code> for decrypting the received message
(adding Bob’s private keys session ID as extra argument to the step)</p></li>
<li><p>used <code class="docutils literal notranslate"><span class="pre">pke_enc_for</span></code> to encrypt the Ack for Alice
(adding Bob’s public keys session ID as extra argument)</p></li>
</ul>
<p>so that the final second protocol step now looks like this
(highlighting the changes to the second step of the Two-Message protocol):</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">val</span> <span class="n">receive_ping_and_send_ack</span><span class="o">:</span>
<span class="hll"><span class="linenos"> 2</span>  <span class="n">principal</span> <span class="o">-&gt;</span> <span class="n">state_id</span> <span class="o">-&gt;</span> <span class="n">state_id</span> <span class="o">-&gt;</span> <span class="n">timestamp</span> <span class="o">-&gt;</span>
</span><span class="linenos"> 3</span>  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="o">(</span><span class="n">state_id</span> <span class="o">&amp;</span> <span class="n">timestamp</span><span class="o">))</span>
<span class="hll"><span class="linenos"> 4</span><span class="kd">let</span> <span class="n">receive_ping_and_send_ack</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span> <span class="n">bob_public_keys_sid</span> <span class="n">msg_ts</span> <span class="o">=</span>
</span><span class="linenos"> 5</span>  <span class="kd">let</span><span class="o">*?</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">recv_msg</span> <span class="n">msg_ts</span> <span class="k">in</span>
<span class="hll"><span class="linenos"> 6</span>  <span class="kd">let</span><span class="o">*?</span> <span class="n">png_</span> <span class="o">=</span> <span class="n">pke_dec_with_key_lookup</span> <span class="o">#</span><span class="n">message_t</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span> <span class="n">key_tag</span> <span class="n">msg</span> <span class="k">in</span>
</span><span class="linenos"> 7</span>  <span class="n">guard_tr</span> <span class="o">(</span><span class="nc">Ping</span><span class="o">?</span> <span class="n">png_</span><span class="o">);*?</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>  <span class="kd">let</span> <span class="nc">Ping</span> <span class="n">png</span> <span class="o">=</span> <span class="n">png_</span> <span class="k">in</span>
<span class="linenos">10</span>  <span class="kd">let</span> <span class="n">alice</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">alice</span> <span class="k">in</span>
<span class="linenos">11</span>  <span class="kd">let</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">n_a</span> <span class="k">in</span>
<span class="linenos">12</span>
<span class="linenos">13</span>  <span class="kd">let</span> <span class="n">ack</span> <span class="o">=</span> <span class="nc">Ack</span> <span class="o">{</span><span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
<span class="hll"><span class="linenos">14</span>  <span class="kd">let</span><span class="o">*?</span> <span class="n">ack_encrypted</span> <span class="o">=</span> <span class="n">pke_enc_for</span> <span class="n">bob</span> <span class="n">alice</span> <span class="n">bob_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">ack</span> <span class="k">in</span>
</span><span class="hll"><span class="linenos">15</span>  <span class="kd">let</span><span class="o">*</span> <span class="n">ack_ts</span> <span class="o">=</span> <span class="n">send_msg</span> <span class="n">ack_encrypted</span> <span class="k">in</span>
</span><span class="linenos">16</span>
<span class="linenos">17</span>  <span class="kd">let</span> <span class="n">ack_state</span> <span class="o">=</span> <span class="nc">SentAck</span> <span class="o">{</span><span class="n">alice</span><span class="o">;</span> <span class="n">n_a</span><span class="o">}</span> <span class="k">in</span>
<span class="linenos">18</span>  <span class="kd">let</span><span class="o">*</span> <span class="n">sess_id</span> <span class="o">=</span> <span class="n">start_new_session</span> <span class="n">bob</span> <span class="n">ack_state</span> <span class="k">in</span>
<span class="linenos">19</span>
<span class="linenos">20</span>  <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="o">(</span><span class="n">sess_id</span><span class="o">,</span> <span class="n">ack_ts</span><span class="o">))</span>
</pre></div>
</div>
</section>
</section>
<section id="receiving-an-ack">
<h4>Receiving an Ack<a class="headerlink" href="#receiving-an-ack" title="Link to this heading"></a></h4>
<p>The final step of the Online? protocol
is again almost the same as the final step of the Two-Message protocol.
The only difference is,
that the received Ack is encrypted and needs to be decrypted by Alice.
This works in the same way as in the second step,
where Bob decrypts the Ping.
Looking back at the previous step,
you should be able to adapt the final step of the Two-Message protocol.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Adapting <code class="docutils literal notranslate"><span class="pre">receive_ack</span></code> from the model of the Two-Message protocol</p>
<p>Implement the final protocol step by adapting the <code class="docutils literal notranslate"><span class="pre">receive_ack</span></code> step from the model of the Two-Message protocol.</p>
<p>You can follow these steps:</p>
<ol class="arabic">
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">receive_ack</span></code> step from the model of the Two-Message protocol.
Where do we need to perform decryption?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">val</span> <span class="n">receive_ack</span><span class="o">:</span>
<span class="linenos"> 2</span>  <span class="n">principal</span> <span class="o">-&gt;</span> <span class="n">timestamp</span> <span class="o">-&gt;</span>
<span class="linenos"> 3</span>  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="n">state_id</span><span class="o">)</span>
<span class="linenos"> 4</span><span class="kd">let</span> <span class="n">receive_ack</span> <span class="n">alice</span> <span class="n">ack_ts</span> <span class="o">=</span>
<span class="linenos"> 5</span>  <span class="kd">let</span><span class="o">*?</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">recv_msg</span> <span class="n">ack_ts</span> <span class="k">in</span>
<span class="hll"><span class="linenos"> 6</span>  <span class="kd">let</span><span class="o">*?</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">return</span> <span class="o">(</span><span class="n">parse</span> <span class="n">message_t</span> <span class="n">msg</span><span class="o">)</span> <span class="k">in</span>
</span><span class="linenos"> 7</span>  <span class="n">guard_tr</span> <span class="o">(</span><span class="nc">Ack</span><span class="o">?</span> <span class="n">ack</span><span class="o">);*?</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>  <span class="kd">let</span> <span class="nc">Ack</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">ack</span> <span class="k">in</span>
<span class="linenos">10</span>  <span class="kd">let</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">ack</span><span class="o">.</span><span class="n">n_a</span> <span class="k">in</span>
<span class="linenos">11</span>
<span class="linenos">12</span>  <span class="kd">let</span><span class="o">*?</span> <span class="o">(</span><span class="n">sid</span><span class="o">,</span> <span class="n">st</span><span class="o">)</span> <span class="o">=</span> <span class="n">lookup_state</span> <span class="o">#</span><span class="n">state_t</span> <span class="n">alice</span>
<span class="linenos">13</span>    <span class="o">(</span><span class="k">fun</span> <span class="n">st</span> <span class="o">-&gt;</span>
<span class="linenos">14</span>          <span class="nc">SentPing</span><span class="o">?</span> <span class="n">st</span>
<span class="linenos">15</span>      <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nc">SentPing</span><span class="o">?.</span><span class="n">ping</span> <span class="n">st</span><span class="o">).</span><span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span>
<span class="linenos">16</span>    <span class="o">)</span> <span class="k">in</span>
<span class="linenos">17</span>  <span class="n">guard_tr</span><span class="o">(</span><span class="nc">SentPing</span><span class="o">?</span> <span class="n">st</span><span class="o">);*?</span>
<span class="linenos">18</span>  <span class="kd">let</span> <span class="n">bob</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SentPing</span><span class="o">?.</span><span class="n">ping</span> <span class="n">st</span><span class="o">).</span><span class="n">bob</span> <span class="k">in</span>
<span class="linenos">19</span>
<span class="linenos">20</span>  <span class="n">set_state</span> <span class="n">alice</span> <span class="n">sid</span> <span class="o">(</span><span class="nc">ReceivedAck</span> <span class="o">{</span><span class="n">bob</span><span class="o">;</span> <span class="n">n_a</span><span class="o">});*</span>
<span class="linenos">21</span>
<span class="linenos">22</span>  <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">sid</span><span class="o">)</span>
</pre></div>
</div>
</div>
</li>
<li><p>What are the arguments of the decryption function?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">alice</span></code></p></li>
<li><p>the session ID where Alice stores her private decryption keys</p></li>
<li><p>the key tag defined in the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module</p></li>
<li><p>the wire-format ciphertext <code class="docutils literal notranslate"><span class="pre">msg</span></code></p></li>
</ul>
</div>
</li>
<li><p>Does the type of the protocol step need to change?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>Yes. We need to add the private keys session ID as extra argument:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">receive_ack</span><span class="o">:</span>
  <span class="n">principal</span> <span class="o">-&gt;</span> <span class="n">state_id</span> <span class="o">-&gt;</span> <span class="n">timestamp</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="n">state_id</span><span class="o">)</span>
<span class="kd">let</span> <span class="n">receive_ack</span> <span class="n">alice</span> <span class="n">alice_private_keys_sid</span> <span class="n">ack_ts</span> <span class="o">=</span>
  <span class="o">...</span>
</pre></div>
</div>
</div>
</li>
<li><p>Can we call the decryption function here and what <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span></code> should we use?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>Yes. Since both decryption and the step are in the <code class="docutils literal notranslate"><span class="pre">traceful</span></code> + <code class="docutils literal notranslate"><span class="pre">option</span></code> monad.
We use <code class="code highlight fstar docutils literal highlight-fstar"><span class="kd">let</span><span class="o">*?</span></code>, as we want the whole step to fail if decryption fails.</p>
<p>Line 6 changes to:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">pke_dec_with_key_lookup</span> <span class="o">#</span><span class="n">message_t</span> <span class="n">alice</span> <span class="n">alice_private_keys_sid</span> <span class="n">key_tag</span> <span class="n">msg</span> <span class="k">in</span>
</pre></div>
</div>
<p>We do not need to call parsing explicitly,
as this is already part of decryption.</p>
</div>
</li>
</ol>
</div>
<p>The final step of the Online? protocol looks like this
(highlighting the changes to <code class="docutils literal notranslate"><span class="pre">receive_ack</span></code> from the Two-Message protocol):</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">val</span> <span class="n">receive_ack</span><span class="o">:</span>
<span class="hll"><span class="linenos"> 2</span>  <span class="n">principal</span> <span class="o">-&gt;</span> <span class="n">state_id</span> <span class="o">-&gt;</span> <span class="n">timestamp</span> <span class="o">-&gt;</span>
</span><span class="linenos"> 3</span>  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="n">state_id</span><span class="o">)</span>
<span class="hll"><span class="linenos"> 4</span><span class="kd">let</span> <span class="n">receive_ack</span> <span class="n">alice</span> <span class="n">alice_private_keys_sid</span> <span class="n">ack_ts</span> <span class="o">=</span>
</span><span class="linenos"> 5</span>  <span class="kd">let</span><span class="o">*?</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">recv_msg</span> <span class="n">ack_ts</span> <span class="k">in</span>
<span class="hll"><span class="linenos"> 6</span>  <span class="kd">let</span><span class="o">*?</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">pke_dec_with_key_lookup</span> <span class="o">#</span><span class="n">message_t</span> <span class="n">alice</span> <span class="n">alice_private_keys_sid</span> <span class="n">key_tag</span> <span class="n">msg</span> <span class="k">in</span>
</span><span class="linenos"> 7</span>  <span class="n">guard_tr</span> <span class="o">(</span><span class="nc">Ack</span><span class="o">?</span> <span class="n">ack</span><span class="o">);*?</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>  <span class="kd">let</span> <span class="nc">Ack</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">ack</span> <span class="k">in</span>
<span class="linenos">10</span>  <span class="kd">let</span> <span class="n">n_a</span> <span class="o">=</span> <span class="n">ack</span><span class="o">.</span><span class="n">n_a</span> <span class="k">in</span>
<span class="linenos">11</span>
<span class="linenos">12</span>  <span class="kd">let</span><span class="o">*?</span> <span class="o">(</span><span class="n">sid</span><span class="o">,</span> <span class="n">st</span><span class="o">)</span> <span class="o">=</span> <span class="n">lookup_state</span> <span class="o">#</span><span class="n">state_t</span> <span class="n">alice</span>
<span class="linenos">13</span>    <span class="o">(</span><span class="k">fun</span> <span class="n">st</span> <span class="o">-&gt;</span>
<span class="linenos">14</span>          <span class="nc">SentPing</span><span class="o">?</span> <span class="n">st</span>
<span class="linenos">15</span>      <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nc">SentPing</span><span class="o">?.</span><span class="n">ping</span> <span class="n">st</span><span class="o">).</span><span class="n">n_a</span> <span class="o">=</span> <span class="n">n_a</span>
<span class="linenos">16</span>    <span class="o">)</span> <span class="k">in</span>
<span class="linenos">17</span>  <span class="n">guard_tr</span><span class="o">(</span><span class="nc">SentPing</span><span class="o">?</span> <span class="n">st</span><span class="o">);*?</span>
<span class="linenos">18</span>  <span class="kd">let</span> <span class="n">bob</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SentPing</span><span class="o">?.</span><span class="n">ping</span> <span class="n">st</span><span class="o">).</span><span class="n">bob</span> <span class="k">in</span>
<span class="linenos">19</span>
<span class="linenos">20</span>  <span class="n">set_state</span> <span class="n">alice</span> <span class="n">sid</span> <span class="o">(</span><span class="nc">ReceivedAck</span> <span class="o">{</span><span class="n">bob</span><span class="o">;</span> <span class="n">n_a</span><span class="o">});*</span>
<span class="linenos">21</span>
<span class="linenos">22</span>  <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">sid</span><span class="o">)</span>
</pre></div>
</div>
<p>This concludes our model of the Online? protocol.
Which is very similar to the model of the Two-Message protocol,
with the new features of de- and encryption of messages.</p>
</section>
</section>
<section id="id19">
<h3>An example protocol run<a class="headerlink" href="#id19" title="Link to this heading"></a></h3>
<p>To check that our model works as expected,
we implement an example run,
where Alice sends a Ping to Bob,
Bob replies with an Ack
and Alice receives the Ack and checks that she started a run with the received nonce for Bob.</p>
<p>The general structure is the same as for the <a class="reference internal" href="#sec-ex-run-two-message-implementation"><span class="std std-ref">Two-Message protocol</span></a>:
we add a <code class="docutils literal notranslate"><span class="pre">Run</span></code> module in which we define a <code class="docutils literal notranslate"><span class="pre">run</span></code> function
where we call the protocol steps in the right order passing on arguments as needed
and finally print the trace.</p>
<p>But since we now use de- and encryption in the protocol steps,
we also need to take care of the key storage setup,
which will be our main focus in this section.</p>
<p>But first, let’s setup the example run module.</p>
<section id="the-run-module">
<h4>The <code class="docutils literal notranslate"><span class="pre">Run</span></code> module<a class="headerlink" href="#the-run-module" title="Link to this heading"></a></h4>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Setting up the <code class="docutils literal notranslate"><span class="pre">Run</span></code> module</p>
<p>Follow the steps from <a class="reference internal" href="#howto-modelling-protocols"><span class="std std-ref">How-To: Modelling a Protocol</span></a>
to add a new <code class="docutils literal notranslate"><span class="pre">Run</span></code> module,
add the <code class="docutils literal notranslate"><span class="pre">test</span></code> target to the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>,
implement an (empty) <code class="docutils literal notranslate"><span class="pre">run</span></code> function that is called when executing the module
and in which the current trace is printed.</p>
<p>Try your setup by running <code class="docutils literal notranslate"><span class="pre">make</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>The <code class="docutils literal notranslate"><span class="pre">Run</span></code> module:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">Online</span><span class="p">.</span><span class="nc">Run</span>

<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Lib</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nc">Simplified</span>

<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">Online</span><span class="p">.</span><span class="nc">Data</span>
<span class="k">open</span> <span class="nn">DY</span><span class="p">.</span><span class="nn">Online</span><span class="p">.</span><span class="nc">Protocol</span>

<span class="kd">let</span> <span class="n">run</span> <span class="bp">()</span> <span class="o">:</span> <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="kt">unit</span> <span class="o">)</span> <span class="o">=</span>
  <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="s2">&quot;************* Trace *************</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="kd">let</span><span class="o">*</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">get_trace</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="o">(</span>
      <span class="n">trace_to_string</span> <span class="n">default_trace_to_string_printers</span> <span class="n">tr</span>
    <span class="o">)</span> <span class="k">in</span>

  <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="bp">()</span><span class="o">)</span>

<span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run</span> <span class="bp">()</span> <span class="n">empty_trace</span>
</pre></div>
</div>
<p>Add to the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>:</p>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="nf">test</span><span class="o">:</span>
<span class="w">        </span><span class="nb">cd</span><span class="w"> </span><span class="k">$(</span>TUTORIAL_HOME<span class="k">)</span>/obj<span class="p">;</span><span class="w"> </span><span class="k">$(</span>FSTAR_EXE<span class="k">)</span><span class="w"> </span>--ocamlenv<span class="w"> </span>ocamlbuild<span class="w"> </span>-use-ocamlfind<span class="w"> </span>-pkg<span class="w"> </span>batteries<span class="w"> </span>-pkg<span class="w"> </span>fstar.lib<span class="w"> </span>DY_Online_Run.native
<span class="w">        </span><span class="k">$(</span>TUTORIAL_HOME<span class="k">)</span>/obj/DY_Online_Run.native
</pre></div>
</div>
<p>Running <code class="docutils literal notranslate"><span class="pre">make</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> produces several lines on the terminal
where the final line is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>************* Trace *************
</pre></div>
</div>
</div>
</div>
<p>Now that we have a working <code class="docutils literal notranslate"><span class="pre">Run</span></code> module,
we will populate the <code class="docutils literal notranslate"><span class="pre">run</span></code> function.
In the end, we want to call the protocol steps,
so we have to define all necessary arguments for those calls.
These arguments are</p>
<ul class="simple">
<li><p>the participants</p></li>
<li><p>the key session IDs</p></li>
</ul>
<p>For the participants, we define constants</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">alice</span> <span class="o">=</span> <span class="s2">&quot;Alice&quot;</span> <span class="k">in</span>
<span class="kd">let</span> <span class="n">bob</span> <span class="o">=</span> <span class="s2">&quot;Bob&quot;</span> <span class="k">in</span>
</pre></div>
</div>
<p>just as in the example run of the Two-Message protocol.</p>
<p>Let’s now take a closer look at
how to setup the key storage for de- and encryption.</p>
</section>
<section id="setup-of-key-storage">
<h4>Setup of Key Storage<a class="headerlink" href="#setup-of-key-storage" title="Link to this heading"></a></h4>
<p>Recall the layout of key storage at the participants from <a class="reference internal" href="#pke-key-storage-model"><span class="std std-ref">before</span></a>.
For our example run of the Online? protocol,
we want to have the following states after key storage setup:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>State Alice:
  Session alice_private_keys_sid: {
    &quot;Online.Key&quot; = alice_private_key
  }
  Session alice_public_keys_sid: {
    (&quot;Online.Key&quot;, Bob) = bob_public_key
  }
</pre></div>
</div>
<p>Alice has one private key and one public key for Bob for the Online? protocol in her state.
And similarly for Bob:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>State Bob:
  Session bob_private_keys_sid: {
    &quot;Online.Key&quot; = bob_private_key
  }
  Session bob_public_keys_sid: {
    (&quot;Online.Key&quot;, Alice) = alice_public_key
  }
</pre></div>
</div>
<p>To achieve these state layouts,
the setup consists of three phases for every participant:</p>
<ol class="arabic simple">
<li><p>Allocate sessions for the private and public keys.</p></li>
<li><p>Generate and store own private keys.</p></li>
<li><p>Retrieve and store public keys from other participants.</p></li>
</ol>
<section id="allocating-sessions-for-private-and-public-keys">
<h5>1. Allocating sessions for private and public keys<a class="headerlink" href="#allocating-sessions-for-private-and-public-keys" title="Link to this heading"></a></h5>
<p>In the first initialization step,
we allocate new sessions at the participants
for the private and public keys.
These new sessions are initialized as empty dictionaries.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">DY.Lib</span></code> there are <code class="docutils literal notranslate"><span class="pre">initialize_*</span></code> functions
that take as argument a participant
and return the new session ID where the keys are to be stored.
They are <code class="docutils literal notranslate"><span class="pre">traceful</span></code> functions that can not fail,
since they just add new sessions to the state.</p>
<div class="admonition example">
<p class="admonition-title">Example: Allocate key sessions for Alice</p>
<p>For the private keys session of Alice we use <code class="docutils literal notranslate"><span class="pre">initialize_private_keys</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">alice_private_keys_sid</span> <span class="o">=</span> <span class="n">initialize_private_keys</span> <span class="n">alice</span> <span class="k">in</span>
</pre></div>
</div>
<p>and for the public keys session we use <code class="docutils literal notranslate"><span class="pre">initialize_pki</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">alice_public_keys_sid</span> <span class="o">=</span> <span class="n">initialize_pki</span> <span class="n">alice</span> <span class="k">in</span>
</pre></div>
</div>
<p>After these initialization steps the state of Alice looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>State Alice:
  Session alice_private_keys_sid: { }
  Session alice_public_keys_sid: { }
</pre></div>
</div>
<p>Alice has two new sessions, each containing an empty dictionary.</p>
</div>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Allocate key sessions for Bob</p>
<p>Allocate new sessions for the private and public keys for Bob.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">bob_private_keys_sid</span> <span class="o">=</span> <span class="n">initialize_private_keys</span> <span class="n">bob</span> <span class="k">in</span>
<span class="kd">let</span><span class="o">*</span> <span class="n">bob_public_keys_sid</span> <span class="o">=</span> <span class="n">initialize_pki</span> <span class="n">bob</span> <span class="k">in</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="generating-and-storing-private-keys">
<h5>2. Generating and Storing private keys<a class="headerlink" href="#generating-and-storing-private-keys" title="Link to this heading"></a></h5>
<p>Now that we know, <em>where</em> to store the private keys,
we can actually generate and store them.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">DY.Simplified</span></code> there is a corresponding function:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">generate_private_pke_key</span><span class="o">:</span>
  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">alice_private_keys_sid</span><span class="o">:</span> <span class="n">state_id</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">key_tag</span><span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="kt">unit</span><span class="o">)</span>
</pre></div>
</div>
<p>The function takes as arguments</p>
<ul class="simple">
<li><p>the participant to generate the private key for</p></li>
<li><p>the session ID where the key should be stored, and</p></li>
<li><p>the tag under which the key should be stored.</p></li>
</ul>
<p>It generates a new key and stores it under the given tag in the provided session ID of the participant.
The step may fail,
if the session at the provided ID is not a private key dictionary.</p>
<p><span class="todo-inline">TODO: Explain why we use ;* and not ;*? here: It can fail but we don’t do anything different if it does.</span></p>
<div class="admonition example">
<p class="admonition-title">Example: Generate private key for Alice</p>
<p>To generate the private key for the Online? protocol for Alice,
we use the session ID that we just created in step 1.
and the key tag specified in the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">generate_private_pke_key</span> <span class="n">alice</span> <span class="n">alice_private_keys_sid</span> <span class="n">key_tag</span><span class="o">;*</span>
</pre></div>
</div>
<p>After this step, the state of Alice looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>State Alice:
  Session alice_private_keys_sid: {
    &quot;Online.Key&quot; = alice_private_key
  }
  Session alice_public_keys_sid: { }
</pre></div>
</div>
</div>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Generate private key for Bob</p>
<p>Generate a private key for the Online? protocol for Bob.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">generate_private_pke_key</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span> <span class="n">key_tag</span><span class="o">;*</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="retrieving-and-storing-public-keys">
<h5>3. Retrieving and Storing public keys<a class="headerlink" href="#retrieving-and-storing-public-keys" title="Link to this heading"></a></h5>
<p>Now that both participants have a private key,
we want to store the corresponding public keys
at the other participant.</p>
<p>Again, there is a corresponding function in <code class="docutils literal notranslate"><span class="pre">DY.Simplified</span></code>:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">install_public_pke_key</span><span class="o">:</span>
  <span class="o">(</span><span class="n">alice</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">alice_public_keys_sid</span><span class="o">:</span> <span class="n">state_id</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="n">key_tag</span><span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="n">bob</span><span class="o">:</span> <span class="n">principal</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">bob_private_keys_sid</span><span class="o">:</span> <span class="n">state_id</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="kt">unit</span><span class="o">)</span>
</pre></div>
</div>
<p>Let’s slowly go through the arguments of this function:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">alice</span></code> is the participant who wants to store the public key</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alice_public_keys_sid</span></code> is the session ID (of the public keys session),
where Alice wants to store the key</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">key_tag</span></code> is the tag of the key used</p>
<ul>
<li><p>as part of the lookup key in Alice’s public keys session for the new key</p></li>
<li><p>to lookup the private key at Bob</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">bob</span></code> is the participant whose public key should be stored</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bob_private_keys_sid</span></code> is the session ID of the private keys session of Bob,
where he stores his private keys</p></li>
</ul>
<p>A call to the function</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">install_public_pke_key</span> <span class="n">alice</span> <span class="n">alice_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span>
</pre></div>
</div>
<p>should be read as:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">alice</span></code> wants to store in her public keys session (with ID <code class="docutils literal notranslate"><span class="pre">alice_public_keys_sid</span></code>)
under the lookup key pair <code class="docutils literal notranslate"><span class="pre">(key_tag,</span> <span class="pre">bob)</span></code>
the public key related to the private key
that <code class="docutils literal notranslate"><span class="pre">bob</span></code> stores in his private keys session <code class="docutils literal notranslate"><span class="pre">bob_private_keys_sid</span></code>
under the same tag <code class="docutils literal notranslate"><span class="pre">key_tag</span></code>.</p>
</div></blockquote>
<div class="admonition example">
<p class="admonition-title">Example: Storing Bob’s public key at Alice</p>
<p>Assume that after generation of the private keys,
the states of Alice and Bob look like the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>State Alice:
  Session alice_private_keys_sid: {
    &quot;Online.Key&quot; = alice_private_key
  }
  Session alice_public_keys_sid: { }

State Bob:
  Session bob_private_keys_sid: {
      &quot;Online.Key&quot; = bob_private_key
    , &quot;Other.Key&quot; = bob_other_private_key
  }
  Session bob_public_keys_sid: { }
</pre></div>
</div>
<p>Alice has one private key for the Online? protocol,
and Bob has two private keys: one for the Online? protocol
and another one for some other protocol.</p>
<p>If Alice wants to store the public key of Bob for the Online? protocol,
she calls the <code class="docutils literal notranslate"><span class="pre">install_public_pke_key</span></code> function with the following arguments:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">install_public_pke_key</span> <span class="n">alice</span> <span class="n">alice_public_keys_sid</span> <span class="s2">&quot;Online.Key&quot;</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span>
</pre></div>
</div>
<p>After this call, Alice has one entry in her public keys session:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>State Alice:
  Session alice_public_keys_sid: {
    (&quot;Online.Key&quot;, Bob) = public key corresponding to bob_private_key
  }
</pre></div>
</div>
</div>
<p>You may ask yourself at this point,
what the value of the public key actually is and where it comes from.
After all, so far we only generated <em>private</em> keys.
At this point,
it is enough to know that the public key can be computed from the corresponding private key.
We don’t need to care about how exactly that works.
Just remember:
A public key is identified by its corresponding private key.</p>
<div class="toggle-header docutils container">
<p><strong>I want to know how it works.</strong></p>
</div>
<div class="toggle-content box docutils container">
<p>Since we are in the <em>symbolic</em> world,
the public keys are actually just defined by adding
a “public key of” constructor to the private key.
That is,
the public key corresponding to the private key <code class="docutils literal notranslate"><span class="pre">private_key</span></code> is
<code class="code highlight fstar docutils literal highlight-fstar"><span class="nc">Pk</span> <span class="n">private_key</span></code>.</p>
</div>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Storing Alice’s public key at Bob</p>
<p>Store the public key of Alice at Bob.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">install_public_pke_key</span> <span class="n">bob</span> <span class="n">bob_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">alice</span> <span class="n">alice_private_keys_sid</span><span class="o">;*</span>
</pre></div>
</div>
<p>Note that here we use the constant <code class="docutils literal notranslate"><span class="pre">key_tag</span></code> defined in the <code class="docutils literal notranslate"><span class="pre">Data</span></code> module,
in contrast to the explicit string <code class="code highlight fstar docutils literal highlight-fstar"><span class="s2">&quot;Online.Key&quot;</span></code> in the above example for Alice.
Both is correct, but it is usually better to use the constants.</p>
</div>
</div>
</section>
<section id="summary-of-key-storage-setup">
<h5>Summary of Key Storage Setup<a class="headerlink" href="#summary-of-key-storage-setup" title="Link to this heading"></a></h5>
<p>This concludes setup of the key storage
for our example run of the Online? protocol.
Your <code class="docutils literal notranslate"><span class="pre">run</span></code> function should look like the following:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">run</span> <span class="bp">()</span> <span class="o">:</span> <span class="n">traceful</span> <span class="o">(</span><span class="n">option</span> <span class="kt">unit</span> <span class="o">)</span> <span class="o">=</span>
  <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="s2">&quot;************* Trace *************</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="kd">let</span> <span class="n">alice</span> <span class="o">=</span> <span class="s2">&quot;Alice&quot;</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">bob</span> <span class="o">=</span> <span class="s2">&quot;Bob&quot;</span> <span class="k">in</span>

  <span class="c">(*** key storage setup ***)</span>

  <span class="kd">let</span><span class="o">*</span> <span class="n">alice_private_keys_sid</span> <span class="o">=</span> <span class="n">initialize_private_keys</span> <span class="n">alice</span> <span class="k">in</span>
  <span class="kd">let</span><span class="o">*</span> <span class="n">alice_public_keys_sid</span> <span class="o">=</span> <span class="n">initialize_pki</span> <span class="n">alice</span> <span class="k">in</span>

  <span class="kd">let</span><span class="o">*</span> <span class="n">bob_private_keys_sid</span> <span class="o">=</span> <span class="n">initialize_private_keys</span> <span class="n">bob</span> <span class="k">in</span>
  <span class="kd">let</span><span class="o">*</span> <span class="n">bob_public_keys_sid</span> <span class="o">=</span> <span class="n">initialize_pki</span> <span class="n">bob</span> <span class="k">in</span>

  <span class="n">generate_private_pke_key</span> <span class="n">alice</span> <span class="n">alice_private_keys_sid</span> <span class="n">key_tag</span><span class="o">;*</span>
  <span class="n">generate_private_pke_key</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span> <span class="n">key_tag</span><span class="o">;*</span>

  <span class="n">install_public_pke_key</span> <span class="n">alice</span> <span class="n">alice_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span><span class="o">;*</span>
  <span class="n">install_public_pke_key</span> <span class="n">bob</span> <span class="n">bob_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">alice</span> <span class="n">alice_private_keys_sid</span><span class="o">;*</span>

  <span class="kd">let</span><span class="o">*</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">get_trace</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="o">(</span>
      <span class="n">trace_to_string</span> <span class="n">default_trace_to_string_printers</span> <span class="n">tr</span>
    <span class="o">)</span> <span class="k">in</span>

  <span class="n">return</span> <span class="o">(</span><span class="nc">Some</span> <span class="bp">()</span><span class="o">)</span>
</pre></div>
</div>
<p>If you run <code class="docutils literal notranslate"><span class="pre">make</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> now,
you should see the following trace at the end of the output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>************* Trace *************
{&quot;TraceID&quot;: 0, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PrivateKeys&quot;, &quot;Content&quot;: &quot;[]&quot;}
{&quot;TraceID&quot;: 1, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 1, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PKI&quot;, &quot;Content&quot;: &quot;[]&quot;}
{&quot;TraceID&quot;: 2, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PrivateKeys&quot;, &quot;Content&quot;: &quot;[]&quot;}
{&quot;TraceID&quot;: 3, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 1, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PKI&quot;, &quot;Content&quot;: &quot;[]&quot;}
{&quot;TraceID&quot;: 4, &quot;Type&quot;: &quot;Nonce&quot;, &quot;Usage&quot;: {&quot;Type&quot;: &quot;PkeKey&quot;, &quot;Tag&quot;: &quot;Online.Key&quot;, &quot;Data&quot;: &quot;[Alice,]&quot;}}
{&quot;TraceID&quot;: 5, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PrivateKeys&quot;, &quot;Content&quot;: &quot;[Online.Key = (Nonce #4),]&quot;}
{&quot;TraceID&quot;: 6, &quot;Type&quot;: &quot;Nonce&quot;, &quot;Usage&quot;: {&quot;Type&quot;: &quot;PkeKey&quot;, &quot;Tag&quot;: &quot;Online.Key&quot;, &quot;Data&quot;: &quot;[Bob,]&quot;}}
{&quot;TraceID&quot;: 7, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PrivateKeys&quot;, &quot;Content&quot;: &quot;[Online.Key = (Nonce #6),]&quot;}
{&quot;TraceID&quot;: 8, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 1, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PKI&quot;, &quot;Content&quot;: &quot;[(Online.Key, Bob) = (Pk(sk=(Nonce #6))),]&quot;}
{&quot;TraceID&quot;: 9, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 1, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PKI&quot;, &quot;Content&quot;: &quot;[(Online.Key, Alice) = (Pk(sk=(Nonce #4))),]&quot;}
</pre></div>
</div>
<div class="admonition info">
<p class="admonition-title">Hints for reading the trace output</p>
<ul class="simple">
<li><p>Nonces are referred to by their creation time.
As such we see <code class="docutils literal notranslate"><span class="pre">Nonce</span> <span class="pre">#ts</span></code>, where <code class="docutils literal notranslate"><span class="pre">ts</span></code> is the timestamp of creation.</p></li>
<li><p>Dictionaries are represented as lists with entries <code class="docutils literal notranslate"><span class="pre">key</span> <span class="pre">=</span> <span class="pre">value</span></code>.</p></li>
<li><p>Notation for a public key corresponding to a secret key is <code class="docutils literal notranslate"><span class="pre">Pk</span> <span class="pre">(sk</span> <span class="pre">=</span> <span class="pre">the_private_key)</span></code>.</p></li>
</ul>
</div>
<p>Let’s look at the entries one by one:</p>
<ul class="simple">
<li><p><em>Trace entries 0 - 3</em> correspond to initialization of the key sessions for Alice and Bob.
Both get two empty dictionaries in Sessions 0 and 1 for private and public keys respectively.</p></li>
<li><p><em>Entries 4 + 5</em> show the generation (4) and storing (5) of Alice’s private key.</p>
<ul>
<li><p>Entry 4 reads: Created a new nonce that is to be used as private key with the tag “Online.Key” for Alice.</p></li>
<li><p>Entry 5 shows Session 0 of Alice, where the new key (the nonce generated in Step 4) is stored under the tag “Online.Key”</p></li>
</ul>
</li>
<li><p><em>Entries 6 + 7</em> show the generation (6) and storing (7) of Bob’s private key.</p></li>
<li><p><em>Entry 8</em> shows storing of Bob’s public key in Alice’s public key session (Session 1).
The dictionary now contains one entry with the lookup key “Online.Key” and “Bob”
and the value is the public key corresponding to the nonce generated in Step 6, i.e., the private key of Bob.</p></li>
<li><p><em>Entry 9</em> shows storing of Alice’s public key in Bob’s public key session.</p></li>
</ul>
</section>
</section>
<section id="how-to-setup-key-storage">
<h4>How-To: Setup Key Storage<a class="headerlink" href="#how-to-setup-key-storage" title="Link to this heading"></a></h4>
<p>We summarize the key setup for later reference:</p>
<div class="admonition remember">
<p class="admonition-title">How-To: Setup Key Storage</p>
<ol class="arabic">
<li><p>Allocate sessions for the private and public keys:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*</span> <span class="n">alice_private_keys_sid</span> <span class="o">=</span> <span class="n">initialize_private_keys</span> <span class="n">alice</span> <span class="k">in</span>
<span class="kd">let</span><span class="o">*</span> <span class="n">alice_public_keys_sid</span> <span class="o">=</span> <span class="n">initialize_pki</span> <span class="n">alice</span> <span class="k">in</span>
</pre></div>
</div>
</li>
<li><p>Generate and store own <em>private</em> keys:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">generate_private_pke_key</span> <span class="n">alice</span> <span class="n">alice_private_keys_sid</span> <span class="n">key_tag</span><span class="o">;*</span>
</pre></div>
</div>
</li>
<li><p>Retrieve and store <em>public</em> keys from other participants:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="n">install_public_pke_key</span> <span class="n">alice</span> <span class="n">alice_public_keys_sid</span> <span class="n">key_tag</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span><span class="o">;*</span>
</pre></div>
</div>
<p>(Public keys are identified by their corresponding private key.)</p>
</li>
</ol>
</div>
</section>
<section id="the-actual-protocol-run">
<h4>The actual protocol run<a class="headerlink" href="#the-actual-protocol-run" title="Link to this heading"></a></h4>
<p>We now have all things set up to call the protocol steps in the <code class="docutils literal notranslate"><span class="pre">run</span></code> function.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercise: Call the protocol steps</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">run</span></code> function, call the protocol steps corresponding to a run
where Alice sends a Ping to Bob, Bob replies with an Ack, and Alice receives the Ack.</p>
<p>Carefully think about the needed arguments,
in particular the keys session IDs.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="o">*?</span> <span class="o">(</span><span class="n">alice_sid</span><span class="o">,</span> <span class="n">ping_ts</span><span class="o">)</span> <span class="o">=</span> <span class="n">send_ping</span> <span class="n">alice</span> <span class="n">bob</span> <span class="n">alice_public_keys_sid</span> <span class="k">in</span>
<span class="kd">let</span><span class="o">*?</span> <span class="o">(</span><span class="n">bob_sid</span><span class="o">,</span> <span class="n">ack_ts</span><span class="o">)</span> <span class="o">=</span> <span class="n">receive_ping_and_send_ack</span> <span class="n">bob</span> <span class="n">bob_private_keys_sid</span> <span class="n">bob_public_keys_sid</span> <span class="n">ping_ts</span> <span class="k">in</span>
<span class="n">receive_ack</span> <span class="n">alice</span> <span class="n">alice_private_keys_sid</span> <span class="n">ack_ts</span><span class="o">;*?</span>
</pre></div>
</div>
</div>
</div>
<p>Before calling <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>,
we again use a pretty printing function for the protocol messages and states:</p>
<ul class="simple">
<li><p>Download the <code class="docutils literal notranslate"><span class="pre">DY.Online.Run.Printing.fst</span></code> file from the <a class="reference external" href="https://github.com/REPROSEC/dolev-yao-star-tutorial-code/blob/main/examples/Online/DY.Online.Run.Printing.fst">Tutorial Repo on GitHub</a>,</p></li>
<li><p>import the module in your <code class="docutils literal notranslate"><span class="pre">Run</span></code> module and</p></li>
<li><p>change the default printers to <code class="docutils literal notranslate"><span class="pre">get_trace_to_string_printers</span></code></p></li>
</ul>
<p>so that printing is now:</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">IO</span><span class="p">.</span><span class="n">debug_print_string</span> <span class="o">(</span>
    <span class="n">trace_to_string</span> <span class="n">get_trace_to_string_printers</span> <span class="n">tr</span>
 <span class="o">)</span> <span class="k">in</span>
</pre></div>
</div>
<p>If you run <code class="docutils literal notranslate"><span class="pre">make</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> now,
the output should end with the following trace
which is quite long and we will go through it line by line:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>************* Trace *************
{&quot;TraceID&quot;: 0, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PrivateKeys&quot;, &quot;Content&quot;: &quot;[]&quot;}
{&quot;TraceID&quot;: 1, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 1, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PKI&quot;, &quot;Content&quot;: &quot;[]&quot;}
{&quot;TraceID&quot;: 2, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PrivateKeys&quot;, &quot;Content&quot;: &quot;[]&quot;}
{&quot;TraceID&quot;: 3, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 1, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PKI&quot;, &quot;Content&quot;: &quot;[]&quot;}
{&quot;TraceID&quot;: 4, &quot;Type&quot;: &quot;Nonce&quot;, &quot;Usage&quot;: {&quot;Type&quot;: &quot;PkeKey&quot;, &quot;Tag&quot;: &quot;Online.Key&quot;, &quot;Data&quot;: &quot;[Alice,]&quot;}}
{&quot;TraceID&quot;: 5, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PrivateKeys&quot;, &quot;Content&quot;: &quot;[Online.Key = (Nonce #4),]&quot;}
{&quot;TraceID&quot;: 6, &quot;Type&quot;: &quot;Nonce&quot;, &quot;Usage&quot;: {&quot;Type&quot;: &quot;PkeKey&quot;, &quot;Tag&quot;: &quot;Online.Key&quot;, &quot;Data&quot;: &quot;[Bob,]&quot;}}
{&quot;TraceID&quot;: 7, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 0, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PrivateKeys&quot;, &quot;Content&quot;: &quot;[Online.Key = (Nonce #6),]&quot;}
{&quot;TraceID&quot;: 8, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 1, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PKI&quot;, &quot;Content&quot;: &quot;[(Online.Key, Bob) = (Pk(sk=(Nonce #6))),]&quot;}
{&quot;TraceID&quot;: 9, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 1, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;DY.Lib.State.PKI&quot;, &quot;Content&quot;: &quot;[(Online.Key, Alice) = (Pk(sk=(Nonce #4))),]&quot;}
{&quot;TraceID&quot;: 10, &quot;Type&quot;: &quot;Nonce&quot;, &quot;Usage&quot;: {&quot;Type&quot;: &quot;NoUsage&quot;}}
{&quot;TraceID&quot;: 11, &quot;Type&quot;: &quot;Nonce&quot;, &quot;Usage&quot;: {&quot;Type&quot;: &quot;PkeNonce&quot;}}
{&quot;TraceID&quot;: 12, &quot;Type&quot;: &quot;Message&quot;, &quot;Content&quot;: &quot;PkeEnc(pk=(Pk(sk=(Nonce #6))), nonce=(Nonce #11), msg=([Alice, [Nonce #10,]]))&quot;}
{&quot;TraceID&quot;: 13, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 2, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;Online.State&quot;, &quot;Content&quot;: &quot;SentPing [n_a = (Nonce #10), to = (Bob)]&quot;}
{&quot;TraceID&quot;: 14, &quot;Type&quot;: &quot;Nonce&quot;, &quot;Usage&quot;: {&quot;Type&quot;: &quot;PkeNonce&quot;}}
{&quot;TraceID&quot;: 15, &quot;Type&quot;: &quot;Message&quot;, &quot;Content&quot;: &quot;PkeEnc(pk=(Pk(sk=(Nonce #4))), nonce=(Nonce #14), msg=( [Nonce #10,]))&quot;}
{&quot;TraceID&quot;: 16, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 2, &quot;Principal&quot;: &quot;Bob&quot;, &quot;Tag&quot;: &quot;Online.State&quot;, &quot;Content&quot;: &quot;SentAck [n_a = (Nonce #10), to = (Alice)]&quot;}
{&quot;TraceID&quot;: 17, &quot;Type&quot;: &quot;Session&quot;, &quot;SessionID&quot;: 2, &quot;Principal&quot;: &quot;Alice&quot;, &quot;Tag&quot;: &quot;Online.State&quot;, &quot;Content&quot;: &quot;ReceivedAck [n_a = (Nonce #10), from = (Bob)]&quot;}
</pre></div>
</div>
<div class="admonition info">
<p class="admonition-title">Common Mistakes</p>
<p>If you don’t see a trace in your output,
one of the steps fails.
Move around the trace printing part (including <code class="docutils literal notranslate"><span class="pre">get_trace</span></code>) and check which of the steps it is
(the first one, for which you don’t see a trace after <code class="docutils literal notranslate"><span class="pre">make</span></code> + <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>).
Once you found the step, ask yourself:</p>
<ul class="simple">
<li><p>Did you use the right arguments for that step?</p></li>
<li><p>Did you maybe swap private and public keys session IDs?</p></li>
</ul>
</div>
<div class="toggle-header docutils container">
<p><strong>A surprising Non-Mistake</strong></p>
</div>
<div class="toggle-content box docutils container">
<p>The run in the current <code class="docutils literal notranslate"><span class="pre">run</span></code> function
will be successful (i.e., you’ll see the correct trace)
if you swapped Alice’s keys session IDs for Bob’s.
For example, in the call to <code class="docutils literal notranslate"><span class="pre">receive_ack</span></code> you can use
<code class="docutils literal notranslate"><span class="pre">bob_private_keys_sid</span></code> instead of <code class="docutils literal notranslate"><span class="pre">alice_private_keys_sid</span></code>.</p>
<p>Why is that possible?
In the <code class="docutils literal notranslate"><span class="pre">receive_ack</span></code> step, Alice needs to decrypt the Ack
and hence is looking for a key with the “Online.Key” tag in the provided session,
which is now seemingly Bob’s private key session.
So apparently, Alice can decrypt a message encrypted for her using Bob’s private key.
Is there a bug in DY*’s decryption?</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p>Of course there is no bug in DY*’s decryption!</p>
<p>The misleading part in the above argument is
that we don’t provide sessions but session <strong>IDs</strong>.
So Alice does not look for the key in Bob’s private keys session,
instead she looks in her own state at the provided session <strong>ID</strong>.
Since both <code class="docutils literal notranslate"><span class="pre">alice_private_keys_sid</span></code> and <code class="docutils literal notranslate"><span class="pre">bob_private_keys_sid</span></code> are 0 in our run,
she looks for the private key in her own Session 0 in both cases.</p>
<p><em>Lesson learned:</em>
Session IDs are just numbers and a participant can only look at sessions in his own state.
The same session ID may appear in the states of different participants,
but probably with very different content related to it.</p>
</div>
</div>
<p>Let’s now look at the trace entries:</p>
<ul>
<li><p><em>Entries 0-9</em> show the key storage setup that we previously saw.</p></li>
<li><p><em>Entry 10 - 13</em> come from the first step of the protocol, where Alice generates a nonce <span class="math notranslate nohighlight">\(n_A\)</span>
and sends this nonce together with her name to Bob.</p>
<ul>
<li><p><em>Entry 10</em> shows the generation of the nonce <span class="math notranslate nohighlight">\(n_A\)</span>
<span class="todo-inline">TODO: what to say about the usage/type? Ideally, I want to avoid talking about this. But it is needed for private key generation (and maybe PkeNonces)</span></p></li>
<li><p>Let’s now first look at <em>Entry 12</em>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{&quot;TraceID&quot;: 12, &quot;Type&quot;: &quot;Message&quot;, &quot;Content&quot;: &quot;PkeEnc(pk=(Pk(sk=(Nonce #6))), nonce=(Nonce #11), msg=([Alice, [Nonce #10,]]))&quot;}
</pre></div>
</div>
<p>This is the encrypted message from Alice to Bob.</p>
<ul class="simple">
<li><p>At the very end we see the plaintext <code class="docutils literal notranslate"><span class="pre">msg=([Alice,</span> <span class="pre">[Nonce</span> <span class="pre">#10,]])</span></code>
which is the message containing Alice’s name and the nonce <span class="math notranslate nohighlight">\(n_A\)</span> she generated at time 10.</p></li>
<li><p>In the beginning of the message content we see <code class="docutils literal notranslate"><span class="pre">PkeEnc</span></code> which means that the plaintext is encrypted.</p></li>
<li><p>The public encryption key that is used for this message,
is given as we have seen previously: <code class="docutils literal notranslate"><span class="pre">pk=(Pk(sk=(Nonce</span> <span class="pre">#6)))</span></code>.
It is the public key corresponding to the private key that was generated at time 6.
If we look at the entry at time 6, we see that this is (as expected) the private key of Bob.</p></li>
<li><p>We are left with the middle part <code class="docutils literal notranslate"><span class="pre">nonce=(Nonce</span> <span class="pre">#11)</span></code>.
<span class="todo-inline">TODO: ideally i don’t want to talk about this nonce (and hence entry 11) at all</span></p></li>
</ul>
</li>
<li><p><em>Entry 13</em> shows that Alice creates a new session with ID 2 for the protocol status,
where she stores that she sent the Ping <span class="math notranslate nohighlight">\(n_A\)</span> (<code class="docutils literal notranslate"><span class="pre">Nonce</span> <span class="pre">#10</span></code>) to Bob.</p></li>
</ul>
</li>
<li><p><em>Entries 14 - 16</em> come from the second protocol step,
where Bob receives the Ping, and replies with an Ack.</p>
<ul>
<li><p><em>Entry 15</em> shows the encrypted Ack</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{&quot;TraceID&quot;: 15, &quot;Type&quot;: &quot;Message&quot;, &quot;Content&quot;: &quot;PkeEnc(pk=(Pk(sk=(Nonce #4))), nonce=(Nonce #14), msg=( [Nonce #10,]))&quot;}
</pre></div>
</div>
<p>with</p>
<ul class="simple">
<li><p>the plaintext <code class="docutils literal notranslate"><span class="pre">msg=(</span> <span class="pre">[Nonce</span> <span class="pre">#10,])</span></code> being the nonce generated at time 10
(the nonce <span class="math notranslate nohighlight">\(n_A\)</span>, Alice generated and sent to Bob in the Ping)</p></li>
<li><p>the encryption key <code class="docutils literal notranslate"><span class="pre">pk=(Pk(sk=(Nonce</span> <span class="pre">#4)))</span></code> being the public key related to the private key generated at time 4
(which is, as expected, the private key of Alice)</p></li>
<li><p>the encryption nonce <code class="docutils literal notranslate"><span class="pre">nonce=(Nonce</span> <span class="pre">#14)</span></code> generated in the previous step (time 14)</p></li>
</ul>
</li>
<li><p><em>Entry 16</em> shows the new session that Bob creates in the step,
where he stores
that he sent the Ack <span class="math notranslate nohighlight">\(n_A\)</span> (<code class="docutils literal notranslate"><span class="pre">Nonce</span> <span class="pre">#10</span></code>) to Alice.</p></li>
</ul>
</li>
<li><p><em>Entry 17</em> shows the updated Session 2 of Alice, where she now stores
that she received the Ack with <span class="math notranslate nohighlight">\(n_A\)</span> (<code class="docutils literal notranslate"><span class="pre">Nonce</span> <span class="pre">#10</span></code>) from Bob.</p></li>
</ul>
<p>So we see that our model of the Online? protocol
seems to be correct.
We can successfully model an example run,
where everything works as expected.
This concludes our model of the Online? protocol.</p>
</section>
</section>
</section>
<section id="a-first-implementation-of-nsl">
<h2>A First Implementation of NSL<a class="headerlink" href="#a-first-implementation-of-nsl" title="Link to this heading"></a></h2>
<p>Looking back at the model of the Online? protocol,
you should now be able to implement a first model of the <a class="reference internal" href="introduction.html#sec-intro-nsl"><span class="std std-ref">NSL protocol</span></a>.</p>
<div class="toggle-header docutils container">
<p><strong>Show/Hide Answer</strong></p>
</div>
<div class="toggle-content docutils container">
<p><a class="reference external" href="https://github.com/REPROSEC/dolev-yao-star-tutorial-code/tree/main/examples/NSL">https://github.com/REPROSEC/dolev-yao-star-tutorial-code/tree/main/examples/NSL</a></p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="introduction.html" class="btn btn-neutral float-left" title="Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="stating-sec-props.html" class="btn btn-neutral float-right" title="Stating Security Properties" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, DY* Maintainer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>